
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Ninja Chat (Pro) - Ultimate</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:ital,wght@1,900&family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- QR Code Generator Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #000000; /* Main Black */
            --accent: #d32f2f; /* DEFAULT RED - Changeable for VIPs */
            --gold: #FFD700;
            --gold-glow: #ffdb1a;
            --silver: #C0C0C0;
            --platinum: #E5E4E2;
            --bg-light: #f5f7fb;
            --white: #ffffff;
            --nav-height: 70px; /* Increased Height for better nav with text */
            --green: #00e676;
            --gray: #999999;
            
            /* LINK MSG BUBBLE TO ACCENT COLOR */
            --msg-me: var(--accent); 
            
            --msg-other: #ffffff;
            --blue-tick: #34B7F1;
            --link-blue: #0095f6;
            --input-bg: #efefef;
            --photo-icon-color: #54656f;
            --skeleton-base: #e0e0e0;
            --skeleton-highlight: #f5f5f5;
            --whatsapp-green: #00a884;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; -webkit-user-select: none; }
        
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background: #111; height: 100%; position: fixed; width: 100%; overflow: hidden; color: #222; }
        
        /* FONTS */
        .ninja-font { font-family: 'Orbitron', sans-serif; font-weight: 900; font-style: italic; text-transform: uppercase; letter-spacing: 1px; }
        .text-red { color: var(--accent); transition: color 0.3s ease; }

        /* VIP GOLD STYLE */
        .vip-gold-icon { color: var(--gold) !important; text-shadow: 0 0 5px rgba(255, 215, 0, 0.4); }
        .vip-tick-overlay { position: absolute; bottom: 0; right: 0; background: var(--gold); color: black; font-size: 10px; border-radius: 50%; width: 18px; height: 18px; display: flex; justify-content: center; align-items: center; border: 2px solid white; z-index: 5; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* CUSTOM AVATAR IMAGE STYLE */
        .custom-user-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; display: block; }

        /* --- SPLASH SCREEN --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease-out;
        }
        .splash-logo { font-size: 80px; color: var(--accent); margin-bottom: 20px; animation: pulseLogo 2s infinite; text-shadow: 0 0 20px rgba(211, 47, 47, 0.6); }
        .splash-title { font-size: 32px; color: white; margin-bottom: 40px; }
        .splash-bar-container { width: 200px; height: 6px; background: #333; border-radius: 10px; overflow: hidden; position: relative; }
        .splash-bar-fill { height: 100%; width: 0%; background: var(--accent); border-radius: 10px; animation: fillBar 2.5s ease-in-out forwards; box-shadow: 0 0 10px var(--accent); }
        .splash-text { margin-top: 15px; color: #666; font-size: 12px; font-family: 'Orbitron'; letter-spacing: 2px; }

        .splash-footer {
            position: absolute; bottom: 30px; left: 0; width: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #888;
        }
        .secure-badge {
            display: flex; align-items: center; gap: 8px;
            font-family: 'Orbitron', sans-serif; font-weight: 700;
            color: #4CAF50;
            letter-spacing: 1px; font-size: 14px;
        }
        .secure-badge i { font-size: 18px; }

        @keyframes pulseLogo { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes fillBar { 0% { width: 0%; } 100% { width: 100%; } }

        /* --- NAVIGATION UPDATES (WITH TEXT LABELS) --- */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height); background: white; display: none; justify-content: space-around; align-items: center; z-index: 200; box-shadow: 0 -2px 20px rgba(0,0,0,0.05); padding-bottom: env(safe-area-inset-bottom); }
        .bottom-nav.visible { display: flex; }
        
        .nav-item { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            color: #ccc; text-decoration: none; cursor: pointer; padding: 5px; width: 20%; 
            transition: color 0.3s; 
        }
        
        /* New Text Styling for Nav */
        .nav-item span { 
            display: block; 
            font-size: 9px; 
            font-weight: 800; 
            font-family: 'Orbitron', sans-serif; 
            margin-top: 4px; 
            letter-spacing: 0.5px;
        }
        
        .nav-item i { font-size: 20px; margin-bottom: 0; transition: transform 0.2s; }
        .nav-item.active-nav { color: var(--accent); }
        .nav-item.active-nav i { transform: scale(1.1); }

        /* Profile Icon in Nav - Bigger & Circular (No Text) */
        .nav-profile-container {
            width: 32px; height: 32px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid transparent; /* Default */
            display: flex; justify-content: center; align-items: center;
            transition: all 0.2s;
        }
        .nav-item.active-nav .nav-profile-container {
            border-color: var(--accent); /* Active Ring */
            padding: 1px; /* Space between image and ring */
        }
        .nav-profile-img {
            width: 100%; height: 100%;
            border-radius: 50%;
            object-fit: cover;
            background: #eee;
        }
        /* Fallback icon if no image */
        .nav-profile-icon-fallback { font-size: 26px !important; }

        /* --- ACCOUNT SWITCHER SHEET (MODERN) --- */
        #account-switcher-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2100; display: none;
            backdrop-filter: blur(3px);
        }
        #account-switcher-sheet {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; 
            border-radius: 24px 24px 0 0;
            z-index: 2101;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            display: flex; flex-direction: column;
            max-height: 80vh;
        }
        #account-switcher-sheet.open { transform: translateY(0); }
        
        .as-drag-handle {
            width: 40px; height: 5px; background: #e0e0e0;
            border-radius: 10px; margin: 12px auto;
        }
        .as-header {
            text-align: center; font-weight: 800; font-family: 'Orbitron';
            padding-bottom: 15px; border-bottom: 1px solid #f5f5f5;
            color: #333; letter-spacing: 1px;
        }
        .as-list { padding: 10px 0; overflow-y: auto; }
        
        .as-item {
            display: flex; align-items: center; padding: 15px 20px;
            cursor: pointer; transition: background 0.2s;
        }
        .as-item:active { background: #f9f9f9; }
        .as-avatar {
            width: 50px; height: 50px; border-radius: 50%;
            margin-right: 15px; object-fit: cover;
            border: 1px solid #eee; display: flex; justify-content: center; align-items: center;
            font-size: 20px; color: #555; background: #f5f5f5;
        }
        .as-info { flex: 1; }
        .as-name { font-weight: 700; font-size: 15px; color: #222; }
        .as-handle { font-size: 12px; color: #888; font-weight: 500; }
        
        .as-radio {
            width: 22px; height: 22px; border-radius: 50%;
            border: 2px solid #ccc; display: flex; justify-content: center; align-items: center;
        }
        .as-item.active .as-radio {
            border-color: var(--blue-tick); background: var(--blue-tick);
        }
        .as-item.active .as-radio::after {
            content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900;
            color: white; font-size: 12px;
        }

        .as-action-btn {
            display: flex; align-items: center; padding: 15px 20px;
            cursor: pointer; color: var(--link-blue); font-weight: 600;
            font-size: 14px;
        }
        .as-action-btn:active { background: #f0f8ff; }
        .as-action-btn i { width: 50px; text-align: center; font-size: 20px; margin-right: 15px; }

        /* --- SKELETON LOADER ANIMATIONS --- */
        .skeleton {
            background-color: var(--skeleton-base);
            background-image: linear-gradient(90deg, var(--skeleton-base), var(--skeleton-highlight), var(--skeleton-base));
            background-size: 200px 100%;
            background-repeat: no-repeat;
            border-radius: 4px;
            display: inline-block;
            animation: shimmer 1.5s infinite linear;
        }
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }
        
        .sk-list-item { display: flex; align-items: center; padding: 15px 20px; border-bottom: 1px solid #f9f9f9; }
        .sk-avatar { width: 48px; height: 48px; border-radius: 50%; margin-right: 15px; flex-shrink: 0; }
        .sk-info { flex: 1; display: flex; flex-direction: column; gap: 6px; }
        .sk-line-1 { width: 60%; height: 14px; }
        .sk-line-2 { width: 40%; height: 10px; }

        .chat-skeleton-container { padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .sk-msg { height: 35px; width: 45%; border-radius: 12px; flex-shrink: 0; position: relative; }
        .sk-msg.left { align-self: flex-start; border-bottom-left-radius: 0; background-color: var(--skeleton-base); }
        .sk-msg.right { align-self: flex-end; border-bottom-right-radius: 0; background-color: #e8e8e8; }

        /* --- POCKET SKELETON ITEM --- */
        .pocket-skeleton-item {
            aspect-ratio: 1 / 1;
            background-color: var(--skeleton-base);
            background-image: linear-gradient(90deg, var(--skeleton-base), var(--skeleton-highlight), var(--skeleton-base));
            background-size: 200px 100%;
            animation: shimmer 1.5s infinite linear;
            border-radius: 2px;
        }

        /* --- LAYOUT --- */
        .screen { 
            display: none; 
            flex-direction: column; 
            width: 100%; 
            height: 100%; 
            position: absolute; 
            top: 0; left: 0; 
            background: white; 
            overflow: hidden;
            padding-bottom: var(--nav-height); 
        }
        
        .active { display: flex; z-index: 10; }
        
        .anim-tap { animation: fadeZoom 0.3s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        @keyframes fadeZoom { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        .anim-slide-left { animation: slideLeft 0.3s ease-out forwards; }
        @keyframes slideLeft { 0% { transform: translateX(100%); } 100% { transform: translateX(0); } }
        .anim-slide-right { animation: slideRight 0.3s ease-out forwards; }
        @keyframes slideRight { 0% { transform: translateX(-100%); } 100% { transform: translateX(0); } }
        .anim-slide-up { animation: slideUpFull 0.3s ease-out forwards; }
        @keyframes slideUpFull { 0% { transform: translateY(100%); } 100% { transform: translateY(0); } }

        .anim-zoom-enter { animation: zoomEnter 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; transform-origin: center center; }
        .anim-zoom-exit { animation: zoomExit 0.3s ease-in forwards; transform-origin: center center; }

        @keyframes zoomEnter { 0% { transform: scale(0.5); opacity: 0; border-radius: 100%; } 100% { transform: scale(1); opacity: 1; border-radius: 0; } }
        @keyframes zoomExit { 0% { transform: scale(1); opacity: 1; border-radius: 0; } 100% { transform: scale(0.5); opacity: 0; border-radius: 100%; } }

        .scroll-content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 20px; }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--accent); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 20px auto; }
        .btn-loader { border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; width: 16px; height: 16px; animation: spin 0.8s linear infinite; display: inline-block; margin-right: 8px; vertical-align: middle; }
        .btn-loader-red { border: 2px solid rgba(211, 47, 47, 0.3); border-top: 2px solid var(--accent); border-radius: 50%; width: 16px; height: 16px; animation: spin 0.8s linear infinite; display: inline-block; margin-right: 8px; vertical-align: middle; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #toast-box { 
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); 
            background: #1a1a1a; color: white; padding: 14px 28px; 
            border-radius: 50px; font-size: 14px; font-weight: 600; 
            opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            pointer-events: none; z-index: 500; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid #333;
            display: flex; align-items: center; gap: 10px;
        }
        #toast-box.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        #toast-box::before { content: '\f05a'; font-family: "Font Awesome 6 Free"; font-weight: 900; color: var(--accent); }

        #custom-modal-overlay, #report-modal-overlay, #custom-name-modal-overlay, #vip-subscription-overlay, #delete-modal-overlay, #contact-options-modal, #group-options-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 999; display: none;
            justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        
        #custom-modal-overlay, #delete-modal-overlay {
            z-index: 2000;
        }

        .custom-modal {
            background: white; width: 85%; max-width: 320px;
            border-radius: 20px; padding: 0;
            text-align: center; overflow: hidden;
            box-shadow: 0 25px 50px rgba(0,0,0,0.4);
            animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
        }
        .custom-modal::before { content:''; position: absolute; top:0; left:0; width:100%; height: 6px; background: var(--accent); }
        @keyframes modalPop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .modal-body { padding: 30px 25px 25px; }
        .modal-icon { font-size: 45px; color: var(--accent); margin-bottom: 15px; text-shadow: 0 5px 15px rgba(211, 47, 47, 0.2); }
        .modal-title { font-size: 18px; font-weight: 800; margin-bottom: 8px; color: #111; font-family: 'Orbitron'; }
        .modal-text { font-size: 14px; color: #666; margin-bottom: 25px; font-weight: 500; line-height: 1.5; }
        
        .modal-actions { display: flex; border-top: 1px solid #eee; }
        .modal-btn { flex: 1; padding: 15px; border: none; background: white; font-weight: 700; cursor: pointer; font-size: 14px; transition: background 0.2s; }
        .modal-btn.cancel { color: #888; border-right: 1px solid #eee; }
        .modal-btn.cancel:active { background: #f9f9f9; }
        .modal-btn.confirm { color: var(--accent); }
        .modal-btn.confirm:active { background: #fff0f0; }

        .delete-option-btn {
            display: block; width: 100%; padding: 12px; margin-bottom: 10px;
            background: #fff5f5; border: 1px solid #ffcdd2; border-radius: 10px;
            font-weight: 700; cursor: pointer; text-align: left;
            transition: all 0.2s; color: #d32f2f;
        }
        .delete-option-btn:active { background: #d32f2f; color: white; }

        .report-opt-btn {
            display: block; width: 100%; padding: 12px; margin-bottom: 10px;
            background: #f5f5f5; border: 1px solid #ddd; border-radius: 10px;
            font-weight: 700; cursor: pointer; text-align: left;
            transition: all 0.2s;
        }
        .report-opt-btn:hover { background: #ffebee; border-color: var(--accent); color: var(--accent); }
        
        .custom-name-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; outline: none; margin-bottom: 15px; font-weight: bold; }
        .custom-name-input:focus { border-color: var(--accent); }

        #dp-crop-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff;
            z-index: 1000;
            display: none; flex-direction: column;
            animation: slideUp 0.3s ease-out;
        }
        
        .crop-header {
            padding: 15px 20px; display: flex; align-items: center; justify-content: space-between;
            color: #111;
            font-weight: bold; z-index: 2;
            background: white;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
        }
        .crop-header-title { font-size: 18px; font-family: 'Orbitron'; }
        
        .crop-viewport {
            flex: 1; position: relative; width: 100%; 
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; background: #f5f5f5;
        }
        
        .crop-image-container {
            position: relative;
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            cursor: move;
        }
        
        #crop-target-img {
            max-width: 100%; max-height: 100%;
            transition: transform 0.05s linear;
            object-fit: contain;
            pointer-events: none;
        }
        
        .crop-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 140px, rgba(255,255,255,0.85) 141px);
            pointer-events: none; z-index: 2;
            display: flex; justify-content: center; align-items: center;
        }
        .crop-circle-border {
            width: 280px; height: 280px;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 50%;
            box-shadow: 0 0 0 9999px rgba(255,255,255,0.7);
        }

        .crop-controls {
            padding: 20px 30px; background: #ffffff; color: #333;
            display: flex; flex-direction: column; gap: 20px; z-index: 3;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            border-top: 1px solid #f0f0f0;
        }
        
        .zoom-slider-container { display: flex; align-items: center; gap: 15px; color: #555; font-size: 12px; }
        .zoom-slider { 
            flex: 1; -webkit-appearance: none; height: 4px; background: #ddd; border-radius: 2px; outline: none; 
        }
        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 18px;
            background: var(--accent); border-radius: 50%; cursor: pointer;
            border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .crop-actions-bar {
            display: flex; justify-content: space-between; align-items: center;
        }
        .crop-btn {
            padding: 10px 20px; font-weight: 700; font-size: 14px;
            background: transparent; border: none; cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .crop-btn.cancel { color: #555; }
        .crop-btn.save { color: var(--accent); font-family: 'Orbitron'; display: flex; align-items: center; }

        #view-profile-screen { background: white; z-index: 400; }
        .vp-container { display: flex; flex-direction: column; align-items: center; padding-top: 20px; } /* Updated Padding */
        
        /* NEW PROFILE LAYOUT STYLES */
        .vp-header-modern {
            width: 100%; display: flex; align-items: center; padding: 20px;
            margin-bottom: 10px;
        }
        .vp-avatar-modern {
            width: 90px; height: 90px; border-radius: 50%;
            background: #f5f5f5; margin-right: 20px;
            display: flex; justify-content: center; align-items: center;
            font-size: 40px; color: #555; border: 3px solid var(--accent);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow: hidden;
        }
        .vp-info-modern { flex: 1; }
        .vp-name-modern { font-size: 22px; font-weight: 900; color: #222; font-family: 'Orbitron'; line-height: 1.2; }
        .vp-status-modern { font-size: 13px; color: #888; font-weight: 600; margin-top: 4px; }
        
        .vp-bio-modern {
            width: 90%; padding: 15px; margin: 0 auto 30px;
            background: #f9f9f9; border-radius: 12px;
            font-size: 14px; color: #444; font-style: italic; line-height: 1.5;
            border-left: 4px solid var(--accent);
        }
        
        .vp-big-btn {
            width: 90%; padding: 16px; border-radius: 14px;
            border: none; font-size: 16px; font-weight: 900;
            font-family: 'Orbitron'; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            transition: transform 0.2s;
        }
        .vp-big-btn:active { transform: scale(0.98); }
        .btn-chat-action { background: var(--accent); color: white; }
        .btn-add-action { background: black; color: white; }

        /* CONTACT & GROUP OPTIONS MODAL */
        .options-content { background: white; width: 85%; max-width: 300px; border-radius: 20px; padding: 0; box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: slideUp 0.3s; overflow: hidden; }
        .options-header { padding: 20px; text-align: center; border-bottom: 1px solid #f0f0f0; font-weight: 800; color: #222; font-family: 'Orbitron'; background: #fafafa; font-size: 16px; }
        .opt-btn { display: flex; align-items: center; gap: 15px; width: 100%; padding: 16px 20px; border: none; background: white; font-size: 15px; font-weight: 600; cursor: pointer; color: #333; border-bottom: 1px solid #f9f9f9; transition: background 0.2s; text-align: left; }
        .opt-btn:active { background: #f5f5f5; }
        .opt-btn i { width: 24px; text-align: center; color: #666; }
        .opt-btn.danger { color: var(--accent); }
        .opt-btn.danger i { color: var(--accent); }
        .opt-btn.vip { color: #bf9b30; }
        .opt-btn.vip i { color: var(--gold); }
        
        #auth-screen { justify-content: center; padding: 40px; text-align: center; z-index: 50; padding-bottom: 0; background: white; }
        .auth-logo { font-size: 80px; color: var(--accent); margin-bottom: 15px; }
        .app-title { font-size: 42px; margin-bottom: 40px; color: var(--primary); }
        .auth-input { width: 100%; padding: 15px; margin-bottom: 15px; border: none; background: var(--bg-light); border-radius: 12px; font-size: 16px; font-weight: 700; outline: none; }
        
        .btn-primary { 
            width: 100%; padding: 15px; border: none; border-radius: 12px; 
            background: #000; color: white;
            font-size: 16px; font-family: 'Orbitron', sans-serif; font-weight: 900; 
            font-style: italic; cursor: pointer; margin-top: 10px; 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .btn-primary:active { transform: scale(0.98); }
        .btn-primary.pending { background: #555; cursor: default; }
        .toggle-text { margin-top: 25px; color: #666; font-size: 14px; font-weight: 700; }
        .toggle-text b { color: var(--accent); cursor: pointer; }
        
        /* GOOGLE BUTTON STYLES */
        .auth-separator { display: flex; align-items: center; justify-content: center; margin: 20px 0; color: #888; font-size: 12px; font-weight: bold; width: 100%; }
        .auth-separator::before, .auth-separator::after { content: ''; flex: 1; height: 1px; background: #ddd; margin: 0 10px; }
        
        .btn-google {
            width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 12px;
            background: white; color: #333; font-size: 16px; font-weight: 700;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: background 0.2s;
            font-family: 'Roboto', sans-serif; margin-bottom: 10px;
        }
        .btn-google:active { background: #f1f1f1; transform: scale(0.98); }
        .btn-google i { color: #DB4437; font-size: 18px; }

        #username-error { color: var(--accent); font-size: 12px; font-weight: bold; margin-bottom: 10px; display:none; }

        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: white; box-shadow: 0 1px 10px rgba(0,0,0,0.03); z-index: 5; }
        .brand { display: flex; align-items: center; gap: 10px; }
        .brand i { font-size: 32px; color: var(--accent); }
        .brand h1 { font-size: 26px; margin: 0; color: var(--primary); }
        
        .notification-icon-wrapper { position: relative; cursor: pointer; padding: 10px; }
        .notif-badge { position: absolute; top: 5px; right: 5px; width: 10px; height: 10px; background: var(--accent); border-radius: 50%; border: 2px solid white; display: none; }
        .notif-badge.active { display: block; animation: pulse 1.5s infinite; }

        .search-area { padding: 15px 20px 15px 20px; background: white; }
        .search-box { position: relative; background: var(--bg-light); border-radius: 10px; display: flex; align-items: center; }
        .search-box i { position: absolute; left: 15px; color: #888; }
        .search-box input { width: 100%; padding: 12px 40px 12px 45px; border: none; background: transparent; font-size: 15px; font-weight: 700; outline: none; }
        .scan-icon { position: absolute; right: 15px; color: #333; font-size: 18px; cursor: pointer; z-index: 2; }

        .section-label { padding: 15px 20px 5px; font-size: 12px; font-family: 'Orbitron', sans-serif; font-weight: 900; font-style: italic; color: #888; background: white; }
        
        .list-item { display: flex; align-items: center; padding: 15px 20px; transition: background 0.2s; cursor: pointer; position: relative; }
        .list-item:active { background: #f0f0f0; }
        .scale-active { transform: scale(0.95); transition: transform 0.2s; }

        .req-card { 
            display: flex; flex-direction: column; 
            padding: 20px; margin: 15px 20px; 
            background: white; border-radius: 16px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.06); 
            border: 1px solid #f0f0f0; 
            cursor: pointer;
            transition: transform 0.1s;
        }
        .req-card:active { transform: scale(0.98); background: #fafafa; }
        
        .req-header { display: flex; align-items: center; margin-bottom: 20px; }
        .req-info { flex: 1; display:flex; flex-direction:column; justify-content:center; }
        .req-name { font-size: 16px; font-weight: 900; color: #111; margin-bottom: 2px; }
        .req-uid { font-size: 12px; font-family: 'Roboto Mono', monospace; color: var(--accent); font-weight: bold; background: rgba(211, 47, 47, 0.08); padding: 2px 6px; border-radius: 4px; display: inline-block; width: fit-content; }
        
        .req-actions { display: flex; gap: 15px; width: 100%; }
        
        .action-btn-dark { 
            flex: 1; padding: 14px; border: none; border-radius: 12px; 
            font-weight: 900; font-family: 'Orbitron'; cursor: pointer; font-size: 12px; 
            display: flex; align-items: center; justify-content: center; gap: 8px; 
            transition: transform 0.2s; text-transform: uppercase; letter-spacing: 1px;
        }
        .action-btn-dark:active { transform: scale(0.95); }
        
        .btn-dark-accept { background: #000; color: #00e676; border: 1px solid #00e676; box-shadow: 0 0 10px rgba(0, 230, 118, 0.15); }
        .btn-dark-reject { background: #000; color: #ff1744; border: 1px solid #ff1744; box-shadow: 0 0 10px rgba(255, 23, 68, 0.15); }
        
        .avatar-container { position: relative; margin-right: 15px; cursor: pointer; z-index: 2; }
        .avatar { width: 48px; height: 48px; background: var(--bg-light); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 20px; color: #555; border: 1px solid #eee; overflow: hidden; }
        
        .vip-badge { position: absolute; top: -5px; right: -5px; background: var(--gold); color: black; font-size: 9px; padding: 2px 5px; border-radius: 4px; font-weight: 900; font-style: italic; border: 1px solid white; z-index: 5; }
        .status-dot { position: absolute; bottom: 2px; right: 2px; width: 13px; height: 13px; border-radius: 50%; border: 2px solid white; background-color: var(--gray); transition: background 0.3s; }
        .status-dot.online { background-color: var(--green); box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2); }
        
        .chat-info { flex: 1; overflow: hidden; margin-right: 10px; }
        .chat-info h3 { margin: 0 0 4px 0; font-size: 16px; font-weight: 700; color: #000; }
        .chat-info p { margin: 0; font-size: 13px; font-weight: 500; color: #777; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .last-active-txt { font-size: 11px; color: #999; margin-left: 5px; font-weight: 500; }
        
        .unread-bold { font-weight: 900 !important; color: #000 !important; }

        .add-btn { padding: 6px 15px; background: var(--accent); color: white; border: none; border-radius: 20px; font-size: 11px; font-family:'Orbitron'; font-style:italic; font-weight: 900; cursor: pointer; }
        .add-btn.requested { background: #888; cursor: default; }

        /* UNIQUE SQUARE FAB BTN */
        .fab-btn {
            position: fixed; bottom: 80px; right: 20px;
            width: 56px; height: 56px;
            background: linear-gradient(135deg, var(--accent) 0%, #b71c1c 100%); /* Gradient Red */
            color: white;
            border-radius: 16px; /* SQUIRCLE / SQUARE ROUNDED */
            display: flex; align-items: center; justify-content: center;
            font-size: 26px;
            box-shadow: 0 10px 25px rgba(211, 47, 47, 0.4);
            cursor: pointer; z-index: 45; border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .fab-btn:active { 
            transform: scale(0.9) rotate(90deg); 
            border-radius: 50%; /* Morph to circle on click for effect */
        }
        
        #chat-screen { z-index: 210; background: white; padding-bottom: 0; }
        .chat-navbar { display: flex; align-items: center; padding: 10px 10px; background: white; justify-content: space-between; border-bottom: 1px solid #f0f0f0; box-shadow: 0 1px 5px rgba(0,0,0,0.02); position: sticky; top: 0; z-index: 100; height: 60px; } 
        .chat-navbar.gold-header { background: linear-gradient(to right, #FFD700, #FDB931); border-bottom: 1px solid #e6b800; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3); }
        .back-icon { font-size: 20px; padding: 10px 15px 10px 5px; margin-right: 0px; cursor: pointer; color: #333; z-index: 101; display: flex; align-items: center; height: 100%; }
        
        .room-info-container { display: flex; flex-direction: column; justify-content: center; }
        .room-title { font-size: 17px; font-weight: 800; font-style: italic; font-family: 'Orbitron'; color: #222; line-height: 1.2; }
        .room-status { font-size: 11px; font-weight: 500; color: #888; line-height: 1.1; margin-top: 1px; transition: color 0.3s; }
        
        .chat-header-avatar {
            width: 38px; height: 38px;
            border-radius: 50%;
            background: #f0f0f0;
            display: flex; justify-content: center; align-items: center;
            margin-right: 10px;
            color: #555;
            font-size: 18px;
            border: 1px solid #eee;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .chat-header-avatar:active {
            transform: scale(0.9);
        }

        .chat-header-actions { display: flex; gap: 12px; margin-left: auto; padding-right: 5px; align-items: center; }
        
        .modern-header-btn {
            width: 38px; height: 38px;
            border-radius: 50%;
            background: transparent;
            display: flex; justify-content: center; align-items: center;
            color: #54656f;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: none;
        }
        .modern-header-btn:active { transform: scale(0.9); background: #e0e0e0; }
        .modern-header-btn i { font-size: 18px; }

        #chat-selection-bar {
            display: none;
            align-items: center;
            justify-content: space-between;
            position: absolute;
            top: 10px;
            left: 2%;
            width: 96%;
            height: 60px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: #333;
            border-radius: 16px;
            z-index: 200;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            padding: 0 15px;
            border: 1px solid rgba(255,255,255,0.9);
            animation: slideDownFade 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes slideDownFade { 0% { transform: translateY(-20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }

        .selection-left { display: flex; align-items: center; gap: 15px; }
        .selection-back { font-size: 18px; cursor: pointer; padding: 8px; color: #333; }
        .selection-count { font-size: 20px; font-weight: 700; font-family: 'Roboto', sans-serif; margin-left: 5px; color: #000; }
        
        .selection-actions { display: flex; gap: 12px; align-items: center; }
        
        .sel-btn-wrapper {
            width: 40px; height: 40px;
            border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .sel-btn-wrapper:active { transform: scale(0.9); background: rgba(0,0,0,0.1); }
        .sel-btn-wrapper i { font-size: 18px; color: #333; }

        #selection-delete-btn i { color: #ff5252; } 
        
        .sel-menu-dropdown {
            position: absolute; top: 65px; right: 10px;
            background: white; border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            padding: 5px 0; display: none; z-index: 205;
            min-width: 150px;
        }
        .sel-menu-item { padding: 12px 20px; font-size: 14px; font-weight: 600; color: #333; cursor: pointer; }
        .sel-menu-item:active { background: #f5f5f5; }

        #chat-messages { flex: 1; overflow-y: auto; padding: 20px 0; display: flex; flex-direction: column; gap: 1px; background: white; scroll-behavior: auto; overflow-x: hidden; background-size: cover; background-position: center; background-repeat: no-repeat; }
        #chat-messages.admin-bg { background-color: #fffbea; background-image: radial-gradient(#d4af37 1px, transparent 1px); background-size: 25px 25px; }
        
        .date-separator {
            text-align: center;
            font-size: 11px;
            color: #888;
            margin: 15px 0 10px 0;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            letter-spacing: 1px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
        }
        .date-separator::before, .date-separator::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e0e0e0;
            margin: 0 15px;
        }

        /* --- UPDATED: Allow Reactions to overflow --- */
        .msg-container { 
            position: relative; width: 100%; display: flex; flex-direction: column; touch-action: pan-y; margin-bottom: 1px; padding: 1px 15px; transition: background 0.2s;
            overflow: visible !important; /* ALLOW REACTIONS TO SHOW */
        }
        
        @keyframes slideUpBounce {
            0% { transform: translateY(20px); opacity: 0; }
            50% { transform: translateY(-5px); opacity: 1; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .msg-container.anim-bounce-up {
            animation: slideUpBounce 0.4s ease-out forwards;
        }
        
        .swipe-reply-icon {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            color: var(--accent);
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1;
        }
        .swipe-reply-icon.left { left: 10px; }
        .swipe-reply-icon.right { right: 10px; }

        .msg-content-wrapper { 
            display: flex; 
            flex-direction: column; 
            max-width: 75%;
            transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); 
            position: relative; 
            z-index: 2; 
        }
        
        .msg { 
            padding: 4px 10px 5px 10px;
            font-size: 14.5px;
            font-weight: 500; 
            line-height: 1.25;
            word-wrap: break-word; 
            position: relative; 
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
            min-width: 80px;
        }
        
        .msg.sticker-msg {
            background: transparent !important;
            box-shadow: none !important;
            padding: 0;
            border: none;
        }
        
        .msg a { color: var(--link-blue); text-decoration: none; font-weight: 700; word-break: break-all; cursor: pointer; }
        .msg a:hover { text-decoration: underline; }
        .msg-container.me .msg a { color: #cce4ff; }
        
        .msg-container.me { align-items: flex-end; }
        
        .msg-container.other { 
            flex-direction: row; 
            align-items: flex-end;
        }
        .msg-row-avatar {
            width: 38px; height: 38px;
            border-radius: 50%;
            margin-right: 10px;
            margin-bottom: 2px;
            flex-shrink: 0;
            display: none;
            object-fit: cover;
            overflow: hidden;
            background: #eee;
            align-items: center; justify-content: center;
            color: #888;
            font-size: 14px;
        }
        .msg-container.other .msg-row-avatar { display: flex; }
        .msg-container.other .msg-content-wrapper { max-width: 70%; }

        .msg-container.other.audio-msg .msg-row-avatar { display: none; }

        .msg-container.me .msg { 
            background: var(--msg-me); /* Dynamic Red */
            color: white; 
            border-radius: 12px 0 12px 12px;
            clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
            overflow: visible; 
            transition: background 0.3s ease;
        }
        
        .msg-container.other .msg { 
            background: var(--msg-other); 
            color: #222; 
            border-radius: 12px 12px 12px 0;
            border-left: 4px solid var(--accent);
            padding-left: 10px;
        }

        .msg-vip { background: var(--gold) !important; color: black !important; border: 1px solid #FDB931; box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3) !important; border-radius: 12px !important; clip-path: none !important; }
        
        .msg-img, .video-wrapper { 
            width: auto;
            height: auto;
            max-width: 70vw;
            max-height: 60vh;
            object-fit: contain;
            border-radius: 10px; 
            margin-top: 5px; 
            cursor: pointer; 
            display: block;
        }
        
        .video-wrapper { 
            position: relative; 
            display: block;
            width: fit-content;
            border-radius: 10px;
            overflow: hidden;
            background: #000;
        }
        .msg-video-thumb {
            width: 100%;
            height: 100%;
            opacity: 0.8;
            margin: 0;
            border-radius: 0;
            display: block;
        }
        .play-overlay {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.4);
            border-radius: 50%; width: 45px; height: 45px;
            display: flex; justify-content: center; align-items: center;
            color: white; font-size: 18px; pointer-events: none;
            backdrop-filter: blur(2px); border: 1.5px solid rgba(255,255,255,0.8);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .play-overlay i { margin-left: 2px; }
        
        .video-meta-info {
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding: 20px 8px 6px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            color: white; font-size: 10px; font-weight: 600;
            display: flex; justify-content: space-between; align-items: flex-end;
            font-family: 'Roboto', sans-serif;
        }

        .doc-bubble {
            display: flex; align-items: center; gap: 10px;
            background: rgba(0,0,0,0.05); border-radius: 8px;
            padding: 10px; margin-top: 5px; cursor: pointer;
            border: 1px solid rgba(0,0,0,0.1); width: 220px;
        }
        .msg-container.me .doc-bubble { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); }
        .doc-icon {
            font-size: 24px; color: #ff5252;
            width: 40px; height: 40px; background: white;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
        }
        .doc-info { flex: 1; overflow: hidden; }
        .doc-name { font-size: 13px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .doc-size { font-size: 10px; opacity: 0.7; margin-top: 2px; display: block; }

        .msg-map-frame {
            width: 240px;
            height: 150px;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 5px;
            border: 1px solid #eee;
            background: #eee;
        }
        .msg-map-frame iframe { width: 100%; height: 100%; border: 0; }

        .msg-contact-bubble {
            display: flex; align-items: center; gap: 10px;
            background: #fff;
            padding: 12px;
            border-radius: 12px;
            min-width: 220px;
            margin-top: 5px;
            border: 1px solid #eee;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .msg-contact-bubble .cc-icon {
            width: 40px; height: 40px;
            background: #e0e0e0;
            color: #555;
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 18px;
        }
        .msg-contact-bubble .cc-info { flex: 1; }
        .msg-contact-bubble .cc-name { font-weight: 700; font-size: 14px; color: #222; }
        .msg-contact-bubble .cc-num { font-size: 12px; color: #666; }
        .msg-contact-bubble .cc-action { font-size: 12px; color: var(--accent); font-weight: bold; text-transform: uppercase; }

        .notif-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            margin: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .notif-image-box {
            width: 100%;
            height: 250px;
            background: #f0f0f0;
            position: relative;
        }
        .notif-img { width: 100%; height: 100%; object-fit: cover; }
        .notif-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            background: var(--accent);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 900;
            font-family: 'Orbitron';
            letter-spacing: 1px;
            box-shadow: 0 4px 10px rgba(211, 47, 47, 0.4);
        }
        .notif-content { padding: 20px; }
        .notif-title { font-family: 'Orbitron'; font-size: 18px; font-weight: 900; margin-bottom: 8px; color: #111; }
        .notif-desc { font-size: 13px; color: #666; line-height: 1.6; margin-bottom: 20px; }
        .notif-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f9f9f9; padding-top: 15px; }
        .notif-time { font-size: 11px; color: #999; font-weight: 600; }
        .notif-btn {
            background: black; color: white;
            padding: 10px 20px; border-radius: 8px;
            font-size: 12px; font-weight: 800;
            font-family: 'Orbitron';
            border: none; cursor: pointer;
            display: flex; align-items: center; gap: 8px;
        }
        .notif-btn i { color: var(--gold); }

        .msg-meta { display: flex; justify-content: flex-end; align-items: center; margin-top: 0px; gap: 4px; float: right; margin-left: 8px; vertical-align: bottom; }
        .msg-time { font-size: 9px; opacity: 0.7; font-weight: 400; }
        .tick-icon { font-size: 10px; opacity: 0.7; color: rgba(255,255,255,0.7); }
        .tick-icon.blue { color: var(--blue-tick); opacity: 1; font-weight: bold; }
        .msg-container.other .tick-icon { display: none; }

        .reply-quote { font-size: 11px; padding: 5px 10px; margin-bottom: 5px; border-left: 3px solid rgba(0,0,0,0.2); background: rgba(0,0,0,0.05); border-radius: 4px; opacity: 0.9; font-weight: 700; }
        
        /* --- UPDATED REACTION CONTAINER CSS --- */
        .reaction-container {
            display: flex;
            gap: 2px;
            position: absolute;
            bottom: -14px; /* Move slightly lower to pop out */
            right: 10px;
            z-index: 100; /* Higher Z-Index */
            background: white;
            padding: 2px 4px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 1px solid #eee;
            align-items: center;
            animation: scaleIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .msg-container.other .reaction-container { right: auto; left: 10px; }
        .reaction-badge { font-size: 11px; padding: 0 2px; display: flex; align-items: center; font-weight: 600; color: #555; }

        .msg.selected-red { background: var(--accent) !important; color: white !important; }
        .msg-container.selected-bg-red { background: rgba(211, 47, 47, 0.2); }

        /* UNIQUE REACTION POPOVER */
        .reaction-popover {
            position: fixed; /* FIXED POSITION FOR VISIBILITY */
            background: rgba(20, 20, 20, 0.95); /* Dark Premium Look */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 50px;
            padding: 10px 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            z-index: 9999; /* TOP Z-INDEX */
            opacity: 0;
            border: 1px solid rgba(255,255,255,0.15);
            animation: bounceInReaction 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .rp-emoji { 
            font-size: 28px; /* Bigger Emojis */
            cursor: pointer; 
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.3)); 
        }

        .rp-emoji:hover { 
            transform: scale(1.4) translateY(-8px); 
        }

        .rp-emoji:active { 
            transform: scale(0.9); 
        }

        @keyframes bounceInReaction {
            0% { transform: scale(0.5) translateY(20px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }

        .heart-animation {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 60px;
            color: #d32f2f;
            z-index: 10;
            pointer-events: none;
            animation: heartPump 0.8s ease-out forwards;
        }
        @keyframes heartPump {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            40% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }

        #typing-indicator-box {
            position: absolute;
            bottom: 70px;
            left: 20px;
            z-index: 100;
            display: none;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            background: white;
            border-radius: 20px 20px 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #eee;
        }
        
        .typing-dots { display: flex; align-items: center; gap: 4px; }
        .t-dot {
            width: 8px; height: 8px; background: var(--accent); border-radius: 50%;
            animation: bounceRed 1.4s infinite ease-in-out both;
        }
        .t-dot:nth-child(1) { animation-delay: -0.32s; }
        .t-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounceRed { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        .recording-wave { display: flex; align-items: center; gap: 3px; height: 15px; }
        .r-bar {
            width: 3px; height: 100%; background: var(--accent); border-radius: 2px;
            animation: waveRed 1.2s ease-in-out infinite;
        }
        .r-bar:nth-child(1) { animation-delay: -1.1s; }
        .r-bar:nth-child(2) { animation-delay: -1.0s; }
        .r-bar:nth-child(3) { animation-delay: -0.9s; }
        .r-bar:nth-child(4) { animation-delay: -0.8s; }
        .r-bar:nth-child(5) { animation-delay: -0.7s; }
        @keyframes waveRed { 0%, 40%, 100% { height: 20%; } 20% { height: 100%; } }
        
        .indicator-text { font-size: 10px; color: var(--accent); font-weight: 700; margin-left: 5px; font-family: 'Orbitron'; letter-spacing: 1px; }

        .chat-footer { 
            background: white; 
            display: flex; 
            flex-direction: column; 
            padding: 8px 15px; 
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            position: relative;
        }

        .telegram-join-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            padding: 10px; background: white; border-top: 1px solid #eee;
            z-index: 220; display: none; justify-content: center; align-items: center;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }
        .btn-tg-join {
            width: 95%; padding: 12px; background: var(--accent); color: white;
            border: none; border-radius: 8px; font-weight: 900;
            font-family: 'Orbitron'; font-size: 14px; text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(211, 47, 47, 0.4);
            cursor: pointer; transition: transform 0.2s;
        }
        .btn-tg-join:active { transform: scale(0.95); }
        .btn-tg-join.pending { background: #888; box-shadow: none; cursor: default; }

        .reply-preview-bar { 
            display: none; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 15px; 
            background: #f3f3f3; 
            border-left: 5px solid var(--accent); 
            font-size: 13px; 
            color: #333; 
            border-radius: 15px; 
            margin: 0 5px 10px 5px;
            animation: slideUpReply 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .reply-preview-bar.show { display: flex; }
        @keyframes slideUpReply { from { transform: translateY(20px) scale(0.9); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        
        .preview-bar { display: none; align-items: center; justify-content: space-between; padding: 10px 20px; background: #fff; margin-bottom: 10px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); animation: slideUp 0.2s ease-out; }
        .preview-bar.show { display: flex; }
        .rec-indicator { display: flex; align-items: center; gap: 10px; color: var(--accent); font-weight: bold; font-family: 'Roboto Mono', monospace; }
        .rec-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--accent); animation: recPulse 1s infinite; }
        @keyframes recPulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .img-preview-thumb { 
            width: 50px; 
            height: 50px; 
            object-fit: cover; 
            border-radius: 6px; 
            border: 1px solid #ddd; 
            margin-left: 5px;
        }

        .msg-input-area { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            width: 100%;
        }
        
        .input-group { 
            flex: 1; 
            display: flex; 
            align-items: flex-end; 
            background: var(--input-bg); 
            border-radius: 24px; 
            padding: 4px 10px;
            min-height: 38px;
            transition: background 0.2s, box-shadow 0.2s;
            width: auto; 
            min-width: 0; 
        }
        .input-group:focus-within {
            background: #fff;
            box-shadow: 0 0 0 1px #e0e0e0;
        }
        
        #msg-input { 
            flex: 1; 
            padding: 8px 8px;
            border: none; 
            background: transparent; 
            outline: none; 
            font-size: 15px; 
            color: #262626;
            min-width: 10px;
            resize: none;
            height: auto; 
            max-height: 120px; 
            overflow-y: auto;
            font-family: 'Roboto', sans-serif;
            line-height: 20px;
        }

        /* NEW STICKER BTN (LEFT) */
        .emoji-btn {
            width: 34px; height: 34px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 50%;
            transition: transform 0.2s;
            margin-bottom: 2px;
        }
        .emoji-btn svg { width: 22px; height: 22px; fill: #54656f; transition: fill 0.3s; }
        .emoji-btn:active { transform: scale(0.9); }
        .emoji-btn:active svg { fill: var(--accent); }

        /* PAPER CLIP DESIGN (RIGHT) */
        .photo-btn { 
            width: 34px; 
            height: 34px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 18px; 
            cursor: pointer; 
            margin-right: 0;
            margin-left: 5px;
            color: #54656f;
            transition: transform 0.2s;
            flex-shrink: 0;
            background: transparent;
            border-radius: 50%;
            transform: rotate(45deg);
            margin-bottom: 2px;
        }
        .photo-btn:active { transform: rotate(45deg) scale(0.9); }

        .admin-speech-btn {
            padding: 0 5px 0 10px;
            color: #555;
            cursor: pointer;
            display: flex;
            align-items: center;
            height: 34px;
            margin-bottom: 2px;
        }
        .speech-menu {
            position: absolute;
            bottom: 70px;
            right: 60px;
            background: white;
            padding: 12px 15px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            display: none;
            z-index: 150;
            border: 1px solid #eee;
        }
        .speech-menu.show { display: block; animation: slideUp 0.2s; }
        .speech-option { display: flex; gap: 10px; align-items: center; font-weight: bold; font-size: 12px; cursor: pointer; justify-content: space-between; min-width: 100px; font-family: 'Orbitron'; }
        .status-on { color: var(--green); }
        .status-off { color: #888; }

        .mic-btn, .send-btn { 
            width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 20px; 
            cursor: pointer; 
            transition: transform 0.2s, opacity 0.2s; 
            flex-shrink: 0;
            border: none; 
        }

        .mic-btn {
            background: var(--accent); 
            color: white; 
            font-size: 20px;
            box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3);
            z-index: 20;
        }
        .mic-btn.active-hold { transform: scale(1.5); transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .mic-btn.recording { animation: ripple 1.5s infinite; background: #b71c1c; }

        .send-btn { 
            background: var(--accent); 
            color: white; 
            display: none;
            box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3);
        }
        .send-btn:active { transform: scale(0.9); }

        @keyframes ripple { 0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(211, 47, 47, 0); } 100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); } }

        .voice-lock-indicator {
            position: absolute;
            right: 0;
            bottom: 70px;
            background: white;
            border-radius: 20px;
            padding: 10px;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            z-index: 15;
            animation: slideUpFade 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .voice-lock-indicator i { font-size: 18px; color: #555; animation: bounceUp 1s infinite; }
        @keyframes bounceUp { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        
        .voice-slide-cancel {
            position: absolute;
            right: 60px;
            bottom: 18px;
            font-size: 13px;
            color: #888;
            font-weight: 500;
            display: none;
            align-items: center;
            gap: 5px;
            pointer-events: none;
            white-space: nowrap;
        }
        .voice-slide-cancel i { font-size: 12px; }

        .recording-locked-view {
            display: none;
            align-items: center;
            width: 100%;
            padding: 5px 0;
            justify-content: space-between;
        }
        
        .rec-cancel-btn { 
            color: #ff5252; font-weight: 900; cursor: pointer; padding: 10px; font-size: 14px; 
            font-family: 'Orbitron'; letter-spacing: 1px;
        }
        
        .rec-locked-timer { 
            color: #111; font-weight: bold; font-family: 'Roboto Mono'; font-size: 16px;
            display: flex; align-items: center; gap: 8px; 
        }
        .rec-locked-timer .rec-dot { animation: recPulse 1s infinite; width:10px; height:10px; background:var(--accent); border-radius:50%; }
        
        .rec-send-btn {
            width: 40px; height: 40px; background: var(--accent);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            color: white; font-size: 16px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3);
        }

        #voice-trash-can {
            position: absolute; bottom: 100px; left: 20px;
            font-size: 24px; color: #ff1744;
            display: none; z-index: 25;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .anim-trash-in { animation: popIn 0.3s forwards; }

        .voice-player {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 230px;
            max-width: 260px;
            padding: 6px 8px 6px 6px;
            border-radius: 18px;
            position: relative;
            height: 52px;
            box-sizing: border-box;
        }

        .voice-dp {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 1px solid rgba(0,0,0,0.1);
            display: flex; justify-content: center; align-items: center; 
            background: #ccc;
            overflow: hidden;
            font-size: 18px; color: white;
        }
        .voice-dp i { font-size: 20px; }

        .voice-controls-wrap {
            display: flex; align-items: center; gap: 8px; flex: 1;
            height: 100%;
        }

        .voice-play-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; flex-shrink: 0;
            background: rgba(0,0,0,0.1); color: inherit;
        }
        .msg-container.me .voice-play-btn { background: rgba(255,255,255,0.2); }
        .voice-play-btn i { font-size: 12px; }
        
        .wave-container {
            flex: 1; 
            height: 18px;
            display: flex; align-items: center; gap: 2px;
            position: relative;
        }
        .wave-bar {
            width: 3px; border-radius: 2px;
            background-color: rgba(0,0,0,0.2);
            transition: background-color 0.1s;
        }
        .msg-container.me .wave-bar { background-color: rgba(255,255,255,0.4); }
        
        .msg-container.other .wave-bar.played { background-color: var(--accent); }
        .msg-container.me .wave-bar.played { background-color: white; }

        .voice-player.unplayed .voice-play-btn i { color: #00e676; }
        .voice-player.unplayed .voice-play-btn { background: rgba(0, 230, 118, 0.1); }
        .voice-player.unplayed .wave-bar { background-color: rgba(0, 230, 118, 0.5); }
        .voice-player.unplayed .wave-bar.played { background-color: #00e676; }

        .voice-progress-dot {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 8px; 
            height: 8px;
            background-color: #34B7F1;
            border-radius: 50%;
            z-index: 10;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
            transition: left 0.1s linear;
            display: none;
            pointer-events: none;
        }
        
        .voice-time {
            font-size: 11px;
            font-weight: 500;
            margin-right: 5px;
            opacity: 0.8;
            font-variant-numeric: tabular-nums;
        }

        .msg-container.me .voice-player { flex-direction: row; }
        .msg-container.other .voice-player { flex-direction: row; }

        #scroll-down-btn {
            position: absolute;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            width: 36px;
            height: 36px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 150;
            cursor: pointer;
            color: var(--accent);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid #f0f0f0;
        }
        #scroll-down-btn.show { transform: translateX(-50%) scale(1); }
        #scroll-badge {
            position: absolute;
            top: -55px;
            right: -5px;
            background: var(--accent);
            color: white;
            font-size: 10px;
            font-weight: 900;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid white;
        }

        #online-notify {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 350px; background: rgba(10, 10, 10, 0.95);
            border: 1px solid #333; border-left: 4px solid var(--green);
            color: white; padding: 12px 15px; border-radius: 12px; 
            display: none; align-items: center; gap: 15px; z-index: 450; 
            box-shadow: 0 5px 25px rgba(0, 230, 118, 0.25);
            cursor: pointer; backdrop-filter: blur(8px);
            animation: slideDownNotify 0.4s ease-out;
        }
        @keyframes slideDownNotify { from { transform: translate(-50%, -20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        
        .on-notif-avatar {
            width: 40px; height: 40px; border-radius: 50%; background: #222;
            display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; border: 1px solid #444; position: relative;
        }
        .on-notif-icon { position: absolute; bottom: -2px; right: -2px; color: var(--gold); font-size: 14px; text-shadow: 0 0 5px orange; }
        .on-notif-info h4 { margin: 0; font-size: 14px; font-weight: 800; font-family: 'Orbitron'; letter-spacing: 0.5px; }
        .on-notif-info p { margin: 2px 0 0 0; font-size: 11px; color: var(--green); font-weight: bold; text-transform: uppercase; }

        #action-menu { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 300; display: none; justify-content: center; align-items: center; }
        .menu-content { background: white; padding: 20px; border-radius: 20px; width: 80%; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .menu-btn { display: flex; align-items: center; gap: 10px; width: 100%; padding: 15px; border: none; background: transparent; font-size: 16px; font-weight: 700; border-bottom: 1px solid #f5f5f5; cursor: pointer; color: #333; }
        .menu-btn:last-child { border: none; color: #777; }
        .menu-btn i { width: 25px; color: var(--accent); }
        .menu-btn.danger { color: #d32f2f; }
        .menu-btn.danger i { color: #d32f2f; }
        .reactions { display: flex; justify-content: space-around; padding: 15px 0; border-bottom: 1px solid #eee; font-size: 24px; cursor: pointer; }
        
        #lightbox { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            z-index: 600; display: none; 
            align-items: center; justify-content: center;
            touch-action: none; 
            transition: background-color 0.2s;
        }
        #lightbox.active { display: flex; animation: lightboxFadeIn 0.3s ease-out forwards; }
        
        #lightbox img { 
            width: 100vw;
            height: auto;
            max-height: 100vh; 
            object-fit: contain; 
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            transform: scale(0.9);
        }
        #lightbox.active img { transform: scale(1); }

        #lightbox.zoomed img {
            transform: scale(2.5);
            max-height: none;
            cursor: zoom-out;
        }
        #lightbox video {
            max-width: 100%; max-height: 100%;
        }
        .lightbox-close { position: absolute; top: 20px; right: 20px; color: #333; font-size: 30px; cursor: pointer; background: rgba(255,255,255,0.5); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 605; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .lightbox-icon-container { font-size: 200px; color: #333; display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; }
        @keyframes lightboxFadeIn { from { opacity: 0; } to { opacity: 1; } }

        #forward-modal, #select-contact-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 400; display: none; flex-direction: column; }
        .forward-header { padding: 15px; display: flex; align-items: center; border-bottom: 1px solid #eee; }
        .forward-header i { font-size: 20px; padding: 10px; cursor: pointer; }
        .forward-header h2 { flex: 1; text-align: center; margin: 0; font-size: 18px; font-weight: 700; }
        
        #incoming-call-modal { position: fixed; top: 20px; left: 5%; width: 90%; background: rgba(20, 20, 20, 0.95); color: white; border-radius: 16px; padding: 15px 20px; display: none; align-items: center; justify-content: space-between; z-index: 400; box-shadow: 0 10px 30px rgba(0,0,0,0.4); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .incoming-info h3 { margin: 0; font-size: 16px; font-family: 'Orbitron'; letter-spacing: 1px; }
        .incoming-info p { margin: 3px 0 0 0; font-size: 11px; color: var(--green); font-weight: bold; animation: blink 1.5s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        .incoming-actions { display: flex; gap: 15px; }
        .answer-btn { background: var(--green); width: 45px; height: 45px; border-radius: 50%; border: none; color: white; cursor: pointer; font-size: 18px; box-shadow: 0 4px 10px rgba(0, 200, 83, 0.3); }
        .reject-call-btn { background: #ff1744; width: 45px; height: 45px; border-radius: 50%; border: none; color: white; cursor: pointer; font-size: 18px; box-shadow: 0 4px 10px rgba(255, 23, 68, 0.3); }

        #call-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 300; display: none; flex-direction: column; align-items: center; }
        .call-bg-blur { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.4; filter: blur(20px); z-index: 0; display: none; }
        .audio-mode .call-bg-blur { display: block; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; display: block; background: #000; z-index: 1; }
        
        .call-controls { transition: opacity 0.3s ease; } 
        .ui-hidden { opacity: 0; pointer-events: none; }

        /* --- UPDATED CALL OVERLAY STYLES --- */
        /* Connecting State: Local Video Full Screen */
        #call-overlay.connecting #local-video { 
            width: 100% !important; 
            height: 100% !important; 
            top: 0 !important; 
            left: 0 !important; 
            z-index: 1; 
            border-radius: 0; 
            border: none;
        }
        #call-overlay.connecting #remote-video { display: none; }

        /* Connected State: Default PiP Style (Small) */
        #call-overlay.connected #local-video { 
            position: absolute; 
            top: 20px; right: 20px; 
            width: 90px; height: 135px; /* Minimalist Size */
            background: #222; 
            border-radius: 12px; 
            object-fit: cover; 
            z-index: 201; 
            display: block; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); 
            border: 1px solid rgba(255,255,255,0.2); 
            touch-action: none;
            transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), height 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* Only transition size, drag handles position */
        }

        /* Connected State + UI Active: PiP slightly larger */
        #call-overlay.connected.ui-active #local-video {
            width: 110px; height: 160px; /* Standard PiP Size */
        }
        
        .audio-mode #remote-video, .audio-mode #local-video { opacity: 0; pointer-events: none; position: absolute; width: 1px; height: 1px; }
        .audio-placeholder { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; color: white; z-index: 2; }
        .audio-mode .audio-placeholder { display: flex; }
        .call-avatar { width: 160px; height: 160px; border-radius: 50%; background: rgba(255,255,255,0.1); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; font-size: 70px; color: white; border: 2px solid rgba(255,255,255,0.2); margin-bottom: 40px; animation: pulse 2s infinite; box-shadow: 0 0 30px rgba(0,0,0,0.3); overflow: hidden; }
        .call-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(211, 47, 47, 0); } 100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); } }
        
        .call-info-top { position: absolute; top: 10px; width: 100%; text-align: center; color: white; z-index: 202; padding-top: env(safe-area-inset-top); } /* Added safe-area and moved up */
        .call-name { font-size: 18px; font-weight: 900; margin-bottom: 2px; font-family: 'Orbitron'; text-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .call-status { font-size: 10px; opacity: 0.9; font-weight: 500; letter-spacing: 1.5px; color: var(--gold); text-transform: uppercase; }
        .call-timer { font-size: 14px; margin-top: 5px; font-family: 'Roboto Mono', monospace; letter-spacing: 1px; display: none; text-shadow: 0 2px 5px black; }
        .call-controls { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; gap: 20px; z-index: 202; padding-bottom: env(safe-area-inset-bottom); }
        .call-btn { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; cursor: pointer; border: none; transition: transform 0.2s, background 0.3s; }

        .call-btn:active { transform: scale(0.9); }
        .hangup-btn { background: #ff1744; box-shadow: 0 5px 20px rgba(255, 23, 68, 0.4); }
        .control-btn { background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .control-btn.active { background: white; color: black; }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 300px; color: #ccc; }
        .empty-state i { font-size: 60px; margin-bottom: 10px; opacity: 0.5; }

        .channel-header { display: flex; justify-content: space-between; align-items: center; }
        
        .create-icon { color: var(--accent); font-size: 26px; cursor: pointer; padding: 10px; }
        .leaderboard-icon { color: var(--gold); font-size: 28px; cursor: pointer; padding: 10px; text-shadow: 0 2px 5px rgba(255,215,0,0.3); }

        .create-form-container { padding: 20px; overflow-y: auto; height: 100%; }
        
        /* New Create Group Design CSS */
        .group-create-header {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin-bottom: 30px; margin-top: 10px;
        }
        .group-icon-upload {
            width: 90px; height: 90px; border-radius: 50%;
            background: #e0e0e0; display: flex; justify-content: center; align-items: center;
            font-size: 35px; color: white; cursor: pointer;
            position: relative; margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .group-icon-upload:active { transform: scale(0.95); }
        .group-icon-upload i { z-index: 2; }
        .group-icon-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1; }

        .group-name-input {
            width: 100%; padding: 10px 0; border: none; 
            border-bottom: 2px solid #ddd; outline: none;
            font-size: 16px; font-weight: 600; background: transparent;
            transition: border-color 0.3s;
        }
        .group-name-input:focus { border-bottom-color: var(--accent); }

        .participants-title {
            font-size: 13px; font-weight: 800; color: #888;
            margin-top: 20px; margin-bottom: 10px; font-family: 'Orbitron';
            text-transform: uppercase; letter-spacing: 1px;
        }

        .contact-select-item {
            display: flex; align-items: center; padding: 10px 0;
            cursor: pointer; border-bottom: 1px solid #f9f9f9;
        }
        .contact-select-checkbox {
            width: 20px; height: 20px; border-radius: 50%;
            border: 2px solid #ccc; margin-right: 15px;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.2s;
        }
        .contact-select-item.selected .contact-select-checkbox {
            background: var(--green); border-color: var(--green);
        }
        .contact-select-item.selected .contact-select-checkbox::after {
            content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900;
            color: white; font-size: 10px;
        }
        
        .floating-create-btn {
            position: absolute; bottom: 20px; right: 20px;
            width: 55px; height: 55px; border-radius: 50%;
            background: var(--green); color: white;
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; box-shadow: 0 4px 15px rgba(0,230,118,0.4);
            cursor: pointer; border: none; z-index: 10;
            transition: transform 0.2s;
        }
        .floating-create-btn:active { transform: scale(0.9); }

        /* End New Create Group CSS */

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 700; color: #555; margin-bottom: 8px; font-family: 'Orbitron'; }
        .form-input, .form-select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; outline: none; background: #f9f9f9; }
        .form-input:focus { border-color: var(--accent); background: white; }
        
        .icon-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 10px; }
        .icon-option { height: 50px; background: #f0f0f0; border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 20px; cursor: pointer; border: 2px solid transparent; position: relative; }
        .icon-option.selected { border-color: var(--accent); background: #fff0f0; color: var(--accent); }
        .icon-option.locked { opacity: 0.5; cursor: not-allowed; }
        .icon-option.locked::after { content: '\f023'; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; font-size: 12px; color: #333; }

        .toggle-container { display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 15px; border-radius: 10px; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(24px); }

        .radio-group { display: flex; gap: 15px; }
        .radio-label { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 10px; text-align: center; cursor: pointer; font-weight: 700; font-size: 14px; position: relative; overflow: hidden; }
        .radio-label input { position: absolute; opacity: 0; cursor: pointer; }
        .radio-label span { position: relative; z-index: 2; }
        .radio-label.selected-radio { background: var(--accent); color: white; border-color: var(--accent); }
        
        .btn-create { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 900; font-family: 'Orbitron'; margin-top: 20px; cursor: pointer; box-shadow: 0 4px 15px rgba(211, 47, 47, 0.4); }

        .select-contact-btn { width: 100%; padding: 12px; background: #fff; border: 1px solid #ddd; border-radius: 10px; text-align: left; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: #555; }

        .info-card { text-align: center; padding: 30px 20px; background: white; border-bottom: 1px solid #f0f0f0; }
        .info-icon { font-size: 60px; color: var(--accent); margin-bottom: 10px; }
        .info-title { font-size: 22px; font-weight: 900; font-family: 'Orbitron'; margin-bottom: 5px; }
        .info-sub { font-size: 13px; color: #888; }
        .member-list-header { padding: 15px 20px; background: #f9f9f9; font-weight: 700; color: #555; font-size: 13px; border-top: 1px solid #eee; border-bottom: 1px solid #eee; }
        .leave-btn-container { padding: 20px; }
        .leave-channel-btn { width: 100%; padding: 12px; background: #ffebee; color: #d32f2f; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 14px; margin-bottom: 10px; }

        .channel-item { border-bottom: 1px solid #f0f0f0; padding: 18px 20px; }
        
        .channel-type-badge { font-size: 10px; padding: 4px 8px; border-radius: 12px; font-weight: 700; text-transform: uppercase; margin-right: 5px; letter-spacing: 0.5px; display: inline-flex; align-items: center; gap: 4px; }
        .badge-public { background: rgba(0, 230, 118, 0.1); color: #00e676; border: 1px solid rgba(0, 230, 118, 0.2); }
        .badge-private { background: rgba(211, 47, 47, 0.1); color: #ff1744; border: 1px solid rgba(211, 47, 47, 0.2); }
        
        .lock-icon { font-size: 12px; color: #555; margin-left: 8px; }

        #leaderboard-screen { background: #5a0000; }
        .leaderboard-bg {
            background: linear-gradient(135deg, #d32f2f 0%, #8e0000 100%);
            min-height: 100%; color: white;
        }
        .leaderboard-header {
            padding: 20px; text-align: center;
            border-bottom: 1px solid #a30000;
            background: rgba(0,0,0,0.2); backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 50;
        }
        .leaderboard-title { font-size: 24px; font-family: 'Orbitron'; color: var(--gold); text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        .leaderboard-subtitle { font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 5px; letter-spacing: 1px; }
        .close-lb { position: absolute; top: 20px; left: 20px; font-size: 24px; color: white; cursor: pointer; }
        
        .lb-list { padding: 10px 0; }
        .lb-item {
            display: flex; align-items: center; padding: 15px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2);
            transition: background 0.2s;
        }
        .lb-item.top-rank { background: linear-gradient(90deg, rgba(255,215,0,0.2), transparent); border-left: 4px solid var(--gold); }
        .lb-rank {
            font-size: 18px; font-weight: 900; width: 40px; text-align: center;
            font-family: 'Orbitron'; color: rgba(255,255,255,0.6);
        }
        
        .rank-1 { color: var(--gold); text-shadow: 0 0 10px var(--gold); font-size: 22px; }
        .rank-2 { color: var(--silver); text-shadow: 0 0 10px var(--silver); font-size: 20px; }
        .rank-3 { color: var(--platinum); text-shadow: 0 0 10px var(--platinum); font-size: 20px; }
        
        .lb-info { flex: 1; margin-left: 10px; }
        .lb-name { font-size: 16px; font-weight: 700; color: white; margin-bottom: 4px; }
        .lb-members { font-size: 12px; color: rgba(255,255,255,0.7); }
        
        .rank-badge { 
            font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 4px; 
            margin-top: 4px; display: inline-block; font-family: 'Orbitron';
        }
        .badge-gold { background: linear-gradient(45deg, #FFD700, #FDB931); color: black; box-shadow: 0 2px 5px rgba(255,215,0,0.3); }
        .badge-silver { background: linear-gradient(45deg, #C0C0C0, #E0E0E0); color: black; box-shadow: 0 2px 5px rgba(192,192,192,0.3); }
        .badge-platinum { background: linear-gradient(45deg, #E5E4E2, #ffffff); color: black; box-shadow: 0 2px 5px rgba(229,228,226,0.3); }

        .lb-placeholder {
            padding: 15px 20px; display: flex; align-items: center; 
            color: rgba(255,255,255,0.3); border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .lb-ph-rank { width: 40px; text-align: center; font-family: 'Orbitron'; font-weight: bold; }
        .lb-ph-dash { font-weight: 900; font-size: 20px; margin-left: 20px; }

        #profile-screen { background: white; }
        
        .profile-page-header {
            display: flex; align-items: center;
            padding: 30px 20px;
            position: relative;
        }
        
        .pp-left { margin-right: 20px; }
        
        .pp-avatar {
            width: 85px; height: 85px; border-radius: 50%;
            background: #f0f0f0; 
            display: flex; justify-content: center; align-items: center;
            font-size: 35px; color: #555;
            position: relative; 
            cursor: pointer;
        }

        .pp-border-ring {
            position: absolute;
            top: -4px; left: -4px; right: -4px; bottom: -4px;
            border-radius: 50%;
            border: 2px solid transparent; 
            pointer-events: none;
            transition: all 0.3s;
        }

        .pp-avatar.uploading .pp-border-ring {
            border: 3px solid var(--accent); 
            border-top: 3px solid transparent;
            animation: spinBorder 1s linear infinite;
        }

        .pp-avatar.has-story .pp-border-ring {
            border: 3px solid var(--accent);
            animation: none;
        }

        @keyframes spinBorder {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .story-add-icon {
            position: absolute; bottom: 0; right: 0;
            background: var(--accent); color: white;
            width: 24px; height: 24px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            border: 2px solid white; font-size: 12px; cursor: pointer;
            z-index: 10;
        }
        
        .pp-right { flex: 1; }
        
        .pp-name { 
            font-size: 22px; font-weight: 800; 
            color: #222; font-family: 'Orbitron';
            margin-bottom: 5px; 
            margin-top: -10px;
        }
        
        .pp-settings { 
            position: absolute;
            top: 20px; right: 20px;
            font-size: 22px; color: #333; 
            cursor: pointer; 
        }
        
        .pp-bio-area { 
            padding: 0 20px; 
            margin-top: 10px;
        }
        
        #my-profile-bio {
            font-size: 15px; color: var(--accent); margin-bottom: 25px; 
            font-family: 'Orbitron', sans-serif; font-weight: 500; font-style: italic;
            padding: 10px; background: rgba(211, 47, 47, 0.05); border-radius: 12px;
            line-height: 1.4; border: 1px dashed rgba(211, 47, 47, 0.2);
        }

        .pp-dashboard-row { display: flex; align-items: center; gap: 8px; width: 100%; margin-bottom: 15px; }
        
        @keyframes shine {
            100% { left: 200%; }
        }
        
        .btn-shine {
            position: relative;
            overflow: hidden;
        }
        .btn-shine::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
            transform: skewX(-25deg);
            animation: shine 3s infinite;
        }

        .pp-dash-main {
            flex: 1; height: 50px;
            background: #efefef; border-radius: 8px;
            display: flex; align-items: center; padding: 0 12px;
            font-size: 13px; font-weight: 700; color: #111;
            cursor: pointer; border: none;
            justify-content: flex-start;
            gap: 8px;
        }
        .pp-dash-side {
            width: 50px; height: 50px;
            background: #efefef; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .pp-dash-side i { font-size: 20px !important; }

        .pp-btns-row {
            display: flex;
            gap: 10px;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .pp-action-btn {
            flex: 1;
            padding: 10px; 
            background: #f0f0f0;
            color: #000;
            border: none;
            border-radius: 8px; 
            font-weight: 700;
            font-size: 13px;
            font-family: 'Orbitron';
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: background 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .pp-action-btn:active { background: #e0e0e0; transform: scale(0.98); }


        #admin-panel-btn {
            display: none;
            width: 100%; padding: 14px; 
            background: #222; color: white;
            border: none; border-radius: 12px;
            font-weight: 900; font-size: 15px; 
            font-family: 'Orbitron'; cursor: pointer;
            margin-bottom: 15px; margin-top: 20px;
            border: 1px solid #444;
        }
        
        #admin-dashboard-screen {
            background: #f5f5f5; z-index: 500;
        }
        .admin-container { padding: 20px; }
        .admin-card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .admin-card-title { font-size: 14px; font-weight: 900; color: #555; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        
        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .stat-box { background: #fafafa; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #eee; }
        .stat-num { font-size: 24px; font-weight: 900; color: var(--accent); display: block; }
        .stat-label { font-size: 11px; color: #888; font-weight: 700; }
        
        .danger-zone { border: 2px solid #ff5f6d; background: #fff5f5; }
        .kill-switch-btn { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 10px; font-weight: 900; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .kill-switch-btn.active { background: #444; }

        #edit-profile-screen {
            background: white; z-index: 300;
        }
        .edit-p-container {
            display: flex; flex-direction: column; align-items: center; padding: 20px;
        }
        .edit-p-avatar-wrapper {
            position: relative; margin-top: 20px; margin-bottom: 30px;
            cursor: pointer;
        }
        .edit-p-avatar-lg {
            width: 120px; height: 120px; border-radius: 50%;
            background: #f5f5f5; border: 4px solid var(--accent);
            display: flex; justify-content: center; align-items: center;
            font-size: 50px; color: #555;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .edit-p-edit-icon {
            position: absolute; bottom: 5px; right: 5px;
            width: 35px; height: 35px; background: #222;
            color: white; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 16px; border: 2px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .edit-p-input-group { width: 100%; margin-bottom: 20px; }
        .edit-p-label { font-size: 12px; font-weight: 900; color: #888; margin-bottom: 8px; font-family: 'Orbitron'; display: block; }
        .edit-p-input { width: 100%; padding: 15px; background: #f9f9f9; border: 1px solid #eee; border-radius: 12px; font-size: 16px; font-weight: 600; outline: none; }
        .edit-p-input:focus { border-color: var(--accent); background: white; }
        
        .edit-p-bio { min-height: 100px; resize: none; font-family: 'Roboto', sans-serif; }

        #icon-picker-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 950; display: none;
            flex-direction: column;
        }
        .icon-grid-profile {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 20px;
        }
        .pf-icon-opt {
            height: 60px; background: #f5f5f5; border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; color: #333; cursor: pointer;
            border: 2px solid transparent; position: relative;
        }
        .pf-icon-opt.selected { border-color: var(--accent); background: #fff0f0; color: var(--accent); }
        .pf-icon-opt.vip-locked { opacity: 0.6; cursor: not-allowed; }
        .pf-icon-opt.vip-locked::after {
            content: '\f023'; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; top: -5px; right: -5px;
            background: #222; color: var(--gold);
            width: 20px; height: 20px; border-radius: 50%;
            font-size: 10px; display: flex; justify-content: center; align-items: center;
            border: 2px solid white;
        }
        .vip-section-title {
            margin: 20px 20px 10px; font-size: 14px; font-weight: 900;
            color: var(--gold); font-family: 'Orbitron'; text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            display: flex; align-items: center; gap: 8px;
        }

        /* --- WHATSAPP STYLE UNIQUE ATTACHMENT MENU --- */
        #attachment-menu {
            position: absolute;
            bottom: 75px; /* Above the input bar */
            left: 10px; right: 10px;
            margin: 0 auto;
            width: 95%;
            max-width: 360px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 25px 15px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            transform-origin: bottom right;
            transform: scale(0);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 200;
            pointer-events: none;
            border: 1px solid rgba(255,255,255,0.5);
        }
        #attachment-menu.open {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        
        .att-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .att-item:active { transform: scale(0.9); }

        .att-icon {
            width: 55px; height: 55px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            border: 2px solid white;
        }

        /* WhatsApp-like Gradient Colors */
        .att-icon.doc { background: linear-gradient(135deg, #7F57FF, #5E35B1); } /* Purple - Document */
        .att-icon.cam { background: linear-gradient(135deg, #FF5252, #D32F2F); } /* Red - Camera */
        .att-icon.gal { background: linear-gradient(135deg, #D500F9, #AA00FF); } /* Pink - Gallery */
        .att-icon.aud { background: linear-gradient(135deg, #FF9800, #F57C00); } /* Orange - Audio */
        .att-icon.loc { background: linear-gradient(135deg, #00E676, #00C853); } /* Green - Location */
        .att-icon.con { background: linear-gradient(135deg, #2979FF, #2962FF); } /* Blue - Contact */

        .att-item span { 
            font-size: 12px; font-weight: 600; color: #444; 
            font-family: 'Roboto', sans-serif;
            text-align: center;
        }

        /* --- STICKER PICKER STYLES --- */
        #sticker-picker {
            position: absolute;
            bottom: 75px; 
            left: 10px; right: 10px;
            margin: 0 auto;
            width: 95%;
            max-width: 360px;
            height: 250px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            transform-origin: bottom left;
            transform: scale(0);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 200;
            pointer-events: none;
            border: 1px solid rgba(255,255,255,0.5);
            overflow-y: auto;
        }
        #sticker-picker.open {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        
        .ninja-sticker-btn {
            aspect-ratio: 1/1;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            transition: transform 0.1s;
            background: rgba(0,0,0,0.03);
            border-radius: 12px;
        }
        .ninja-sticker-btn:active { transform: scale(0.9); background: rgba(0,0,0,0.1); }
        .ninja-sticker-btn svg {
            width: 80%; height: 80%;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));
        }

        #story-preview-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 2000;
            display: none; flex-direction: column;
        }
        
        .sp-header {
            position: absolute; top: 0; width: 100%;
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; padding-top: calc(15px + env(safe-area-inset-top));
            z-index: 20;
        }
        .sp-header i { font-size: 24px; color: black; cursor: pointer; }
        
        .sp-sound-badge {
            background: rgba(0,0,0,0.05); padding: 6px 15px; border-radius: 20px;
            font-weight: 700; font-size: 12px; display: flex; align-items: center; gap: 6px;
            color: #333; backdrop-filter: blur(5px);
        }
        
        .sp-tool-text {
            font-size: 20px; font-weight: 900; cursor: pointer;
            width: 35px; height: 35px; background: rgba(0,0,0,0.05);
            display: flex; justify-content: center; align-items: center;
            border-radius: 50%;
        }

        .story-preview-content {
            flex: 1; width: 100%; height: 100%;
            position: relative; overflow: hidden;
            background: #fff;
        }
        
        #story-media-container {
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            transform-origin: center center;
            touch-action: none;
        }

        #story-img-preview { max-width: 100%; max-height: 100%; object-fit: contain; pointer-events: none; }
        #story-video-preview { max-width: 100%; max-height: 100%; object-fit: contain; pointer-events: none; }
        
        .draggable-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-weight: 900; font-size: 24px; 
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
            padding: 10px; border: 2px dashed transparent;
            cursor: move; z-index: 15; max-width: 80%; text-align: center;
            font-family: 'Roboto', sans-serif;
        }
        .draggable-text.active { border-color: rgba(255,255,255,0.5); background: rgba(0,0,0,0.2); border-radius: 8px; }

        .sp-footer {
            position: absolute; bottom: 0; width: 100%;
            padding: 20px; padding-bottom: calc(20px + env(safe-area-inset-bottom));
            display: flex; justify-content: space-between; align-items: center;
            background: linear-gradient(to top, rgba(255,255,255,0.9) 20%, transparent);
            z-index: 20;
        }
        
        .story-btn-round {
            padding: 12px 20px; border-radius: 25px;
            border: none; font-weight: 800; font-family: 'Orbitron';
            display: flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            cursor: pointer; font-size: 13px; color: white;
            transition: transform 0.1s;
        }
        .story-btn-round:active { transform: scale(0.95); }
        
        .btn-star { background: var(--green); }
        .btn-upload { background: var(--accent); }

        #story-text-editor {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2005;
            display: none; justify-content: center; align-items: center;
            flex-direction: column;
        }
        #story-text-input {
            background: transparent; border: none; outline: none;
            color: white; font-size: 30px; font-weight: 900;
            text-align: center; width: 80%; border-bottom: 2px solid white;
            padding-bottom: 10px; font-family: 'Roboto', sans-serif;
        }
        .text-editor-actions { margin-top: 20px; display: flex; gap: 20px; }
        .te-btn { padding: 10px 20px; border-radius: 8px; border:none; font-weight:bold; cursor:pointer; }
        
        #story-viewer-screen {
            background: black; z-index: 3000;
        }
        .story-bars-container {
            position: absolute; top: 10px; left: 5px; right: 5px;
            display: flex; gap: 4px; z-index: 10;
        }
        .story-progress-bar {
            height: 2px; flex: 1; background: rgba(255,255,255,0.3);
            border-radius: 2px; overflow: hidden;
        }
        .story-progress-fill {
            height: 100%; width: 0%; background: white;
        }
        .story-header {
            position: absolute; top: 20px; left: 0; width: 100%;
            padding: 10px 15px; display: flex; align-items: center;
            color: white; z-index: 10;
        }
        .story-menu-btn {
            margin-left: auto; font-size: 20px; cursor: pointer; padding: 10px;
        }
        .close-friend-badge-story {
            background: var(--green); color: black; font-size: 10px;
            padding: 2px 6px; border-radius: 4px; font-weight: 900;
            margin-left: 10px; font-family: 'Orbitron';
        }
        #story-menu-dropdown {
            position: absolute; top: 60px; right: 15px;
            background: rgba(30,30,30,0.95); backdrop-filter: blur(10px);
            border-radius: 12px; padding: 5px 0; display: none; z-index: 20;
            min-width: 150px; border: 1px solid #444;
        }
        .story-menu-item {
            padding: 12px 20px; color: white; font-size: 14px; font-weight: 600;
            cursor: pointer; border-bottom: 1px solid #333;
        }
        .story-menu-item:last-child { border-bottom: none; color: #ff5252; }
        
        .story-viewer-content {
            width: 100%; height: 100%; display: flex;
            align-items: center; justify-content: center;
        }
        #sv-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        #sv-video { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        .swipe-up-hint {
            position: absolute; bottom: 20px; width: 100%;
            text-align: center; color: white; font-size: 12px;
            font-weight: 600; animation: bounceUp 1.5s infinite;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
        }
        
        #story-stats-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%;
            height: 50%; background: white; border-radius: 20px 20px 0 0;
            z-index: 25; transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column;
        }
        #story-stats-sheet.open { transform: translateY(0); }
        .stats-header { padding: 15px; border-bottom: 1px solid #eee; text-align: center; font-weight: 800; font-family: 'Orbitron'; }
        .stats-list { flex: 1; overflow-y: auto; padding: 0 10px; }
        .stat-item { padding: 12px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f9f9f9; }

        #share-profile-screen {
            background: linear-gradient(135deg, #111 0%, #222 100%);
            z-index: 2500; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            color: white;
        }
        .qr-card {
            background: white; border-radius: 20px;
            padding: 30px; display: flex; flex-direction: column;
            align-items: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            width: 85%; max-width: 320px; margin-bottom: 30px;
            position: relative; margin-top: 40px;
        }
        .qr-avatar {
            position: absolute; top: -40px; left: 50%; transform: translateX(-50%);
            width: 80px; height: 80px; border-radius: 50%;
            background: #fff; border: 4px solid var(--accent);
            display: flex; justify-content: center; align-items: center;
            font-size: 35px; color: #333; z-index: 2;
            overflow: hidden;
        }
        .qr-name { font-size: 20px; font-weight: 900; color: #111; margin-top: 40px; margin-bottom: 20px; font-family: 'Orbitron'; }
        
        #qrcode-container { padding: 10px; background: white; border: 1px solid #eee; border-radius: 10px; position: relative; }
        #qrcode-container img { margin: 0 auto; }

        .qr-overlay-icon {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 40px; height: 40px;
            background: white;
            border: 3px solid white;
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            z-index: 10;
            color: black;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .short-id-label { font-size: 11px; color: #888; font-weight: 700; margin-top: 20px; text-transform: uppercase; letter-spacing: 1px; }
        .short-id-display { font-size: 28px; font-weight: 900; color: var(--accent); font-family: 'Roboto Mono', monospace; letter-spacing: 3px; margin-top: 5px; }
        
        .share-btn-large {
            width: 85%; max-width: 320px; padding: 15px;
            background: var(--accent); color: white;
            border: none; border-radius: 12px;
            font-weight: 800; font-family: 'Orbitron'; font-size: 16px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 4px 15px rgba(211, 47, 47, 0.4);
        }
        .share-btn-large:active { transform: scale(0.95); }

        #creator-screen {
            background: white; z-index: 600;
        }
        .creator-container { padding: 20px; overflow-y: auto; }
        .creator-avatar { width: 100px; height: 100px; border-radius: 50%; background: #f0f0f0; margin: 0 auto 15px; display:flex; justify-content:center; align-items:center; font-size:40px; color:#555; border: 3px solid var(--accent); overflow:hidden;}
        .creator-name { font-size: 22px; font-weight: 900; text-align: center; font-family: 'Orbitron'; color: #222; margin-bottom: 25px; }
        
        .creator-form-group { margin-bottom: 20px; }
        .creator-label { font-size: 13px; font-weight: 800; color: #666; font-family: 'Orbitron'; display: block; margin-bottom: 8px; }
        .creator-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; background: #f9f9f9; font-size: 16px; font-weight: 600; outline:none; }
        .creator-input:focus { border-color: var(--accent); background: white; }

        .creator-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 10px; }
        .creator-card { 
            background: #f5f5f5; border-radius: 12px; padding: 20px; text-align: center; 
            cursor: pointer; border: 2px solid transparent; transition: all 0.2s;
        }
        .creator-card:active { transform: scale(0.95); }
        .creator-card.selected { border-color: var(--accent); background: #fff0f0; }
        .creator-card i { font-size: 30px; margin-bottom: 10px; display: block; }

        .fa-youtube { color: #FF0000; }
        .fa-instagram { color: #E1306C; }
        .fa-facebook { color: #4267B2; }
        .fa-user-ninja { color: var(--accent); }

        .setting-item { display: flex; align-items: center; padding: 18px 20px; border-bottom: 1px solid #f5f5f5; cursor: pointer; transition: background 0.2s; }
        .setting-item:active { background: #fafafa; }
        
        .setting-icon-box {
            width: 42px; height: 42px; border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            font-size: 18px; margin-right: 15px;
        }
        
        .si-privacy { background: #e3f2fd; color: #1976d2; }
        .si-block { background: #ffebee; color: #d32f2f; }
        .si-channel { background: #f3e5f5; color: #7b1fa2; }
        .si-pocket { background: #fff8e1; color: #ffa000; }
        .si-group { background: #e0f2f1; color: #00897b; }
        .si-sound { background: #fce4ec; color: #c2185b; }
        
        /* NEW THEME ICON STYLE */
        .si-theme { background: #1a1a1a; color: var(--gold); border: 1px solid #333; }

        .setting-label { font-size: 15px; font-weight: 600; color: #444; flex: 1; font-family: 'Roboto', sans-serif; }
        .setting-arrow { color: #ccc; font-size: 12px; }

        .settings-logout-btn {
            background: linear-gradient(135deg, #ff1744, #d32f2f);
            color: white;
            padding: 15px 40px;
            border-radius: 50px;
            font-family: 'Orbitron';
            font-weight: 900;
            border: 2px solid white;
            box-shadow: 0 10px 25px rgba(211, 47, 47, 0.4);
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 40px auto 20px;
            width: 80%;
        }
        .settings-logout-btn:active { transform: scale(0.95); }

        /* --- NEW CHAT SCREEN REDESIGN --- */
        #new-chat-screen {
            background: #f8f9fa; /* Lighter, clean background */
            z-index: 500;
            display: none;
            flex-direction: column;
            animation: slideUp 0.3s ease-out;
        }

        .nc-container {
            padding: 20px;
        }

        /* Top Grid for Quick Actions */
        .nc-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .nc-action-card {
            background: white;
            border-radius: 16px;
            padding: 15px 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .nc-action-card:active { transform: scale(0.95); }

        /* Smooth Squircle Icons with 3D Effect */
        .nc-icon-box {
            width: 50px; height: 50px;
            border-radius: 18px; /* Squircle */
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: white;
            margin-bottom: 8px;
            box-shadow: 0 8px 15px rgba(0,0,0,0.15); /* Soft Shadow */
            position: relative;
            overflow: hidden;
        }
        
        /* Glossy shine */
        .nc-icon-box::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 50%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.3), transparent);
        }

        .nc-icon-ai { background: linear-gradient(135deg, #6C5CE7, #a29bfe); }
        .nc-icon-group { background: linear-gradient(135deg, #00b894, #55efc4); }
        .nc-icon-scan { background: linear-gradient(135deg, #FF7675, #fab1a0); }

        .nc-label-text { font-size: 11px; font-weight: 700; color: #555; text-align: center; font-family: 'Orbitron'; letter-spacing: 0.5px; }

        /* Contact List Styling */
        .nc-section-title {
            font-size: 13px; font-weight: 900; color: #999; 
            margin-bottom: 15px; font-family: 'Orbitron'; letter-spacing: 1px;
        }

        .nc-contact-row {
            display: flex; align-items: center;
            padding: 12px 15px;
            background: white;
            border-radius: 16px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            transition: transform 0.2s;
            opacity: 0; /* Hidden initially for animation */
            transform: translateY(20px);
        }
        .nc-contact-row:active { transform: scale(0.98); background: #fafafa; }
        
        .nc-contact-avatar {
            width: 45px; height: 45px; border-radius: 14px; /* Squircle avatar */
            background: #f0f0f0; margin-right: 15px;
            display: flex; justify-content: center; align-items: center;
            color: #555; font-size: 18px; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .nc-contact-info h4 { margin: 0; font-size: 15px; font-weight: 700; color: #333; }
        .nc-contact-info p { margin: 2px 0 0 0; font-size: 11px; color: #888; }
        
        .nc-add-icon { 
            width: 35px; height: 35px; 
            background: #f5f5f5; border-radius: 10px; 
            display: flex; justify-content: center; align-items: center;
            color: var(--accent); margin-left: auto;
        }

        /* Staggered Animation Class */
        .slide-in-up { animation: slideInUp 0.4s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- MODERN POCKET STYLES --- */
        .pocket-fab {
            position: absolute; bottom: 80px; right: 20px;
            width: 50px; height: 50px;
            background: var(--gold);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 100; cursor: pointer; color: black; font-size: 20px;
            border: 2px solid white;
        }

        .modern-pocket-header {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
            padding: 20px 20px 60px 20px;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            color: white;
            box-shadow: 0 10px 30px rgba(211, 47, 47, 0.25);
            position: relative;
            margin-bottom: 20px;
        }

        .mp-nav {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; margin-top: 10px;
        }

        .mp-storage-circle {
            width: 140px; height: 140px;
            border-radius: 50%;
            border: 8px solid rgba(255,255,255,0.15);
            border-top: 8px solid white;
            display: flex; justify-content: center; align-items: center;
            margin: 0 auto;
            transform: rotate(-45deg); 
            animation: spinLoad 1.5s ease-out;
        }
        
        .mp-inner-circle {
            width: 110px; height: 110px;
            border-radius: 50%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            transform: rotate(45deg); 
        }
        .mp-inner-circle span { font-size: 28px; font-weight: 900; font-family: 'Orbitron'; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .mp-inner-circle small { font-size: 10px; opacity: 0.8; font-weight: 700; letter-spacing: 1px; }

        .mp-storage-text {
            text-align: center; margin-top: 15px;
            font-size: 14px; font-weight: 700; opacity: 0.9;
            letter-spacing: 0.5px;
        }

        .mp-grid-container {
            padding: 0 20px;
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 15px; margin-top: -40px; /* Overlap header */
            position: relative; z-index: 5;
        }

        .mp-card {
            background: white; border-radius: 20px;
            padding: 20px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            transition: transform 0.2s;
            cursor: pointer;
        }
        .mp-card:active { transform: scale(0.95); }

        .mp-icon-box {
            width: 55px; height: 55px;
            border-radius: 16px;
            display: flex; justify-content: center; align-items: center;
            font-size: 22px; color: white; margin-bottom: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .mp-blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .mp-purple { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }
        .mp-orange { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); }
        .mp-teal { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

        .mp-card-title { font-size: 15px; font-weight: 800; color: #333; margin-bottom: 2px; }
        .mp-card-sub { font-size: 11px; color: #999; font-weight: 600; }

        .mp-vip-banner {
            margin: 20px;
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
            border-radius: 16px; padding: 15px;
            display: flex; align-items: center; gap: 15px;
            color: white; cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border: 1px solid #444;
        }
        .mp-vip-icon {
            width: 40px; height: 40px; background: rgba(255,215,0,0.2);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            color: var(--gold); font-size: 18px; border: 1px solid rgba(255,215,0,0.3);
        }
        .mp-vip-text b { display: block; font-size: 14px; margin-bottom: 2px; }
        .mp-vip-text span { font-size: 11px; color: #aaa; }
        .mp-vip-banner i.fa-chevron-right { margin-left: auto; color: #666; font-size: 12px; }

        .insta-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            padding: 2px; 
        }
        .insta-item { 
            aspect-ratio: 1 / 1;
            position: relative; 
            background: #eee; 
            cursor: pointer; 
            overflow: hidden;
        }
        .insta-item img, .insta-item video { 
            width: 100%; height: 100%; 
            object-fit: cover;
        }
        .insta-vid-icon {
            position: absolute; top: 5px; right: 5px; color: white; font-size: 12px; text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        /* --- UPDATED CALL OVERLAY STYLES --- */
        /* Connecting State: Local Video Full Screen */
        #call-overlay.connecting #local-video { 
            width: 100% !important; 
            height: 100% !important; 
            top: 0 !important; 
            left: 0 !important; 
            z-index: 1; 
            border-radius: 0; 
            border: none;
        }
        #call-overlay.connecting #remote-video { display: none; }

        /* Connected State: Default PiP Style (Small) */
        #call-overlay.connected #local-video { 
            position: absolute; 
            top: 20px; right: 20px; 
            width: 90px; height: 135px; /* Minimalist Size */
            background: #222; 
            border-radius: 12px; 
            object-fit: cover; 
            z-index: 201; 
            display: block; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); 
            border: 1px solid rgba(255,255,255,0.2); 
            touch-action: none;
            transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), height 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* Only transition size, drag handles position */
        }

        /* Connected State + UI Active: PiP slightly larger */
        #call-overlay.connected.ui-active #local-video {
            width: 110px; height: 160px; /* Standard PiP Size */
        }

        /* --- NEW MODERN THEME SCREEN STYLES --- */
        #theme-screen { 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
            z-index: 600; display: none; flex-direction: column; 
        }
        .theme-header-modern {
            padding: 20px; text-align: center;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .theme-preview-card {
            background: white;
            border-radius: 20px;
            margin: 0 20px;
            padding: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 10px;
            position: relative; overflow: hidden;
            border: 1px solid rgba(255,255,255,0.5);
        }
        .theme-preview-card::before {
            content: ''; position: absolute; top:0; left:0; width:100%; height: 6px; 
            background: var(--accent);
        }
        
        .theme-picker-scroll {
            padding: 20px; overflow-y: auto; flex: 1;
        }
        
        .theme-section-title {
            font-size: 13px; font-weight: 900; color: #555;
            margin: 20px 0 15px; font-family: 'Orbitron'; letter-spacing: 1px;
            text-transform: uppercase; display: flex; align-items: center; gap: 10px;
        }
        .theme-section-title::after { content:''; flex:1; height:1px; background:#ddd; }

        .color-grid-modern {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;
        }
        .color-bubble {
            aspect-ratio: 1/1; border-radius: 50%; cursor: pointer;
            position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 3px solid white;
        }
        .color-bubble:active { transform: scale(0.9); }
        .color-bubble.selected {
            transform: scale(1.15);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border-color: white;
            z-index: 2;
        }
        /* Checkmark overlay for selected bubble */
        .color-bubble.selected::after {
            content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 18px; text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* Theme Colors */
        .bg-red { background: linear-gradient(135deg, #ff5252, #d32f2f); }
        .bg-blue { background: linear-gradient(135deg, #448aff, #2979ff); }
        .bg-green { background: linear-gradient(135deg, #69f0ae, #00e676); }
        .bg-purple { background: linear-gradient(135deg, #b388ff, #7c4dff); }
        .bg-gold { background: linear-gradient(135deg, #ffd740, #ffc107); }
        .bg-pink { background: linear-gradient(135deg, #ff80ab, #f50057); }
        .bg-teal { background: linear-gradient(135deg, #64ffda, #1de9b6); }
        .bg-orange { background: linear-gradient(135deg, #ffab40, #ff9100); }
        .bg-dark { background: linear-gradient(135deg, #424242, #212121); }
        .bg-cyan { background: linear-gradient(135deg, #18ffff, #00e5ff); }
        .bg-lime { background: linear-gradient(135deg, #ccff90, #76ff03); }
        .bg-indigo { background: linear-gradient(135deg, #536dfe, #304ffe); }

        .btn-apply-theme {
            width: 100%; padding: 18px; 
            background: var(--accent); color: white; 
            border: none; border-radius: 16px; 
            font-size: 16px; font-weight: 900; 
            font-family: 'Orbitron'; cursor: pointer; 
            margin-top: 30px; margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        .btn-apply-theme:active { transform: scale(0.95); }

        /* --- NEW CHAT DETAILS SCREEN STYLES --- */
        #chat-detail-screen {
            background: #ffffff;
            z-index: 300;
            display: none; flex-direction: column;
        }
        .cd-container { padding: 0; }
        
        .cd-header {
            display: flex; flex-direction: column; align-items: center;
            padding: 30px 20px 20px 20px;
            background: #fff;
            border-bottom: 1px solid #f9f9f9;
        }
        .cd-avatar {
            width: 100px; height: 100px; border-radius: 50%;
            background: #f0f0f0; margin-bottom: 15px;
            display: flex; justify-content: center; align-items: center;
            font-size: 40px; color: #555;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .cd-name {
            font-size: 22px; font-weight: 900; color: #222;
            font-family: 'Orbitron'; margin-bottom: 5px;
            text-align: center;
        }
        .cd-sub {
            font-size: 13px; color: #888; font-weight: 600;
        }

        .cd-btn-row {
            display: flex; justify-content: center; gap: 30px;
            margin: 20px 0 30px 0; width: 100%;
        }
        .cd-btn-col {
            display: flex; flex-direction: column; align-items: center;
            gap: 8px; cursor: pointer;
        }
        .cd-btn-circle {
            width: 50px; height: 50px; border-radius: 50%;
            background: #f0f0f0; display: flex;
            justify-content: center; align-items: center;
            font-size: 20px; color: #333;
            transition: transform 0.2s, background 0.3s;
        }
        .cd-btn-circle:active { transform: scale(0.9); }
        .cd-btn-label { font-size: 11px; font-weight: 700; color: #555; }
        
        .cd-section-title {
            padding: 10px 20px; font-size: 13px; font-weight: 800; 
            color: #999; font-family: 'Orbitron'; 
            text-transform: uppercase; letter-spacing: 1px;
            background: #fff; margin-top: 10px;
        }
        
        .cd-media-grid {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 2px; padding: 2px;
        }
        .cd-grid-item {
            aspect-ratio: 1 / 1;
            background: #eee;
            position: relative; cursor: pointer;
            overflow: hidden;
        }
        .cd-grid-item img, .cd-grid-item video {
            width: 100%; height: 100%; object-fit: cover;
        }
        .cd-vid-icon {
            position: absolute; top: 5px; right: 5px; color: white;
            font-size: 12px; text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .cd-members-btn {
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px 20px; background: white;
            font-weight: 700; cursor: pointer;
            border-bottom: 1px solid #f0f0f0; color: #333;
        }

        /* --- BLOCKED USERS SCREEN STYLES --- */
        #blocked-users-screen {
            background: #f9f9f9; z-index: 400; display: none; flex-direction: column;
        }
        .blocked-list { padding: 20px; }
        .blocked-card {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }
        .blocked-info { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .unblock-btn {
            padding: 8px 16px; background: #e0f2f1; color: #00897b;
            border: none; border-radius: 20px; font-weight: 700; font-size: 11px;
            cursor: pointer; text-transform: uppercase;
        }

        /* --- PINNED ITEMS SHEET (SLIDER) --- */
        #pinned-sheet-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 350; display: none;
            backdrop-filter: blur(2px);
        }
        #pinned-sheet {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; border-radius: 20px 20px 0 0;
            padding: 20px; z-index: 351;
            transform: translateY(100%); transition: transform 0.3s ease-out;
            max-height: 70vh; display: flex; flex-direction: column;
        }
        #pinned-sheet.open { transform: translateY(0); }
        .sheet-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; font-weight: 800; font-family: 'Orbitron';
        }
        .sheet-content { flex: 1; overflow-y: auto; }
        .pinned-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;
        }

        /* --- CHAT WALLPAPER SCREEN CSS --- */
        #chat-wallpaper-screen {
            background: #f4f4f4; z-index: 400; display: none; flex-direction: column;
        }
        .wallpaper-section { padding: 20px; }
        .wallpaper-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
        }
        .wallpaper-option {
            aspect-ratio: 9/16; border-radius: 10px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 2px solid transparent;
            overflow: hidden; position: relative;
        }
        .wallpaper-option.selected { border-color: var(--accent); transform: scale(0.95); }
        .wallpaper-thumb { width: 100%; height: 100%; object-fit: cover; }
        
        .wallpaper-upload {
            background: #ddd; display: flex; justify-content: center; align-items: center;
            flex-direction: column; color: #555; font-size: 24px;
        }
        .wall-section-title {
            font-size: 14px; font-weight: 800; color: #777; margin: 20px 0 10px;
            font-family: 'Orbitron'; text-transform: uppercase;
        }

        /* --- WALLPAPER PREVIEW SCREEN --- */
        #wallpaper-preview-screen {
            background: #000; z-index: 410; display: none; flex-direction: column;
        }
        .wp-preview-chat-body {
            flex: 1; 
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat;
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center;
            padding: 20px;
            position: relative;
        }
        .wp-preview-fake-msg {
            background: white; padding: 10px 15px; border-radius: 12px;
            max-width: 80%; margin-bottom: 10px; font-size: 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            align-self: flex-start;
        }
        .wp-preview-fake-msg.me {
            background: var(--accent); color: white; align-self: flex-end;
        }
        .wp-btn-container {
            padding: 20px; background: black; display: flex; justify-content: center;
        }
        .btn-apply-wall {
            width: 100%; padding: 15px; background: var(--accent); color: white;
            border: none; border-radius: 12px; font-weight: 900; cursor: pointer;
            font-family: 'Orbitron'; font-size: 16px;
        }

        /* --- NEW VIP LANDING PAGE STYLE --- */
        #vip-landing-screen {
            background: #f4f7f6; z-index: 1000;
            display: none; flex-direction: column;
            padding: 0;
        }
        .vip-landing-header {
            padding: 40px 20px 20px; text-align: center;
            background: linear-gradient(135deg, #fff, #f0f0f0);
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        .vl-title {
            font-family: 'Orbitron'; font-size: 24px; font-weight: 900; 
            color: #333; margin-bottom: 10px; letter-spacing: 1px;
        }
        .vl-title span { color: var(--accent); }
        .vl-trial-badge {
            display: inline-block; padding: 8px 15px; 
            background: linear-gradient(45deg, var(--gold), #ffb300);
            color: black; font-weight: 800; border-radius: 20px;
            font-size: 12px; font-family: 'Orbitron'; 
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }
        .comparison-container {
            flex: 1; padding: 20px; overflow-y: auto;
        }
        .comp-card {
            background: white; border-radius: 16px; 
            padding: 20px; margin-bottom: 20px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }
        .comp-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px 0; border-bottom: 1px solid #f9f9f9;
        }
        .comp-row.header { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 5px; }
        .comp-col-feat { flex: 1; font-weight: 700; color: #555; font-size: 14px; text-align: left; }
        .comp-col-status { width: 60px; text-align: center; font-size: 16px; }
        .status-free { color: #ccc; font-size: 18px; }
        .status-vip { 
            color: var(--gold); background: #333; width: 24px; height: 24px; 
            border-radius: 50%; display: inline-flex; justify-content: center; align-items: center; 
            font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .vl-footer {
            padding: 20px; background: white;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        .btn-upgrade-landing {
            width: 100%; padding: 16px; 
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            color: white; border: none; border-radius: 12px;
            font-weight: 900; font-family: 'Orbitron'; font-size: 16px;
            cursor: pointer; letter-spacing: 1px;
            box-shadow: 0 5px 20px rgba(211, 47, 47, 0.4);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }

        /* UNIQUE PREMIUM REACTION POPOVER STYLES */
        .reaction-popover {
            position: fixed; /* FIXED POSITION FOR VISIBILITY */
            background: rgba(20, 20, 20, 0.95); /* Dark Premium Look */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 50px; /* Pill shape */
            padding: 10px 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            z-index: 9999; /* TOP Z-INDEX */
            opacity: 0;
            border: 1px solid rgba(255,255,255,0.15); /* Subtle white border */
            animation: bounceInReaction 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .rp-emoji { 
            font-size: 28px; /* Larger Emojis */
            cursor: pointer; 
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.3)); 
        }

        .rp-emoji:hover { 
            transform: scale(1.4) translateY(-8px); 
        }

        .rp-emoji:active { 
            transform: scale(0.9); 
        }

        @keyframes bounceInReaction {
            0% { transform: scale(0.5) translateY(20px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }

        /* --- STICKER PICKER STYLES --- */
        #sticker-picker {
            position: absolute;
            bottom: 75px; 
            left: 10px; right: 10px;
            margin: 0 auto;
            width: 95%;
            max-width: 360px;
            height: 250px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            transform-origin: bottom left;
            transform: scale(0);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 200;
            pointer-events: none;
            border: 1px solid rgba(255,255,255,0.5);
            overflow-y: auto;
        }
        #sticker-picker.open {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        
        .ninja-sticker-btn {
            aspect-ratio: 1/1;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            transition: transform 0.1s;
            background: rgba(0,0,0,0.03);
            border-radius: 12px;
        }
        .ninja-sticker-btn:active { transform: scale(0.9); background: rgba(0,0,0,0.1); }
        .ninja-sticker-btn svg {
            width: 80%; height: 80%;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));
        }

        /* NEW STICKER BTN (LEFT) */
        .emoji-btn {
            width: 34px; height: 34px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 50%;
            transition: transform 0.2s;
            margin-bottom: 2px;
        }
        .emoji-btn svg { width: 22px; height: 22px; fill: #54656f; transition: fill 0.3s; }
        .emoji-btn:active { transform: scale(0.9); }
        .emoji-btn:active svg { fill: var(--accent); }

        .msg.sticker-msg {
            background: transparent !important;
            box-shadow: none !important;
            padding: 0;
            border: none;
        }

        /* --- NEW MODERN WALLET CSS (UPDATED) --- */
        #wallet-screen {
            background: linear-gradient(180deg, #f0f2f5 0%, #eef1f5 100%); 
            z-index: 700;
            display: none; 
            flex-direction: column;
        }
        
        .wallet-upi-header {
            display: flex; justify-content: center; margin-top: 20px; margin-bottom: 10px;
        }
        .upi-icon-badge {
            width: 40px; height: 40px; background: white; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex;
            align-items: center; justify-content: center;
            font-size: 18px; color: #333; border: 1px solid #eee;
        }

        /* Glassmorphism/Neumorphism Hybrid Card */
        .modern-wallet-card {
            background: #ffffff;
            border-radius: 24px;
            margin: 10px 20px 30px 20px;
            padding: 30px 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.08), 0 5px 15px rgba(0,0,0,0.03); 
            position: relative;
            overflow: hidden;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.8);
        }
        
        .modern-wallet-card::before {
            content: ''; position: absolute; top: -50px; right: -50px;
            width: 150px; height: 150px; background: var(--accent);
            opacity: 0.05; border-radius: 50%; filter: blur(40px);
        }
        
        .modern-balance-label {
            font-size: 12px; font-weight: 700; color: #999;
            letter-spacing: 1px; text-transform: uppercase;
            position: relative; z-index: 2;
        }
        
        .modern-balance-amount {
            font-size: 48px; font-weight: 900; 
            color: #333; margin: 10px 0; 
            font-family: 'Roboto', sans-serif;
            position: relative; z-index: 2; letter-spacing: -1px;
        }
        
        .currency-symbol {
            color: var(--accent);
            vertical-align: top; font-size: 24px; margin-top: 10px; display: inline-block;
        }
        
        .wallet-quick-actions {
            display: flex; gap: 25px; 
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .wa-btn {
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            cursor: pointer;
        }
        .wa-btn:active .wa-icon { transform: scale(0.95); }
        
        .wa-icon {
            width: 55px; height: 55px; border-radius: 18px; /* Squircle */
            background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; transition: transform 0.2s; border: 1px solid #f9f9f9;
        }
        
        .wa-add i { color: #00e676; }
        .wa-withdraw i { color: #ff5252; }
        .wa-send i { color: #2979ff; }
        
        .wa-label { font-size: 12px; font-weight: 700; color: #555; }

        .trans-header {
            padding: 0 20px; margin-bottom: 15px; font-size: 14px; font-weight: 800; color: #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        .trans-list { padding: 0 20px; }
        .trans-item {
            display: flex; align-items: center; padding: 15px;
            background: white; border-radius: 16px; margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .ti-icon {
            width: 40px; height: 40px; border-radius: 12px; background: #f5f5f5;
            display: flex; justify-content: center; align-items: center; margin-right: 15px;
            font-size: 16px; color: #555;
        }
        .ti-info h4 { margin: 0; font-size: 14px; font-weight: 700; }
        .ti-info p { margin: 2px 0 0 0; font-size: 11px; color: #999; }
        .ti-amt { margin-left: auto; font-weight: 800; font-size: 14px; }
        .ti-amt.neg { color: #333; }
        .ti-amt.pos { color: #00c853; }

        /* UPLOAD SPINNER OVERLAY */
        .msg-upload-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; flex-direction: column;
            justify-content: center; align-items: center; border-radius: 10px; z-index: 5;
        }
        .msg-upload-spinner {
            width: 30px; height: 30px; border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white; border-radius: 50%; animation: spin 1s linear infinite;
        }
        .msg-upload-size {
            color: white; font-size: 10px; font-weight: bold; margin-top: 5px; font-family: 'Roboto';
        }

        /* --- QR SCANNER SCREEN CSS --- */
        #qr-scanner-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 3000;
            display: none; flex-direction: column; align-items: center;
        }
        .qr-scan-header {
            position: absolute; top: 20px; left: 20px;
            color: white; z-index: 10; display: flex; align-items: center; gap: 15px;
            font-family: 'Orbitron'; font-weight: 900; letter-spacing: 1px;
        }
        .qr-scan-header i { font-size: 24px; cursor: pointer; }
        
        #qr-reader {
            width: 100%; height: 100%; object-fit: cover;
        }
        
        .qr-overlay-guides {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 250px; height: 250px;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 0 0 100vmax rgba(0,0,0,0.7);
            pointer-events: none;
        }
        .guide-corner {
            position: absolute; width: 30px; height: 30px;
            border: 4px solid var(--accent);
        }
        .tl { top: -2px; left: -2px; border-right: none; border-bottom: none; }
        .tr { top: -2px; right: -2px; border-left: none; border-bottom: none; }
        .bl { bottom: -2px; left: -2px; border-right: none; border-top: none; }
        .br { bottom: -2px; right: -2px; border-left: none; border-top: none; }
        
        .qr-scan-line {
            width: 100%; height: 2px; background: var(--green);
            position: absolute; top: 0;
            box-shadow: 0 0 10px var(--green);
            animation: scanLine 2s infinite linear;
        }
        @keyframes scanLine {
            0% { top: 0; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        
        .qr-instruction {
            position: absolute; bottom: 50px; color: white;
            font-size: 12px; font-weight: 500; letter-spacing: 1px;
            text-transform: uppercase; text-align: center; width: 100%;
        }

    </style>
</head>
<body>

    <!-- MAINTENANCE SCREEN -->
    <div id="maintenance-screen">
        <i class="fa-solid fa-triangle-exclamation maint-icon"></i>
        <div class="maint-title">SYSTEM OFFLINE</div>
        <div class="maint-desc">The Ninja Chat Dojo is currently undergoing critical maintenance. All communication channels are temporarily closed.</div>
        <div class="maint-badge">ESTIMATED RETURN: SOON</div>
    </div>

    <!-- BAN SCREEN -->
    <div id="ban-screen">
        <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
            <i class="fa-solid fa-user-lock ban-icon-main"></i>
            <div class="ban-header">USER SUSPENDED FROM NINJA CHAT</div>
            <div class="ban-title-big">BAN</div>
            <i class="fa-solid fa-shield-halved ban-shield"></i>
            <div style="font-size:12px; color:#666; margin-bottom:30px; max-width:250px;">
                Your account has been flagged for violating our community guidelines. Contact support for more info.
            </div>
        </div>
        <button class="ban-logout-btn" onclick="logout()">
            <i class="fa-solid fa-right-from-bracket"></i> LOG OUT
        </button>
    </div>

    <!-- SPLASH SCREEN -->
    <div id="splash-screen">
        <div class="splash-content" style="text-align: center;">
            <i class="fa-solid fa-user-secret splash-logo"></i>
            <div class="splash-title"><span class="ninja-font">Ninja</span> <span class="ninja-font text-red">Chat</span></div>
            <div class="splash-bar-container"><div class="splash-bar-fill"></div></div>
            <div class="splash-text">Loading Dojo...</div>
        </div>
        <div class="splash-footer">
            <div class="secure-badge"><i class="fa-solid fa-shield-halved"></i> 100% SECURE</div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast-box">Notification</div>

    <!-- ONLINE NOTIFICATION -->
    <div id="online-notify" onclick="handleOnlineNotifyClick()">
        <div class="on-notif-avatar">
            <i class="fa-solid fa-user-ninja"></i>
            <i class="fa-solid fa-bolt on-notif-icon"></i>
        </div>
        <div class="on-notif-info">
            <h4 id="on-notif-name">Ninja Name</h4>
            <p>IS ONLINE NOW</p>
        </div>
    </div>

    <!-- CUSTOM UNIQUE MODAL -->
    <div id="custom-modal-overlay">
        <div class="custom-modal">
            <div class="modal-body">
                <div class="modal-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
                <div class="modal-title" id="modal-title">Alert</div>
                <div class="modal-text" id="modal-text">Are you sure?</div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeCustomModal()">Cancel</button>
                <button class="modal-btn confirm" id="modal-confirm-btn">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- DELETE OPTIONS MODAL -->
    <div id="delete-modal-overlay">
        <div class="custom-modal">
            <div class="modal-body">
                <div class="modal-icon"><i class="fa-solid fa-trash-can text-red"></i></div>
                <div class="modal-title">Delete Message?</div>
                <div class="modal-text">Choose deletion type:</div>
                <div id="delete-options-container"></div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="document.getElementById('delete-modal-overlay').style.display='none'">Cancel</button>
            </div>
        </div>
    </div>

    <!-- REPORT MODAL -->
    <div id="report-modal-overlay">
        <div class="custom-modal">
            <div class="modal-body">
                <div class="modal-icon"><i class="fa-solid fa-flag"></i></div>
                <div class="modal-title">Report User</div>
                <div class="modal-text">Please select a reason:</div>
                <button class="report-opt-btn" onclick="submitReport('Scam')">Scam</button>
                <button class="report-opt-btn" onclick="submitReport('Fraud')">Fraud</button>
                <button class="report-opt-btn" onclick="submitReport('Other')">Other</button>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="document.getElementById('report-modal-overlay').style.display='none'">Cancel</button>
            </div>
        </div>
    </div>

    <!-- CUSTOM NAME MODAL -->
    <div id="custom-name-modal-overlay">
        <div class="custom-modal">
            <div class="modal-body">
                <div class="modal-icon"><i class="fa-solid fa-pen-nib"></i></div>
                <div class="modal-title">Set Custom VIP Name</div>
                <div class="modal-text">Name will be prefixed with #</div>
                <input type="text" id="custom-name-input" class="custom-name-input" placeholder="Enter VIP Name">
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="document.getElementById('custom-name-modal-overlay').style.display='none'">Cancel</button>
                <button class="modal-btn confirm" onclick="saveCustomName()">Save</button>
            </div>
        </div>
    </div>

    <!-- NEW VIP LANDING PAGE (MODERN) -->
    <div id="vip-landing-screen" class="screen">
        <div class="vip-landing-header">
            <i class="fa-solid fa-xmark" style="position: absolute; top: 20px; right: 20px; font-size: 24px; color: #666; cursor: pointer;" onclick="closeVipScreen()"></i>
            <div style="font-size:50px; color:var(--gold); margin-bottom:10px;"><i class="fa-solid fa-crown"></i></div>
            <div class="vl-title"><span>Ninja</span> VIP Upgrade</div>
            <div class="vl-trial-badge">7 DAY FREE TRIAL</div>
        </div>
        
        <div class="comparison-container">
            <div class="comp-card">
                <div class="comp-row header">
                    <span class="comp-col-feat" style="font-size:12px; color:#999; text-transform:uppercase;">Features</span>
                    <span class="comp-col-status" style="font-size:12px; color:#999; text-transform:uppercase;">Free</span>
                    <span class="comp-col-status" style="font-size:12px; color:#999; text-transform:uppercase; color:var(--gold);">VIP</span>
                </div>
                
                <div class="comp-row">
                    <span class="comp-col-feat"><i class="fa-solid fa-pen-nib" style="margin-right:8px; color:var(--accent);"></i> Customize App</span>
                    <span class="comp-col-status status-free"><i class="fa-solid fa-xmark"></i></span>
                    <span class="comp-col-status"><div class="status-vip"><i class="fa-solid fa-check"></i></div></span>
                </div>

                <div class="comp-row">
                    <span class="comp-col-feat"><i class="fa-solid fa-image" style="margin-right:8px; color:var(--accent);"></i> VIP Wallpapers</span>
                    <span class="comp-col-status status-free"><i class="fa-solid fa-xmark"></i></span>
                    <span class="comp-col-status"><div class="status-vip"><i class="fa-solid fa-check"></i></div></span>
                </div>

                <div class="comp-row">
                    <span class="comp-col-feat"><i class="fa-solid fa-palette" style="margin-right:8px; color:var(--accent);"></i> Custom Colors</span>
                    <span class="comp-col-status status-free"><i class="fa-solid fa-xmark"></i></span>
                    <span class="comp-col-status"><div class="status-vip"><i class="fa-solid fa-check"></i></div></span>
                </div>

                <div class="comp-row">
                    <span class="comp-col-feat"><i class="fa-solid fa-crown" style="margin-right:8px; color:var(--accent);"></i> VIP Badge</span>
                    <span class="comp-col-status status-free"><i class="fa-solid fa-xmark"></i></span>
                    <span class="comp-col-status"><div class="status-vip"><i class="fa-solid fa-check"></i></div></span>
                </div>

                <div class="comp-row" style="border-bottom:none;">
                    <span class="comp-col-feat"><i class="fa-solid fa-cloud" style="margin-right:8px; color:var(--accent);"></i> 100GB Cloud</span>
                    <span class="comp-col-status status-free"><i class="fa-solid fa-xmark"></i></span>
                    <span class="comp-col-status"><div class="status-vip"><i class="fa-solid fa-check"></i></div></span>
                </div>
            </div>
        </div>

        <div class="vl-footer">
            <button class="btn-upgrade-landing" onclick="goToPurchaseScreen()">
                UPGRADE NOW <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- VIP PURCHASE SCREEN (OLD SCREEN, NOW STEP 2) -->
    <div id="vip-purchase-screen" class="screen" style="background: linear-gradient(135deg, #111 0%, #222 100%); z-index: 1001; color: white; padding-bottom: 0;">
        <div style="padding: 20px; text-align: center;">
            <i class="fa-solid fa-arrow-left" style="position: absolute; top: 20px; left: 20px; font-size: 24px; color: #fff; cursor: pointer;" onclick="closeVipPurchase()"></i>
            <div style="font-size:40px; color:var(--gold); margin-top:10px;"><i class="fa-solid fa-crown"></i></div>
            <div style="font-family: 'Orbitron'; font-size: 24px; color: var(--gold); margin-bottom: 5px;">SELECT PLAN</div>
            <div style="font-size: 13px; color: #aaa; margin-bottom: 20px;">Unlock all VIP features instantly</div>
        </div>
        
        <div class="scroll-content">
            <div onclick="selectPlan('1 Week', '49')" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 16px; padding: 20px; margin: 0 20px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.2s;">
                <div class="plan-info">
                    <h3 style="margin: 0 0 5px 0; font-family: 'Orbitron'; font-size: 18px; color: white;">1 Week</h3>
                    <p style="margin: 0; font-size: 12px; color: #888;">Trial Access</p>
                </div>
                <div style="font-size: 24px; font-weight: 900; color: var(--gold); font-family: 'Orbitron';">49</div>
            </div>

            <div onclick="selectPlan('1 Month', '99')" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 16px; padding: 20px; margin: 0 20px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.2s; position:relative; overflow:hidden;">
                <div style="position: absolute; top: 0; right: 0; background: var(--accent); color: white; font-size: 10px; padding: 3px 8px; border-bottom-left-radius: 8px; font-weight: bold;">MOST POPULAR</div>
                <div class="plan-info">
                    <h3 style="margin: 0 0 5px 0; font-family: 'Orbitron'; font-size: 18px; color: white;">1 Month</h3>
                    <p style="margin: 0; font-size: 12px; color: #888;">Standard Access</p>
                </div>
                <div style="font-size: 24px; font-weight: 900; color: var(--gold); font-family: 'Orbitron';">99</div>
            </div>

            <div onclick="selectPlan('1 Year', '399')" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,215,0,0.2); border-radius: 16px; padding: 20px; margin: 0 20px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.2s; position:relative; overflow:hidden;">
                <div style="position: absolute; top: 0; right: 0; background: var(--gold); color: black; font-size: 10px; padding: 3px 8px; border-bottom-left-radius: 8px; font-weight: bold;">BEST VALUE</div>
                <div class="plan-info">
                    <h3 style="margin: 0 0 5px 0; font-family: 'Orbitron'; font-size: 18px; color: white;">1 Year</h3>
                    <p style="margin: 0; font-size: 12px; color: #888;">Ultimate Legend Status</p>
                </div>
                <div style="font-size: 24px; font-weight: 900; color: var(--gold); font-family: 'Orbitron';">399</div>
            </div>
            
            <div style="text-align:center; padding:20px; font-size:11px; color:#666;">
                Clicking a plan will open a chat with Support to complete payment.
            </div>
        </div>
    </div>

    <!-- CREATOR ACCOUNT SCREEN -->
    <div id="creator-screen" class="screen">
        <div class="chat-navbar">
            <div style="display:flex; align-items:center;">
                <div class="back-icon" onclick="closeCreatorScreen()"><i class="fa-solid fa-arrow-left"></i></div>
                <div class="room-title">Account Verification</div>
            </div>
        </div>
        <div class="scroll-content creator-container">
            <div class="creator-avatar" id="creator-screen-avatar">
                <i class="fa-solid fa-user-ninja"></i>
            </div>
            <div class="creator-name" id="creator-screen-name">User Name</div>

            <div class="creator-form-group">
                <label class="creator-label">FULL NAME</label>
                <input type="text" id="creator-real-name" class="creator-input" placeholder="Enter Full Name">
            </div>

            <div class="creator-form-group">
                <label class="creator-label">PHONE NUMBER</label>
                <input type="number" id="creator-phone" class="creator-input" placeholder="Enter Phone Number">
            </div>

            <div class="creator-form-group">
                <label class="creator-label">YOUR AGE</label>
                <input type="number" id="creator-age" class="creator-input" placeholder="Enter Age">
            </div>

            <div class="creator-form-group">
                <label class="creator-label">YOUR GENDER</label>
                <select id="creator-gender" class="creator-input">
                    <option>Male</option>
                    <option>Female</option>
                    <option>Other</option>
                </select>
            </div>

            <div class="creator-form-group">
                <label class="creator-label">WHICH CREATOR ARE YOU?</label>
                <div class="creator-grid">
                    <div class="creator-card" onclick="selectPlatform(this, 'YouTube')">
                        <i class="fa-brands fa-youtube"></i>
                        <span>YouTube</span>
                    </div>
                    <div class="creator-card" onclick="selectPlatform(this, 'Instagram')">
                        <i class="fa-brands fa-instagram"></i>
                        <span>Instagram</span>
                    </div>
                    <div class="creator-card" onclick="selectPlatform(this, 'Facebook')">
                        <i class="fa-brands fa-facebook"></i>
                        <span>Facebook</span>
                    </div>
                    <div class="creator-card selected" onclick="selectPlatform(this, 'Ninja Chat')">
                        <i class="fa-solid fa-user-ninja"></i>
                        <span>Ninja Chat</span>
                    </div>
                </div>
            </div>
            
            <button id="btn-verify-submit" class="btn-primary" style="margin-top:20px; background:var(--accent);" onclick="submitCreatorVerification()">SUBMIT VERIFICATION</button>
        </div>
    </div>


    <!-- FULL SCREEN PROFILE VIEW (UPDATED LAYOUT) -->
    <div id="view-profile-screen" class="screen">
        <div class="chat-navbar">
            <div style="display:flex; align-items:center;">
                <div class="back-icon" onclick="closeViewProfile()"><i class="fa-solid fa-arrow-left"></i></div>
                <div class="room-title">Ninja Profile</div>
            </div>
        </div>
        <div class="scroll-content vp-container">
            <div class="vp-header-modern">
                <div class="vp-avatar-modern" id="vp-avatar-disp">
                    <i class="fa-solid fa-user-ninja"></i>
                </div>
                <div class="vp-info-modern">
                    <div class="vp-name-modern" id="vp-name-disp">User Name</div>
                    <div class="vp-status-modern" id="vp-status-text">Public Account</div>
                </div>
            </div>
            
            <div class="vp-bio-modern" id="vp-bio-disp">Loading Bio...</div>

            <button id="vp-action-main-btn" class="vp-big-btn btn-add-action">
                <i class="fa-solid fa-user-plus"></i> Add Friend
            </button>
        </div>
    </div>

    <!-- NEW CHAT DETAILS SCREEN (INFO) -->
    <div id="chat-detail-screen" class="screen">
        <div class="chat-navbar">
            <div style="display:flex; align-items:center;">
                <div class="back-icon" onclick="closeChatDetails()"><i class="fa-solid fa-arrow-left"></i></div>
                <div class="room-title">Contact Info</div>
            </div>
        </div>
        <div class="scroll-content cd-container">
            <div class="cd-header">
                <div class="cd-avatar" id="cd-avatar-disp">
                    <i class="fa-solid fa-user-ninja"></i>
                </div>
                <div class="cd-name" id="cd-name-disp">User Name</div>
                <div class="cd-sub" id="cd-sub-disp">+00 000 000</div>

                <div class="cd-btn-row">
                    <div class="cd-btn-col" onclick="openPinnedSheet()">
                        <div class="cd-btn-circle" id="cd-pin-btn"><i class="fa-solid fa-thumbtack"></i></div>
                        <span class="cd-btn-label">Pin</span>
                    </div>
                    <!-- CHAT BACKGROUND BUTTON -->
                    <div class="cd-btn-col" onclick="openChatBackgroundSettings()">
                        <div class="cd-btn-circle"><i class="fa-regular fa-image"></i></div>
                        <span class="cd-btn-label">Chat Background</span>
                    </div>
                    <div class="cd-btn-col" id="cd-block-col" onclick="toggleChatBlock()">
                        <div class="cd-btn-circle" id="cd-block-btn" style="color:#d32f2f;"><i class="fa-solid fa-ban"></i></div>
                        <span class="cd-btn-label" style="color:#d32f2f;">Block</span>
                    </div>
                </div>
            </div>

            <!-- Group Members Option (Hidden by default) -->
            <div id="cd-members-option" class="cd-members-btn" style="display:none;" onclick="showGroupMembersList()">
                <span><i class="fa-solid fa-users" style="margin-right:10px; color:#888;"></i> Group Members</span>
                <i class="fa-solid fa-chevron-right" style="font-size:12px; color:#ccc;"></i>
            </div>

            <div class="cd-section-title">Media & Docs</div>
            <div class="cd-media-grid" id="cd-media-grid">
                <!-- Media Items will be injected here -->
            </div>
        </div>
    </div>

    <!-- CHAT WALLPAPER SCREEN -->
    <div id="chat-wallpaper-screen" class="screen">
        <div class="chat-navbar">
            <div style="display:flex; align-items:center;">
                <div class="back-icon" onclick="closeChatWallpaperScreen()"><i class="fa-solid fa-arrow-left"></i></div>
                <div class="room-title">Chat Background</div>
            </div>
        </div>
        <div class="scroll-content wallpaper-section">
            <div class="wall-section-title">Basic (30)</div>
            <div class="wallpaper-grid" id="basic-wall-grid"></div>

            <div class="wall-section-title"><i class="fa-solid fa-crown text-red"></i> VIP Unique (30)</div>
            <div class="wallpaper-grid" id="vip-wall-grid"></div>
        </div>
        <input type="file" id="wall-upload-input" style="display:none;" accept="image/*">
    </div>

    <!-- WALLPAPER PREVIEW SCREEN -->
    <div id="wallpaper-preview-screen" class="screen">
        <div class="chat-navbar" style="background:transparent; color:white; position:absolute; top:0; width:100%; border:none; z-index:10;">
            <div class="back-icon" onclick="closeWallpaperPreview()" style="color:white; background:rgba(0,0,0,0.3); border-radius:50%; width:35px; height:35px; justify-content:center;"><i class="fa-solid fa-arrow-left"></i></div>
            <div class="room-title" style="color:white; text-shadow:0 2px 4px rgba(0,0,0,0.5);">Preview</div>
            <div style="width:35px;"></div>
        </div>
        
        <div class="wp-preview-chat-body" id="wp-preview-body">
            <div class="wp-preview-fake-msg">Hello! This is a preview of your chat background.</div>
            <div class="wp-preview-fake-msg me">Looks awesome! Apply it now.</div>
        </div>
        
        <div class="wp-btn-container">
            <button class="btn-apply-wall" onclick="applyWallpaperFromPreview()">SET WALLPAPER</button>
        </div>
    </div>

    <!-- ACCOUNT SWITCHER SHEET (BOTTOM SHEET) -->
    <div id="account-switcher-overlay" onclick="closeAccountSwitcher()"></div>
    <div id="account-switcher-sheet">
        <div class="as-drag-handle"></div>
        <div class="as-header">Accounts</div>
        
        <div class="as-list" id="account-list-content">
            <!-- Account items injected via JS -->
        </div>

        <div style="border-top:1px solid #f0f0f0;">
            <div class="as-action-btn" onclick="handleAddAccount()">
                <i class="fa-solid fa-plus-circle"></i> Connect Another Account
            </div>
            <div class="as-action-btn" onclick="handleCreateAccount()">
                <i class="fa-solid fa-user-plus"></i> Create New Account
            </div>
        </div>
    </div>

    <!-- PINNED ITEMS SLIDER (BOTTOM SHEET) -->
    <div id="pinned-sheet-overlay" onclick="closePinnedSheet()"></div>
    <div id="pinned-sheet">
        <div class="sheet-header">
            <span>Pinned Media</span>
            <i class="fa-solid fa-xmark" onclick="closePinnedSheet()" style="cursor:pointer;"></i>
        </div>
        <div class="sheet-content">
            <div class="pinned-grid" id="pinned-grid-content">
                <!-- Pinned items here -->
            </div>
        </div>
    </div>

    <!-- BLOCKED USERS SCREEN -->
    <div id="blocked-users-screen" class="screen">
        <div class="chat-navbar">
            <div style="display:flex; align-items:center;">
                <div class="back-icon" onclick="closeBlockedUsersScreen()"><i class="fa-solid fa-arrow-left"></i></div>
                <div class="room-title">Blocked Users</div>
            </div>
        </div>
        <div class="scroll-content blocked-list" id="blocked-list-container">
            <!-- Blocked Users Injected Here -->
        </div>
    </div>

    <!-- CONTACT OPTIONS MODAL -->
    <div id="contact-options-modal" onclick="closeContactOptions()">
        <div class="options-content" onclick="event.stopPropagation()">
            <div class="options-header" id="opt-header-name">User Settings</div>
            <button class="opt-btn danger" onclick="handleBlockFromLongPress()"><i class="fa-solid fa-ban"></i> Block User</button>
            <button class="opt-btn" onclick="handleReport()"><i class="fa-solid fa-flag"></i> Report</button>
            <button id="btn-custom-name" class="opt-btn vip" onclick="handleCustomName()"><i class="fa-solid fa-pen-nib"></i> Custom Name</button>
            <button class="opt-btn danger" onclick="handleDeleteContact()"><i class="fa-solid fa-trash"></i> Delete Contact & Chat</button>
        </div>
    </div>

    <!-- GROUP OPTIONS MODAL -->
    <div id="group-options-modal" onclick="closeGroupOptions()">
        <div class="options-content" onclick="event.stopPropagation()">
            <div class="options-header" id="group-opt-header-name">Group Settings</div>
            <button class="opt-btn" onclick="handleReportGroup()"><i class="fa-solid fa-flag"></i> Report Group</button>
            <button class="opt-btn danger" onclick="confirmLeaveGroup()"><i class="fa-solid fa-arrow-right-from-bracket"></i> Leave Group</button>
        </div>
    </div>

    <!-- LIGHTBOX -->
    <div id="lightbox">
        <div class="lightbox-close" onclick="closeLightbox()">&times;</div>
        <img id="lightbox-img" src="" style="display:none;">
        <div id="lightbox-icon" class="lightbox-icon-container" style="display:none;"></div>
        <video id="lightbox-video" src="" controls style="display:none; max-width:100%; max-height:100%;"></video>
    </div>

    <!-- FORWARD MODAL -->
    <div id="forward-modal">
        <div class="forward-header">
            <i class="fa-solid fa-arrow-left" onclick="closeForwardModal()"></i>
            <h2>Select Chat</h2>
        </div>
        <div class="scroll-content" id="forward-list"></div>
    </div>

    <!-- SELECT CONTACT MODAL -->
    <div id="select-contact-modal">
        <div class="forward-header">
            <i class="fa-solid fa-arrow-left" onclick="closeSelectContactModal()"></i>
            <h2>Select Active Leader</h2>
        </div>
        <div class="scroll-content" id="contact-picker-list"></div>
    </div>

    <!-- INCOMING CALL MODAL -->
    <div id="incoming-call-modal">
        <div class="incoming-info">
            <h3 id="incoming-name">Ninja</h3>
            <p>INCOMING CALL...</p>
        </div>
        <div class="incoming-actions">
            <button class="answer-btn" onclick="acceptCall()"><i class="fa-solid fa-phone"></i></button>
            <button class="reject-call-btn" onclick="rejectCall()"><i class="fa-solid fa-phone-slash"></i></button>
        </div>
    </div>

    <!-- CALL OVERLAY -->
    <div id="call-overlay" class="connecting" onclick="toggleCallUI(event)">
        <img src="https://wallpapers.com/images/high/ninja-background-7x75k4v43s6y1x7u.webp" class="call-bg-blur" id="call-bg-img" alt="bg">
        <div class="call-info-top">
            <div class="call-name" id="call-remote-name">Unknown</div>
            <div class="call-status" id="call-status-text">CONNECTING...</div>
            <div class="call-timer" id="call-timer-display">00:00</div>
        </div>
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
        <div class="audio-placeholder"><div class="call-avatar"><i class="fa-solid fa-user-secret"></i></div></div>
        <div class="call-controls" onclick="event.stopPropagation()">
            <button class="call-btn control-btn" id="mute-btn" onclick="toggleMute()"><i class="fa-solid fa-microphone"></i></button>
            <button class="call-btn hangup-btn" onclick="endCall()"><i class="fa-solid fa-phone-slash"></i></button>
            <button class="call-btn control-btn" id="speaker-btn" onclick="toggleSpeaker()"><i class="fa-solid fa-volume-high"></i></button>
            <button class="call-btn control-btn" id="flip-btn" onclick="switchCamera()"><i class="fa-solid fa-camera-rotate"></i></button>
        </div>
    </div>

    <!-- DP CROP / CUSTOMIZE SCREEN -->
    <div id="dp-crop-screen">
        <div class="crop-header">
            <span class="crop-header-title">Move and Scale</span>
        </div>
        
        <div class="crop-viewport">
            <div class="crop-image-container">
                <img id="crop-target-img" src="" alt="Crop Preview">
            </div>
            <div class="crop-overlay">
                <div class="crop-circle-border"></div>
            </div>
        </div>
        
        <div class="crop-controls">
            <div class="zoom-slider-container">
                <i class="fa-solid fa-minus"></i>
                <input type="range" id="crop-zoom-slider" class="zoom-slider" min="1" max="3" step="0.1" value="1">
                <i class="fa-solid fa-plus"></i>
            </div>
            
            <div class="crop-actions-bar">
                <button class="crop-btn cancel" onclick="closeCropScreen()">Cancel</button>
                <button class="crop-btn save" onclick="saveCroppedImage()">DONE</button>
            </div>
        </div>
    </div>

    <!-- STORY PREVIEW & CUSTOMIZE SCREEN -->
    <div id="story-preview-screen">
        <div class="sp-header">
            <i class="fa-solid fa-arrow-left" onclick="closeStoryPreview()"></i>
            <div class="sp-sound-badge"><i class="fa-solid fa-volume-high"></i> Sound</div>
            <div class="sp-tool-text" onclick="openStoryTextEditor()">Aa</div>
        </div>
        
        <div class="story-preview-content">
            <div id="story-media-container">
                <img id="story-img-preview" src="" style="display:none;">
                <video id="story-video-preview" src="" style="display:none;" controlsList="nodownload" playsinline></video>
            </div>
        </div>
        
        <div class="sp-footer">
            <button class="story-btn-round btn-star" onclick="uploadStoryToStore('close_friends')">
                <i class="fa-solid fa-star"></i> Friends
            </button>
            
            <button class="story-btn-round btn-upload" onclick="uploadStoryToStore('public')">
                Upload <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
        
        <div id="story-text-editor">
            <input type="text" id="story-text-input" placeholder="Type something..." maxlength="50">
            <div class="text-editor-actions">
                <button class="te-btn" style="background:#fff; color:#000;" onclick="addStoryText()">DONE</button>
                <button class="te-btn" style="background:rgba(255,255,255,0.2); color:#fff;" onclick="closeStoryTextEditor()">CANCEL</button>
            </div>
        </div>
    </div>
    <input type="file" id="story-file-input" style="display:none;" accept="image/*,video/*">

    <!-- STORY VIEWER SCREEN -->
    <div id="story-viewer-screen" class="screen" style="background:black; z-index:3000;">
        <div class="story-bars-container" id="story-bars"></div>
        <div class="story-header">
            <div style="display:flex; align-items:center;">
                <div class="avatar" style="width:35px; height:35px; margin-right:10px; border:none;" id="sv-avatar">
                    <i class="fa-solid fa-user-ninja"></i>
                </div>
                <div>
                    <div style="font-weight:bold; font-size:14px;" id="sv-name">User</div>
                    <div style="font-size:11px; opacity:0.7;" id="sv-time">Just now</div>
                </div>
                <div id="sv-close-friend-badge" class="close-friend-badge-story" style="display:none;">
                    <i class="fa-solid fa-star"></i> Close Friends
                </div>
            </div>
            <div class="story-menu-btn" onclick="event.stopPropagation(); toggleStoryMenu()"><i class="fa-solid fa-ellipsis-vertical"></i></div>
        </div>
        
        <div id="story-menu-dropdown">
            <div class="story-menu-item" onclick="deleteCurrentStory()">Delete Story <i class="fa-solid fa-trash"></i></div>
        </div>

        <div class="story-viewer-content" onclick="nextStoryItem()">
            <img id="sv-img" style="display:none;">
            <video id="sv-video" style="display:none;" playsinline autoplay></video>
        </div>

        <div class="swipe-up-hint" id="swipe-up-hint">
            <i class="fa-solid fa-chevron-up"></i>
            <div>Swipe up for views</div>
        </div>

        <div id="story-stats-sheet">
            <div class="stats-header">Viewed by <span id="view-count">0</span> people</div>
            <div class="stats-list" id="stats-list-content"></div>
        </div>
        
        <div style="position:absolute; top:20px; right:60px; font-size:24px; color:white; padding:10px; z-index:15; cursor:pointer;" onclick="closeStoryViewer()"><i class="fa-solid fa-xmark"></i></div>
    </div>

    <!-- SHARE PROFILE SCREEN -->
    <div id="share-profile-screen" class="screen" style="background: linear-gradient(135deg, #111 0%, #222 100%); z-index: 2500; display: none; flex-direction: column; align-items: center; justify-content: center; color: white;">
        <i class="fa-solid fa-arrow-left" style="position:absolute; top:20px; left:20px; font-size:24px; cursor:pointer;" onclick="closeShareProfile()"></i>
        
        <div style="font-size:22px; font-weight:900; font-family:'Orbitron'; margin-bottom:10px;">MY NINJA CODE</div>
        
        <div class="qr-card">
            <div class="qr-avatar" id="share-qr-avatar">
                <i class="fa-solid fa-user-ninja"></i>
            </div>
            <div class="qr-name" id="share-qr-name">User Name</div>
            
            <div id="qrcode-container"></div>
            
            <div class="short-id-label">FRIEND CODE (UID)</div>
            <div class="short-id-display" id="share-short-id">000 000</div>
        </div>
        
        <button class="share-btn-large" onclick="shareProfileNative()">
            SHARE WITH FRIENDS <i class="fa-solid fa-share-nodes"></i>
        </button>
    </div>

    <!-- POCKET SCREEN (MEDIA STORAGE) -->
    <div id="pocket-screen" class="screen" style="background: #f4f6f9;">
        <!-- Custom Header for Pocket -->
        <div class="modern-pocket-header">
            <div class="mp-nav">
                <div class="back-icon" onclick="closePocketScreen()" style="color:white;"><i class="fa-solid fa-arrow-left"></i></div>
                <div class="room-title" style="color:white;">Cloud Pocket</div>
            </div>
            <div class="mp-storage-circle">
                <div class="mp-inner-circle">
                    <span id="storage-percent">15%</span>
                    <small>USED</small>
                </div>
            </div>
            <div class="mp-storage-text" id="pocket-storage-text">Checking Storage...</div>
        </div>

        <div class="mp-grid-container">
            <!-- Photos -->
            <div class="mp-card" onclick="openPocketDetail('photos')">
                <div class="mp-icon-box mp-blue"><i class="fa-solid fa-image"></i></div>
                <div class="mp-card-title">Photos</div>
                <div class="mp-card-sub" id="count-photos">View Gallery</div>
            </div>
            <!-- Videos -->
            <div class="mp-card" onclick="openPocketDetail('videos')">
                <div class="mp-icon-box mp-purple"><i class="fa-solid fa-video"></i></div>
                <div class="mp-card-title">Videos</div>
                <div class="mp-card-sub" id="count-videos">Watch Videos</div>
            </div>
            <!-- Audio -->
            <div class="mp-card" onclick="showToast('No Audio Saved')">
                <div class="mp-icon-box mp-orange"><i class="fa-solid fa-microphone"></i></div>
                <div class="mp-card-title">Audio</div>
                <div class="mp-card-sub">0 Items</div>
            </div>
            <!-- Docs -->
            <div class="mp-card" onclick="showToast('No Docs Saved')">
                <div class="mp-icon-box mp-teal"><i class="fa-solid fa-file"></i></div>
                <div class="mp-card-title">Docs</div>
                <div class="mp-card-sub">0 Items</div>
            </div>
        </div>
        <!-- VIP Upgrade Prompt in Pocket -->
        <div class="mp-vip-banner" onclick="openVipScreen()">
            <div class="mp-vip-icon"><i class="fa-solid fa-crown"></i></div>
            <div class="mp-vip-text">
                <b>Upgrade Storage</b>
                <span>Get 100GB with VIP Gold</span>
            </div>
            <i class="fa-solid fa-chevron-right"></i>
        </div>
    </div>

    <!-- POCKET DETAIL SCREEN -->
    <div id="pocket-detail-screen" class="screen">
        <div class="chat-navbar">
            <div style="display:flex; align-items:center;">
                <div class="back-icon" onclick="closePocketDetail()"><i class="fa-solid fa-arrow-left"></i></div>
                <div class="room-title" id="pocket-detail-title">Photos</div>
            </div>
            <div class="chat-header-actions" onclick="triggerPocketUpload()">
                <i class="fa-solid fa-plus text-red" style="font-size:22px; cursor:pointer;"></i>
            </div>
        </div>
        
        <div id="pocket-grid-content" class="insta-grid"></div>
        
        <input type="file" id="pocket-upload-input" style="display:none;">
    </div>

    <!-- NEW MODERN WALLET SCREEN (REPLACES POCKET IN SETTINGS) -->
    <div id="wallet-screen" class="screen">
        <div class="chat-navbar">
            <div style="display:flex; align-items:center;">
                <div class="back-icon" onclick="closeWalletScreen()"><i class="fa-solid fa-arrow-left"></i></div>
                <div class="room-title">My Wallet</div>
            </div>
        </div>
        
        <div class="scroll-content" style="padding: 0;">
            
            <div class="wallet-upi-header">
                <div class="upi-icon-badge">
                    <i class="fa-solid fa-qrcode"></i>
                </div>
            </div>

            <!-- GLASS/NEUMORPHISM CARD -->
            <div class="modern-wallet-card">
                <div class="modern-balance-label">Total Balance</div>
                <div class="modern-balance-amount">
                    <span class="currency-symbol">$</span>0.00
                </div>
            </div>
            
            <div class="wallet-quick-actions">
                <div class="wa-btn wa-add" onclick="showToast('Add Money: Coming Soon')">
                    <div class="wa-icon"><i class="fa-solid fa-plus"></i></div>
                    <span class="wa-label">Add Money</span>
                </div>
                <div class="wa-btn wa-withdraw" onclick="showToast('Withdraw: Coming Soon')">
                    <div class="wa-icon"><i class="fa-solid fa-arrow-down"></i></div>
                    <span class="wa-label">Withdraw</span>
                </div>
                <div class="wa-btn wa-send" onclick="showToast('Send: Coming Soon')">
                    <div class="wa-icon"><i class="fa-solid fa-paper-plane"></i></div>
                    <span class="wa-label">Send</span>
                </div>
            </div>

                        <div class="trans-header">
                <span>Recent Transactions</span>
                <span style="font-size:11px; color:var(--link-blue); cursor:pointer;">See All</span>
            </div>

            <div class="trans-list">
                <!-- Dummy Data for visual completeness -->
                <div class="trans-item">
                    <div class="ti-icon"><i class="fa-solid fa-mug-hot"></i></div>
                    <div class="ti-info">
                        <h4>Starbucks Coffee</h4>
                        <p>Today, 9:41 AM</p>
                    </div>
                    <div class="ti-amt neg">-$4.50</div>
                </div>
                
                <div class="trans-item">
                    <div class="ti-icon" style="background:#e8f5e9; color:#00e676;"><i class="fa-solid fa-arrow-down"></i></div>
                    <div class="ti-info">
                        <h4>Received from Ninja</h4>
                                               <p>Yesterday, 4:20 PM</p>
                    </div>
                    <div class="ti-amt pos">+$20.00</div>
                </div>

                <div class="trans-item">
                    <div class="ti-icon"><i class="fa-brands fa-spotify"></i></div>
                    <div class="ti-info">
                        <h4>Spotify Premium</h4>
                        <p>Dec 28, 2025</p>
                    </div>
                    <div class="ti-amt neg">-$9.99</div>
                </div>
            </div>

        </div>
    </div>

    <!-- QR SCANNER SCREEN (REAL CAMERA) -->
    <div id="qr-scanner-screen">
        <div class="qr-scan-header">
            <i class="fa-solid fa-arrow-left" onclick="closeQRScanner()"></i>
            <span>SCAN NINJA TAG</span>
        </div>
        
        <div id="qr-reader"></div>
        
        <div class="qr-overlay-guides">
            <div class="guide-corner tl"></div>
            <div class="guide-corner tr"></div>
            <div class="guide-corner bl"></div>
            <div class="guide-corner br"></div>
            <div class="qr-scan-line"></div>
        </div>
        
        <p class="qr-instruction">Align QR code within the frame to add contact automatically</p>
    </div>


    <!-- 1. AUTH SCREEN -->
    <div id="auth-screen" class="screen">
        <i class="fa-solid fa-user-secret auth-logo"></i>
        <div class="app-title"><span class="ninja-font"></span> <span class="ninja-font text-red"></span></div>
        <form id="auth-form">
            <input type="text" id="username" class="auth-input" placeholder="Ninja Name" style="display:none;">
            <input type="email" id="email" class="auth-input" placeholder="Email Address" required>
            
                       <div style="position:relative; width:100%;">
                <input type="password" id="password" class="auth-input" placeholder="Password" required style="padding-right: 40px;">
                <i id="toggle-password-btn" class="fa-solid fa-eye" style="position:absolute; right:15px; top:35%; transform:translateY(-50%); cursor:pointer; color:#666; z-index:10;"></i>
            </div>
            
            <div id="username-error" style="color:var(--accent); font-size:12px; font-weight:bold; margin-bottom:10px; display:none;"></div>
            
            <button type="submit" id="auth-btn" class="btn-primary" style="background: #000; color: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                ENTER DOJO <i class="fa-solid fa-arrow-right" style="margin-left:10px;"></i>
            </button>
            
            <div class="auth-separator"><span>OR</span></div>
            
            <button type="button" id="google-login-btn" class="btn-google">
                <i class="fa-brands fa-google"></i> Continue with Google
            </button>
        </form>
        <div id="error-msg" class="error-label" style="color:red; margin-top:10px; font-weight:700;"></div>
        <p class="toggle-text" id="toggle-auth">Don't have an account? <b>Join Clan</b></p>
    </div>

    <!-- 2. HOME SCREEN -->
    <div id="home-screen" class="screen">
        <div class="app-header">
            <div class="brand"><i class="fa-solid fa-user-secret"></i><h1><span class="ninja-font"></span> <span class="ninja-font text-red"></span></h1></div>
            
            <div class="notification-icon-wrapper" onclick="openNotifications()">
                <i class="fa-regular fa-bell" style="font-size: 20px;"></i>
                <div id="admin-msg-dot" class="notif-badge"></div>
            </div>
        </div>
        <div class="scroll-content" id="chat-list-container">
            <div class="section-label">Mission HQ</div>
            <div class="list-item" onclick="openChat('admin', 'Admin', false)">
                <div class="avatar-container"><div class="avatar"><i class="fa-solid fa-user-secret"></i></div><div class="vip-badge">VIP</div><div class="status-dot online"></div></div>
                <div class="chat-info"><h3>Admin</h3><p>Official Channel</p></div>
            </div>
            <div class="section-label">My Chats</div>
            <div id="private-chat-list"></div>
        </div>
        
        <button class="fab-btn" onclick="openNewChat()" title="New Chat">
            <i class="fa-solid fa-plus"></i>
        </button>
    </div>

    <!-- NEW CHAT SLIDER SCREEN -->
    <div id="new-chat-screen" class="screen">
        <div class="chat-navbar" style="background:transparent; border:none; box-shadow:none;">
            <div style="display:flex; align-items:center;">
                <div class="back-icon" onclick="closeNewChat()"><i class="fa-solid fa-arrow-left"></i></div>
                <div class="room-title" style="color:black; font-size:20px; font-weight:900;">Start Chat</div>
            </div>
        </div>
        <div class="scroll-content nc-container">
            
            <div class="nc-grid">
                <div class="nc-action-card" onclick="openCreateChannel()">
                    <div class="nc-icon-box nc-icon-group">
                        <i class="fa-solid fa-user-group"></i>
                    </div>
                    <div class="nc-label-text">New Group</div>
                </div>

                <div class="nc-action-card" onclick="showToast('Ninja AI Coming Soon')">
                    <div class="nc-icon-box nc-icon-ai">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <div class="nc-label-text">Ninja AI</div>
                </div>

                <div class="nc-action-card" onclick="openQRScanner()">
                    <div class="nc-icon-box nc-icon-scan">
                        <i class="fa-solid fa-qrcode"></i>
                    </div>
                    <div class="nc-label-text">Scan QR</div>
                </div>
            </div>

            <div class="nc-section-title">RECENT CONTACTS</div>
            
            <div id="new-chat-contact-list"></div>
        </div>
    </div>

    <!-- 3. REQUESTS SCREEN -->
    <div id="requests-screen" class="screen">
        <div class="scroll-content" id="requests-list" style="padding-top: 20px;"></div>
    </div>

    <!-- 4. DISCOVER SCREEN -->
    <div id="discover-screen" class="screen">
        <div class="search-area">
            <div class="search-box">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="discover-search" placeholder="Enter 6-digit code or name..." onkeyup="filterDiscover()">
                <i class="fa-solid fa-qrcode scan-icon" onclick="openQRScanner()"></i>
            </div>
        </div>
        <div class="scroll-content" id="discover-list"></div>
    </div>

    <!-- 5. CHANNEL SCREEN -->
    <div id="channel-screen" class="screen">
        <div class="search-area" style="padding-top: 20px;">
            <div class="search-box">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="channel-search" placeholder="Search by UID or Secret Code..." onkeyup="filterChannels()">
            </div>
        </div>
        
        <div class="app-header channel-header" style="padding-top: 5px; box-shadow: none;">
            <i class="fa-solid fa-square-plus create-icon" onclick="openCreateChannel()"></i>
            <i class="fa-solid fa-trophy leaderboard-icon" onclick="openLeaderboard()"></i>
        </div>
        
        <div class="scroll-content" id="channel-list"></div>
    </div>

    <!-- 6. CREATE CHANNEL SCREEN -->
    <div id="create-channel-screen" class="screen">
        <div class="chat-navbar">
            <div style="display:flex; align-items:center;">
                <div class="back-icon" onclick="closeCreateChannel()"><i class="fa-solid fa-arrow-left"></i></div>
                <div class="room-title">New Group</div>
            </div>
        </div>
        <div class="scroll-content" style="padding: 20px; position:relative;">
            
            <div class="group-create-header">
                 <div class="group-icon-upload" onclick="openIconPickerForGroup()">
                     <i class="fa-solid fa-camera"></i>
                     <img id="new-group-icon-preview" class="group-icon-img" style="display:none;">
                 </div>
                 
                 <input type="text" id="new-group-name-input" class="group-name-input" placeholder="Group Subject">
            </div>

            <div class="participants-title">Select Participants</div>
            
            <div id="create-group-contact-list"></div>

            <button class="floating-create-btn" onclick="submitCreateGroup()">
                <i class="fa-solid fa-check"></i>
            </button>
        </div>
    </div>

    <!-- 7. CHANNEL INFO SCREEN -->
    <div id="channel-info-screen" class="screen">
        <div class="chat-navbar">
            <div style="display:flex; align-items:center;">
                <div class="back-icon" onclick="closeChannelInfo()"><i class="fa-solid fa-arrow-left"></i></div>
                <div class="room-title">Group Info</div>
            </div>
        </div>
        <div class="scroll-content" id="channel-info-content"></div>
    </div>

    <!-- LEADERBOARD SCREEN -->
    <div id="leaderboard-screen" class="screen">
        <div class="leaderboard-bg">
            <div class="leaderboard-header">
                <i class="fa-solid fa-xmark close-lb" onclick="closeLeaderboard()"></i>
                <div class="leaderboard-title">TOP NINJAS</div>
                <div class="leaderboard-subtitle">CHANNELS BY POPULARITY</div>
            </div>
            <div class="scroll-content lb-list" id="leaderboard-list-content"></div>
        </div>
    </div>

    <!-- 9. PROFILE SCREEN -->
    <div id="profile-screen" class="screen">
        <div class="profile-page-header">
            <i class="fa-solid fa-gear pp-settings" onclick="openSettings()"></i>
            <div class="pp-left">
                <div class="pp-avatar" id="my-profile-avatar-container" onclick="checkAndOpenStory(currentUser.uid, true, document.getElementById('my-profile-icon').innerHTML)">
                    <div class="pp-border-ring"></div>
                    <div id="my-profile-icon" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;"><i class="fa-solid fa-user-ninja"></i></div>
                    <div class="story-add-icon" onclick="event.stopPropagation(); triggerStoryUpload()">
                        <i class="fa-solid fa-plus"></i>
                    </div>
                </div>
            </div>
            <div class="pp-right">
                <div class="pp-name" id="my-profile-name">Loading...</div>
                <div style="font-size:12px; color:#888;" id="my-profile-email">email@ninja.com</div>
            </div>
        </div>
        <div class="pp-bio-area">
            <div id="my-profile-bio">No bio available</div>
            
            <button id="admin-panel-btn" onclick="openAdminPanel()">
                <i class="fa-solid fa-user-shield"></i> OPEN ADMIN PANEL
            </button>
            
            <div class="pp-dashboard-row">
                <button id="creator-btn" class="pp-dash-main btn-shine" onclick="openCreatorScreen()">
                    <i class="fa-solid fa-user-secret" style="font-size:16px;"></i> 
                    <span style="font-family:'Orbitron'; font-size:12px;">Creator Account</span>
                </button>
                
                <div class="pp-dash-side btn-shine" onclick="openVipScreen()">
                    <i class="fa-solid fa-circle-check" style="font-size: 20px; color: var(--blue-tick);"></i>
                </div>
            </div>
            
            <div class="pp-btns-row">
                <button class="pp-action-btn" onclick="handleEditProfile()">Edit Profile</button>
                <button class="pp-action-btn" onclick="openShareProfile()">Share Profile <i class="fa-solid fa-qrcode" style="margin-left:5px;"></i></button>
            </div>

            <!-- Profile FAB still opens Pocket (Media) -->
            <div class="pocket-fab" onclick="openPocketScreen()">
                <i class="fa-brands fa-get-pocket"></i>
            </div>
        </div>
    </div>

    <!-- ADMIN DASHBOARD SCREEN -->
    <div id="admin-dashboard-screen" class="screen">
        <div class="chat-navbar">
            <div style="display:flex; align-items:center;">
                <div class="back-icon" onclick="closeAdminPanel()"><i class="fa-solid fa-arrow-left"></i></div>
                <div class="room-title">Admin Command</div>
            </div>
        </div>
        <div class="scroll-content admin-container">
            <div class="admin-card">
                <div class="admin-card-title">Live Statistics</div>
                <div class="stat-grid">
                    <div class="stat-box">
                        <span class="stat-num" id="stat-total-users">-</span>
                        <span class="stat-label">Total Users</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-num" id="stat-online-users">-</span>
                        <span class="stat-label">Online Now</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-num" id="stat-vip-users">-</span>
                        <span class="stat-label">Total VIP</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-num" id="stat-reports">0</span>
                        <span class="stat-label">Reports</span>
                    </div>
                </div>
            </div>

            <div class="admin-card danger-zone">
                <div class="admin-card-title" style="color:#d32f2f;">Emergency Controls</div>
                <p style="font-size:11px; color:#666; margin-bottom:15px;">Warning: This will shut down the app for all users except admins.</p>
                <button class="kill-switch-btn" id="kill-switch-btn" onclick="toggleMaintenanceMode()">
                    <i class="fa-solid fa-power-off"></i> 
                    <span id="kill-switch-text">ACTIVATE MAINTENANCE MODE</span>
                </button>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION SCREEN -->
    <div id="notification-screen" class="screen">
        <div class="chat-navbar">
            <div style="display:flex; align-items:center;">
                <div class="back-icon" onclick="closeNotifications()"><i class="fa-solid fa-arrow-left"></i></div>
                <div class="room-title">Notifications</div>
            </div>
        </div>
        <div class="scroll-content" id="notif-list" style="background:#f9f9f9;"></div>
    </div>

    <!-- EDIT PROFILE SCREEN -->
    <div id="edit-profile-screen" class="screen">
        <div class="chat-navbar">
            <div style="display:flex; align-items:center;">
                <div class="back-icon" onclick="closeEditProfile()"><i class="fa-solid fa-arrow-left"></i></div>
                <div class="room-title">Edit Profile</div>
            </div>
            <div class="chat-header-actions" onclick="handleSaveProfile()" style="color:var(--accent); font-weight:700; font-size:14px; cursor:pointer;">SAVE</div>
        </div>
        <div class="scroll-content edit-p-container">
            <div class="edit-p-avatar-wrapper" onclick="openIconPicker()">
                <div class="edit-p-avatar-lg">
                    <div id="edit-p-icon-preview" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;"><i class="fa-solid fa-user-ninja"></i></div>
                </div>
                <div class="edit-p-edit-icon"><i class="fa-solid fa-pen"></i></div>
            </div>

            <div class="edit-p-input-group">
                <label class="edit-p-label">NINJA NAME</label>
                <input type="text" id="edit-p-name" class="edit-p-input" placeholder="Your Name">
            </div>

            <div class="edit-p-input-group">
                <label class="edit-p-label">BIO</label>
                <textarea id="edit-p-bio" class="edit-p-input edit-p-bio" placeholder="Write something about yourself..."></textarea>
            </div>
        </div>
    </div>

    <!-- SETTINGS SCREEN -->
    <div id="settings-screen" class="screen">
        <div class="chat-navbar">
            <div style="display:flex; align-items:center;">
                <div class="back-icon" onclick="closeSettings()"><i class="fa-solid fa-arrow-left"></i></div>
                <div class="room-title">Settings</div>
            </div>
        </div>
        <div class="scroll-content" style="padding-top: 20px;">
            
            <div class="setting-item" onclick="showToast('Privacy Settings')">
                <div class="setting-icon-box si-privacy"><i class="fa-solid fa-user-secret"></i></div>
                <div class="setting-label">Account Privacy</div>
                <i class="fa-solid fa-chevron-right setting-arrow"></i>
            </div>
            
            <div class="setting-item" onclick="openBlockedUsersScreen()">
                <div class="setting-icon-box si-block"><i class="fa-solid fa-user-slash"></i></div>
                <div class="setting-label">Blocked Users</div>
                <i class="fa-solid fa-chevron-right setting-arrow"></i>
            </div>
            
            <div class="setting-item" onclick="openCreateChannel()">
                <div class="setting-icon-box si-channel"><i class="fa-solid fa-tower-broadcast"></i></div>
                <div class="setting-label">Edit My Group</div>
                <i class="fa-solid fa-chevron-right setting-arrow"></i>
            </div>
            
            <div class="setting-item" onclick="openWalletScreen()">
                <div class="setting-icon-box si-pocket"><i class="fa-solid fa-wallet"></i></div>
                <div class="setting-label">Wallet</div>
                <i class="fa-solid fa-chevron-right setting-arrow"></i>
            </div>

            <div class="setting-item" onclick="showToast('Main Group Info')">
                <div class="setting-icon-box si-group"><i class="fa-solid fa-people-group"></i></div>
                <div class="setting-label">Main Group</div>
                <i class="fa-solid fa-chevron-right setting-arrow"></i>
            </div>
            
            <div class="setting-item" onclick="openThemeScreen()">
                <div class="setting-icon-box si-theme"><i class="fa-solid fa-robot"></i></div>
                <div class="setting-label">
                    Customize App Colour 
                    <i class="fa-solid fa-lock" style="font-size:10px; color:var(--gold); margin-left:5px;"></i>
                </div>
                <i class="fa-solid fa-chevron-right setting-arrow"></i>
            </div>

            <div class="setting-item" onclick="showToast('Sound Settings')">
                <div class="setting-icon-box si-sound"><i class="fa-solid fa-volume-high"></i></div>
                <div class="setting-label">Sound</div>
                <i class="fa-solid fa-chevron-right setting-arrow"></i>
            </div>

            <div class="settings-logout-btn" onclick="logout()">
                <i class="fa-solid fa-power-off"></i> LOG OUT
            </div>

        </div>
    </div>

    <!-- THEME CUSTOMIZATION SCREEN -->
    <div id="theme-screen" class="screen">
        <div class="theme-header-modern">
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <div class="back-icon" onclick="closeThemeScreen()"><i class="fa-solid fa-arrow-left"></i></div>
                <div style="font-family: 'Orbitron'; font-weight: 900; font-size: 16px;">
                    <span class="ninja-font" style="color:black;">Ninja</span> <span class="ninja-font" id="theme-preview-title-span" style="color:#d32f2f;">Chat</span>
                </div>
                <div style="width:30px;"></div>
            </div>
        </div>

        <div class="theme-picker-scroll">
            <div class="theme-preview-card">
                <div style="font-size:12px; font-weight:700; color:#555; margin-bottom:5px;">PREVIEW</div>
                <div style="display:flex; align-items:flex-end; gap:8px;">
                    <div style="width:30px; height:30px; border-radius:50%; background:#222; display:flex; justify-content:center; align-items:center; color:white;"><i class="fa-solid fa-user-secret"></i></div>
                    <div class="dummy-msg-bubble" id="theme-preview-bubble" style="background-color:#d32f2f; color:white; padding:10px 15px; border-radius: 0 12px 12px 12px;">
                        Hello Ninja! This is how your chat looks.
                    </div>
                </div>
                <div style="display:flex; justify-content:flex-end; margin-top:5px;">
                     <div style="background:#eee; padding:10px 15px; border-radius:12px 12px 0 12px;">Cool update!</div>
                </div>
            </div>

            <div class="theme-section-title">Classic Colours</div>
            <div class="color-grid-modern">
                <div class="color-bubble bg-red selected" onclick="selectThemeColor('#d32f2f', this)"></div>
                <div class="color-bubble bg-blue" onclick="selectThemeColor('#2979FF', this)"></div>
                <div class="color-bubble bg-green" onclick="selectThemeColor('#00E676', this)"></div>
                <div class="color-bubble bg-dark" onclick="selectThemeColor('#222', this)"></div>
            </div>

            <div class="theme-section-title">Vibrant & Pop</div>
            <div class="color-grid-modern">
                <div class="color-bubble bg-purple" onclick="selectThemeColor('#7F57FF', this)"></div>
                <div class="color-bubble bg-gold" onclick="selectThemeColor('#FFD700', this)"></div>
                <div class="color-bubble bg-pink" onclick="selectThemeColor('#E91E63', this)"></div>
                <div class="color-bubble bg-orange" onclick="selectThemeColor('#FF9800', this)"></div>
            </div>
            
            <div class="theme-section-title">Modern & Cool</div>
            <div class="color-grid-modern">
                <div class="color-bubble bg-teal" onclick="selectThemeColor('#009688', this)"></div>
                <div class="color-bubble bg-cyan" onclick="selectThemeColor('#00e5ff', this)"></div>
                <div class="color-bubble bg-lime" onclick="selectThemeColor('#76ff03', this)"></div>
                <div class="color-bubble bg-indigo" onclick="selectThemeColor('#304ffe', this)"></div>
            </div>

            <button class="btn-apply-theme" onclick="applyTheme()">APPLY NEW THEME</button>
        </div>
    </div>

    <!-- ICON PICKER MODAL -->
    <div id="icon-picker-modal">
        <div class="chat-navbar">
            <div style="display:flex; align-items:center;">
                <div class="back-icon" onclick="closeIconPicker()"><i class="fa-solid fa-arrow-left"></i></div>
                <div class="room-title">Choose Avatar</div>
            </div>
        </div>
        <div class="scroll-content">
            <div class="section-label" style="margin-left:20px; margin-top:20px;">BASIC NINJA (10)</div>
            <div class="icon-grid-profile" id="basic-icon-grid"></div>
            
            <div class="vip-section-title"><i class="fa-solid fa-crown"></i> VIP ICONS (10)</div>
            <div class="icon-grid-profile" id="vip-icon-grid"></div>
        </div>
        <input type="file" id="custom-profile-upload" accept="image/*" style="display:none">
    </div>

    <!-- GLOBAL BOTTOM NAVIGATION -->
    <nav class="bottom-nav" id="main-nav">
        <div class="nav-item active-nav" id="nav-home" onclick="switchTab('home')">
            <i class="fa-solid fa-comments"></i>
            <span>CHATS</span>
        </div>
        <div class="nav-item" id="nav-requests" onclick="switchTab('requests')">
            <i class="fa-solid fa-user-plus"></i>
            <span>REQUEST</span>
        </div>
        <div class="nav-item" id="nav-discover" onclick="switchTab('discover')">
            <i class="fa-solid fa-globe"></i>
            <span>DISCOVER</span>
        </div>
        <div class="nav-item" id="nav-channel" onclick="switchTab('channel')">
            <i class="fa-solid fa-bullhorn"></i>
            <span>CHANNEL</span>
        </div>
        <!-- Profile with Name -->
        <div class="nav-item" id="nav-profile">
            <div class="nav-profile-container" id="nav-profile-img-container">
                 <i class="fa-solid fa-user nav-profile-icon-fallback"></i>
            </div>
            <span>PROFILE</span>
        </div>
    </nav>

    <!-- 8. CHAT SCREEN -->
    <div id="chat-screen" class="screen">
        <div class="chat-navbar" id="chat-navbar">
            <div style="display:flex; align-items:center; flex:1;">
                <div class="back-icon" onclick="closeChat()"><i class="fa-solid fa-arrow-left"></i></div>
                
                <div class="chat-header-avatar" id="chat-header-icon" style="margin-right: 8px; cursor:pointer;"></div>
                
                <div id="chat-header-clickable" style="display:flex; flex-direction:column; cursor:pointer; flex:1; padding: 5px 0;">
                    <div class="room-title" id="chat-room-name">Name</div>
                    <div class="room-status" id="chat-room-status">Offline</div>
                </div>
            </div>

            <div class="chat-header-actions">
                <div id="call-buttons" style="display:flex; gap:12px;">
                    <div class="modern-header-btn" onclick="startCall('audio')"><i class="fa-solid fa-phone"></i></div>
                    <div class="modern-header-btn" onclick="startCall('video')"><i class="fa-solid fa-video"></i></div>
                </div>
            </div>
        </div>
        
        <div id="chat-selection-bar">
            <div class="selection-left">
                <i class="fa-solid fa-xmark selection-back" onclick="closeSelectionMode()"></i>
                <div class="selection-count" id="selection-count">0</div>
            </div>
            <div class="selection-actions">
                <div class="sel-btn-wrapper" id="selection-delete-btn" onclick="handleDeleteMessage()">
                    <i class="fa-solid fa-trash-can-arrow-up"></i>
                </div>
                <div class="sel-btn-wrapper" onclick="copyMessage()">
                    <i class="fa-solid fa-paste"></i>
                </div>
                <div class="sel-btn-wrapper" onclick="handleForward()">
                    <i class="fa-solid fa-share-nodes"></i>
                </div>
                <div class="sel-btn-wrapper" onclick="showSelectionMoreOptions()" style="position:relative;">
                    <i class="fa-solid fa-ellipsis-vertical"></i>
                    <div id="sel-more-dropdown" class="sel-menu-dropdown">
                        <div class="sel-menu-item" onclick="showToast('Info Clicked')">Info</div>
                        <div class="sel-menu-item" onclick="showToast('Report Message')">Report</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="chat-messages"></div>
        
        <div id="scroll-down-btn" onclick="smoothScrollToBottom()">
            <i class="fa-solid fa-arrow-down"></i>
            <span id="scroll-badge">0</span>
        </div>

        <div id="typing-indicator-box"></div>
        
        <div id="telegram-join-container" class="telegram-join-bar"></div>

        <!-- NEW STICKER PICKER -->
        <div id="sticker-picker">
            <!-- Stickers injected via JS -->
        </div>

        <!-- ATTACHMENT MENU -->
        <div id="attachment-menu">
            <div class="att-item" onclick="document.getElementById('doc-input').click(); toggleAttachmentMenu()">
                <div class="att-icon doc"><i class="fa-solid fa-file-lines"></i></div>
                <span>Document</span>
            </div>
            <div class="att-item" onclick="showToast('Camera: Coming Soon')">
                <div class="att-icon cam"><i class="fa-solid fa-camera"></i></div>
                <span>Camera</span>
            </div>
            <div class="att-item" onclick="triggerGallery()">
                <div class="att-icon gal"><i class="fa-regular fa-image"></i></div>
                <span>Gallery</span>
            </div>
            <div class="att-item" onclick="showToast('Audio: Coming Soon')">
                <div class="att-icon aud"><i class="fa-solid fa-headphones"></i></div>
                <span>Audio</span>
            </div>
            <div class="att-item" onclick="handleLocationShare()">
                <div class="att-icon loc"><i class="fa-solid fa-location-dot"></i></div>
                <span>Location</span>
            </div>
            <div class="att-item" onclick="handleContactShare()">
                <div class="att-icon con"><i class="fa-solid fa-user"></i></div>
                <span>Contact</span>
            </div>
        </div>

        <div class="chat-footer">
            <div id="record-preview" class="preview-bar">
                <div class="rec-indicator"><div class="rec-dot"></div><span id="rec-timer">0:00</span></div>
                <span style="font-size:11px; color:#555;">Tap mic to send</span>
            </div>
            
            <div id="image-preview" class="preview-bar">
                <img id="preview-img-tag" class="img-preview-thumb" src="">
                <i class="fa-solid fa-times" style="font-size:16px; padding:10px; cursor:pointer;" onclick="cancelPhoto()"></i>
            </div>

            <div id="reply-bar" class="reply-preview-bar">
                <div>Replying to <b id="reply-to-name">User</b><br><span id="reply-to-text">Message...</span></div>
                <i class="fa-solid fa-times" style="font-size:16px; padding:10px; cursor:pointer;" onclick="cancelReply()"></i>
            </div>
            
            <div id="speech-settings-menu" class="speech-menu">
                <div class="speech-option" onclick="toggleSpeechState()">
                    <span>Speech</span>
                    <span id="speech-status-text" class="status-off">OFF</span>
                    <i id="speech-status-icon" class="fa-solid fa-toggle-off"></i>
                </div>
            </div>

            <div id="voice-lock-indicator" class="voice-lock-indicator">
                <i class="fa-solid fa-lock"></i>
            </div>
            <div id="voice-slide-cancel" class="voice-slide-cancel">
                <i class="fa-solid fa-chevron-left"></i> Slide to cancel
            </div>
            
            <div id="recording-locked-view" class="recording-locked-view">
                <div class="rec-cancel-btn" onclick="cancelVoiceRecording()">Cancel</div>
                <div class="rec-locked-timer">
                    <div class="rec-dot"></div>
                    <span id="rec-locked-time-txt">0:00</span>
                </div>
                <div class="rec-send-btn" onclick="sendVoiceRecording()"><i class="fa-solid fa-paper-plane"></i></div>
            </div>

            <i id="voice-trash-can" class="fa-solid fa-trash"></i>

            <form class="msg-input-area" id="msg-form">
                <div class="input-group">
                    <!-- NEW STICKER ICON (SVG) -->
                    <div class="emoji-btn" onclick="toggleStickerPicker()">
                        <svg viewBox="0 0 512 512">
                            <path d="M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256s256-114.6 256-256S397.4 0 256 0zM256 464c-114.7 0-208-93.3-208-208S141.3 48 256 48s208 93.3 208 208S370.7 464 256 464zM256 160c-17.7 0-32 14.3-32 32v32c0 17.7 14.3 32 32 32s32-14.3 32-32V192C288 174.3 273.7 160 256 160zM176 192c0-17.7-14.3-32-32-32s-32 14.3-32 32v32c0 17.7 14.3 32 32 32s32-14.3 32-32V192zM368 192c0-17.7-14.3-32-32-32s-32 14.3-32 32v32c0 17.7 14.3 32 32 32s32-14.3 32-32V192zM256 384c58.1 0 108.7-32.9 133.5-81.1c4.8-9.4 1.1-21-8.3-25.8s-21-1.1-25.8 8.3c-17.3 33.6-52.6 56.6-99.4 56.6s-82.1-23-99.4-56.6c-4.8-9.4-16.4-13.1-25.8-8.3s-13.1 16.4-8.3 25.8C147.3 351.1 197.9 384 256 384z"/>
                        </svg>
                    </div>

                    <!-- UPDATED INPUT TO TEXTAREA FOR WHATSAPP STYLE -->
                    <textarea id="msg-input" placeholder="Message..." rows="1"></textarea>
                    
                    <div id="paperclip-btn" class="photo-btn">
                        <i class="fa-solid fa-paperclip"></i>
                    </div>

                    <div class="admin-speech-btn" onclick="toggleSpeechMenu()">
                        <i class="fa-solid fa-user-gear"></i>
                    </div>
                </div>
                
                <input type="file" id="photo-input" accept="image/*,video/*" style="display:none;" onchange="handlePhotoSelect(this)">
                <input type="file" id="doc-input" accept=".pdf,.doc,.docx,.txt,.xls,.xlsx,.ppt,.pptx" style="display:none;" onchange="handleDocumentSelect(this)">
                
                <button type="button" class="mic-btn" id="mic-btn"><i class="fa-solid fa-microphone"></i></button>
                <button type="submit" class="send-btn" id="send-btn"><i class="fa-solid fa-paper-plane"></i></button>
            </form>
        </div>
    </div>

    <div id="action-menu" onclick="closeSelectionMode()"></div>

    <!-- FIREBASE SDK & APP LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getDatabase, ref, push, set, onValue, off, get, child, remove, query, limitToLast, onDisconnect, serverTimestamp, update, onChildAdded, orderByChild, equalTo, onChildChanged, onChildRemoved } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5SfN4W6RRzI8dilcWtq7KSjT2sFMO1pc",
            authDomain: "social-chat-75723.firebaseapp.com",
            databaseURL: "https://social-chat-75723-default-rtdb.firebaseio.com",
            projectId: "social-chat-75723",
            storageBucket: "social-chat-75723.firebasestorage.app",
            messagingSenderId: "700617417526",
            appId: "1:700617417526:web:52d6b1e7638d30622d0997",
            measurementId: "G-GGFD8F42B6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const googleProvider = new GoogleAuthProvider();

        // --- DOM ELEMENTS ---
        const authScreen = document.getElementById('auth-screen');
        const homeScreen = document.getElementById('home-screen');
        const chatScreen = document.getElementById('chat-screen');
        const requestsScreen = document.getElementById('requests-screen'); 
        const discoverScreen = document.getElementById('discover-screen'); 
        const channelScreen = document.getElementById('channel-screen');
        const createChannelScreen = document.getElementById('create-channel-screen');
        const channelInfoScreen = document.getElementById('channel-info-screen');
        const leaderboardScreen = document.getElementById('leaderboard-screen');
        const profileScreen = document.getElementById('profile-screen');
        const editProfileScreen = document.getElementById('edit-profile-screen');
        const viewProfileScreen = document.getElementById('view-profile-screen'); 
        const adminDashboardScreen = document.getElementById('admin-dashboard-screen');
        const maintenanceScreen = document.getElementById('maintenance-screen');
        const notificationScreen = document.getElementById('notification-screen'); 
        const iconPickerModal = document.getElementById('icon-picker-modal');
        const mainNav = document.getElementById('main-nav');
        const storyViewerScreen = document.getElementById('story-viewer-screen');
        const shareProfileScreen = document.getElementById('share-profile-screen');
        const banScreen = document.getElementById('ban-screen');
        const chatDetailScreen = document.getElementById('chat-detail-screen'); 
        const blockedUsersScreen = document.getElementById('blocked-users-screen');
        const pinnedSheet = document.getElementById('pinned-sheet');
        const pinnedSheetOverlay = document.getElementById('pinned-sheet-overlay');
        const chatWallpaperScreen = document.getElementById('chat-wallpaper-screen');
        const wallpaperPreviewScreen = document.getElementById('wallpaper-preview-screen'); 

        const vipLandingScreen = document.getElementById('vip-landing-screen');
        const vipPurchaseScreen = document.getElementById('vip-purchase-screen');

        const newChatScreen = document.getElementById('new-chat-screen');
        const pocketScreen = document.getElementById('pocket-screen');
        const pocketDetailScreen = document.getElementById('pocket-detail-screen');
        const pocketGridContent = document.getElementById('pocket-grid-content');
        const pocketDetailTitle = document.getElementById('pocket-detail-title');
        let currentPocketType = 'photos';

        const walletScreen = document.getElementById('wallet-screen');

        const dpCropScreen = document.getElementById('dp-crop-screen');
        const cropTargetImg = document.getElementById('crop-target-img');
        const cropZoomSlider = document.getElementById('crop-zoom-slider');
        const cropImageContainer = document.querySelector('.crop-image-container');
        
        const creatorScreen = document.getElementById('creator-screen');

        const privateChatList = document.getElementById('private-chat-list');
        const discoverList = document.getElementById('discover-list');
        const requestsList = document.getElementById('requests-list');
        const channelList = document.getElementById('channel-list');
        const leaderboardListContent = document.getElementById('leaderboard-list-content');
        const notifListContent = document.getElementById('notif-list'); 
        
        const actionMenu = document.getElementById('action-menu');
        const callButtons = document.getElementById('call-buttons');
        const toastBox = document.getElementById('toast-box');
        
        const chatNavbar = document.getElementById('chat-navbar');
        const chatSelectionBar = document.getElementById('chat-selection-bar');
        const selectionCountDisplay = document.getElementById('selection-count');
        const chatHeaderClickable = document.getElementById('chat-header-clickable');
        const chatHeaderIcon = document.getElementById('chat-header-icon');
        
        const chatFooter = document.querySelector('.chat-footer');
        const telegramJoinBar = document.getElementById('telegram-join-container');
        
        const micBtn = document.getElementById('mic-btn');
        const sendBtn = document.getElementById('send-btn'); 
        const msgInput = document.getElementById('msg-input'); 
        const stickerPicker = document.getElementById('sticker-picker');
        
        const recPreview = document.getElementById('record-preview');
        const recTimerTxt = document.getElementById('rec-timer');
        const imagePreview = document.getElementById('image-preview');
        const previewImgTag = document.getElementById('preview-img-tag');

        const voiceLockIndicator = document.getElementById('voice-lock-indicator');
        const voiceSlideCancel = document.getElementById('voice-slide-cancel');
        const recordingLockedView = document.getElementById('recording-locked-view');
        const recLockedTimeTxt = document.getElementById('rec-locked-time-txt');
        const trashIcon = document.getElementById('voice-trash-can');

        const scrollBtn = document.getElementById('scroll-down-btn');
        const scrollBadge = document.getElementById('scroll-badge');
        let unreadScrollCount = 0;

        const onlineNotify = document.getElementById('online-notify');
        const onNotifName = document.getElementById('on-notif-name');
        let activeNotifUid = null;
        let notifTimeout = null;

        const customModalOverlay = document.getElementById('custom-modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalText = document.getElementById('modal-text');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');

        const contactOptionsModal = document.getElementById('contact-options-modal');
        const optHeaderName = document.getElementById('opt-header-name');

        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        const lightboxVideo = document.getElementById('lightbox-video');
        const lightboxIcon = document.getElementById('lightbox-icon');

        const forwardModal = document.getElementById('forward-modal');
        const forwardList = document.getElementById('forward-list');

        const selectContactModal = document.getElementById('select-contact-modal');
        const contactPickerList = document.getElementById('contact-picker-list');

        const incomingCallModal = document.getElementById('incoming-call-modal');
        const callOverlay = document.getElementById('call-overlay');
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const callRemoteName = document.getElementById('call-remote-name');
        const callStatusText = document.getElementById('call-status-text');
        const callTimerDisplay = document.getElementById('call-timer-display');
        const flipBtn = document.getElementById('flip-btn');
        
        const chatRoomStatus = document.getElementById('chat-room-status');

        const storyMediaContainer = document.getElementById('story-media-container');
        const storyImgPreview = document.getElementById('story-img-preview');
        const storyVideoPreview = document.getElementById('story-video-preview');
        const storyTextEditor = document.getElementById('story-text-editor');
        const storyTextInput = document.getElementById('story-text-input');

        const accountSwitcherSheet = document.getElementById('account-switcher-sheet');
        const accountSwitcherOverlay = document.getElementById('account-switcher-overlay');
        const accountListContent = document.getElementById('account-list-content');

        // QR SCANNER ELEMENT
        const qrScannerScreen = document.getElementById('qr-scanner-screen');

        let currentUser = null;
        let isLogin = true;
        let returnToPage = 'home';
        
        let unsubscribeChat = null; 
        
        let unsubscribeTyping = null;
        let unsubscribeHeaderStatus = null;
        let currentChatUserUid = null;
        let replyingToMsg = null;
        let isAdminChat = false;
        let isChannelChat = false;
        let typingTimeout = null; 
        let currentChatIdString = null;
        let currentImageBase64 = null;
        let currentVideoBase64 = null; 
        let currentMediaType = null; 
        let currentVideoDuration = null; 
        let currentVideoSize = null; 
        let isModalOpen = false;
        let lastRenderedDate = null;
        let currentChannelId = null;
        
        let activeChatAvatarHTML = "";

        let rawCropImage = new Image();
        let cropPosX = 0;
        let cropPosY = 0;
        let isDraggingCrop = false;
        let cropStartDragX, cropStartDragY;

        let storyScale = 1;
        let storyTranslateX = 0;
        let storyTranslateY = 0;
        let storyStartDist = 0;
        let storyIsDragging = false;
        let storyStartX = 0;
        let storyStartY = 0;
        let storyTextOverlays = [];
        
        let selectedCreatorPlatform = 'Ninja Chat';

        let selectedMessages = []; 
        let isSelectionMode = false;
        let isSelectionGesture = false; 
        let lastToggledMsgId = null; 

        let isSendingMessage = false;
        
        let chatOpenTimestamp = 0;
        
        let isCallActive = false;
        
        let chatDrafts = {};
        
        let speechMenuOpen = false;
        let speechEnabled = false;

        let isSystemBack = false;

        let currentProfileIcon = 'fa-user-ninja';
        let tempSelectedIcon = 'fa-user-ninja';
        let isVipUser = false; 
        let isUserAdmin = false; 
        let vipCountdownInterval = null;
        let myAvatarHTML = "";

        let currentStoryList = [];
        let currentStoryIndex = 0;
        let storyTimer = null;
        let storySwipeStartY = 0;

        let selectedContactId = null;
        let selectedContactName = null;
        let selectedGroupMembers = []; 

        // Wallpaper Variables
        let pendingWallpaperSrc = '';
        let pendingWallpaperIsImage = false;

        let localStream;
        let peerConnection;
        let incomingCallData = null;
        let callTimerInterval;
        let callSeconds = 0;
        
        const audioOutgoing = new Audio('https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3'); 
        audioOutgoing.loop = true;

        const audioIncoming = new Audio('https://assets.mixkit.co/active_storage/sfx/2044/2044-preview.mp3'); 
        audioIncoming.loop = true;

        const audioTyping = new Audio('https://assets.mixkit.co/active_storage/sfx/2366/2366-preview.mp3'); 
        audioTyping.loop = true; 
        
        const audioTung = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
        
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let isVoiceLocked = false;
        let recStartTime;
        let recInterval;
        let voiceTouchStartY = 0;
        let voiceTouchStartX = 0;
        let voicePressTimer = null;

        let currentFacingMode = 'user';

        // NEW QR SCANNER VAR
        let html5QrCode;

        const servers = {
            iceServers: [
                { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] },
            ]
        };
        
        const localVideoEl = document.getElementById('local-video');
        let isDragging = false;
        let dragOffsetX, dragOffsetY;

        // --- DRAG LOGIC FOR VIDEO CALL PIP ---
        localVideoEl.addEventListener('touchstart', (e) => {
            if(!isCallActive || callOverlay.classList.contains('connecting')) return; 
            isDragging = true;
            localVideoEl.style.transition = 'none'; 
            const touch = e.touches[0];
            const rect = localVideoEl.getBoundingClientRect();
            dragOffsetX = touch.clientX - rect.left;
            dragOffsetY = touch.clientY - rect.top;
            e.preventDefault(); 
        }, { passive: false });

        localVideoEl.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            const touch = e.touches[0];
            let x = touch.clientX - dragOffsetX;
            let y = touch.clientY - dragOffsetY;
            
            const maxWidth = window.innerWidth - localVideoEl.offsetWidth;
            const maxHeight = window.innerHeight - localVideoEl.offsetHeight;
            
            if (x < 0) x = 0;
            if (x > maxWidth) x = maxWidth;
            if (y < 0) y = 0;
            if (y > maxHeight) y = maxHeight;

            localVideoEl.style.left = x + 'px';
            localVideoEl.style.top = y + 'px';
            localVideoEl.style.right = 'auto'; 
            e.preventDefault();
        }, { passive: false });

        localVideoEl.addEventListener('touchend', () => {
            if (!isDragging) return;
            isDragging = false;
            localVideoEl.style.transition = 'all 0.3s cubic-bezier(0.25, 0.8, 0.2, 1)';
            
            const screenW = window.innerWidth;
            const screenH = window.innerHeight;
            const vidW = localVideoEl.offsetWidth;
            const vidH = localVideoEl.offsetHeight;
            const currentX = parseInt(localVideoEl.style.left || 0);
            const currentY = parseInt(localVideoEl.style.top || 0);

            let targetX = (currentX + vidW/2 < screenW/2) ? 10 : (screenW - vidW - 10);
            let targetY = (currentY + vidH/2 < screenH/2) ? 10 : (screenH - vidH - 10);
            
            if (targetY < 50) targetY = 50; 
            if (targetY > screenH - vidH - 80) targetY = screenH - vidH - 80;

            localVideoEl.style.left = targetX + 'px';
            localVideoEl.style.top = targetY + 'px';
        });

        // --- APP INITIALIZATION ---
        window.onload = () => {
            history.replaceState({page: 'home'}, 'Home', '');
            
            setTimeout(() => {
                document.getElementById('splash-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('splash-screen').style.display = 'none';
                }, 500);
            }, 2500);
            
            onValue(ref(db, 'app_settings/maintenance_mode'), (snap) => {
                const isMaintenance = snap.val();
                if(isMaintenance === true) {
                    if(currentUser && isUserAdmin) {
                        maintenanceScreen.style.display = 'none';
                    } else {
                        maintenanceScreen.style.display = 'flex';
                    }
                } else {
                    maintenanceScreen.style.display = 'none';
                }
            });
            
            setupVoiceRecording();
            setupLightboxSwipe();
            setupStoryGestures();
            setupPaperclipInteraction();
            setupNavProfileInteraction(); // New Long Press Logic
            renderNinjaStickers(); // RENDER STICKERS ON LOAD
            
            const togglePassBtn = document.getElementById('toggle-password-btn');
            const passInput = document.getElementById('password');
            if(togglePassBtn && passInput) {
                togglePassBtn.addEventListener('click', () => {
                    const type = passInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passInput.setAttribute('type', type);
                    togglePassBtn.classList.toggle('fa-eye');
                    togglePassBtn.classList.toggle('fa-eye-slash');
                });
            }
            
            if(cropZoomSlider) {
                cropZoomSlider.addEventListener('input', (e) => {
                    if(cropTargetImg) {
                        cropTargetImg.style.transform = `translate(${cropPosX}px, ${cropPosY}px) scale(${e.target.value})`;
                    }
                });
            }
            
            setupCropDrag();
            setupStorySwipe();
            document.getElementById('pocket-upload-input').addEventListener('change', handlePocketFileSelect);
            
            // Background Upload Input Handler
            document.getElementById('wall-upload-input').addEventListener('change', handleWallpaperUpload);
        };

        // --- STICKER LOGIC ---
        window.toggleStickerPicker = () => {
            stickerPicker.classList.toggle('open');
            document.getElementById('attachment-menu').classList.remove('open');
        };

        window.renderNinjaStickers = () => {
            const container = document.getElementById('sticker-picker');
            container.innerHTML = '';
            
            // 20 Emotions
            const emotions = [
                'happy', 'sad', 'angry', 'love', 'laugh', 
                'cool', 'shocked', 'sleepy', 'wink', 'confused', 
                'cry', 'sick', 'dead', 'devil', 'angel', 
                'smart', 'money', 'zip', 'nerd', 'mask'
            ];

            emotions.forEach(emotion => {
                const btn = document.createElement('div');
                btn.className = 'ninja-sticker-btn';
                
                // Get Dynamic Accent Color
                const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
                
                // Base Ninja Head (Black)
                let faceContent = '';
                
                // Switch based on emotion (Simplified logic for varied eyes/mouths)
                if(emotion === 'happy') faceContent = `<circle cx="35" cy="40" r="5" fill="white"/><circle cx="65" cy="40" r="5" fill="white"/><path d="M30 65 Q50 80 70 65" stroke="white" stroke-width="3" fill="none"/>`;
                else if(emotion === 'sad') faceContent = `<circle cx="35" cy="45" r="5" fill="white"/><circle cx="65" cy="45" r="5" fill="white"/><path d="M30 75 Q50 60 70 75" stroke="white" stroke-width="3" fill="none"/>`;
                else if(emotion === 'angry') faceContent = `<path d="M30 40 L45 50" stroke="white" stroke-width="3"/><path d="M70 40 L55 50" stroke="white" stroke-width="3"/><circle cx="35" cy="55" r="4" fill="white"/><circle cx="65" cy="55" r="4" fill="white"/><line x1="40" y1="70" x2="60" y2="70" stroke="white" stroke-width="3"/>`;
                else if(emotion === 'love') faceContent = `<path d="M30 40 Q35 30 40 40 Q45 50 30 55 Q15 50 20 40 Q25 30 30 40" fill="red"/><path d="M70 40 Q75 30 80 40 Q85 50 70 55 Q55 50 60 40 Q65 30 70 40" fill="red"/><path d="M35 70 Q50 80 65 70" stroke="white" stroke-width="3" fill="none"/>`;
                else if(emotion === 'laugh') faceContent = `<path d="M30 40 L40 45 L30 50" fill="none" stroke="white" stroke-width="3"/><path d="M70 40 L60 45 L70 50" fill="none" stroke="white" stroke-width="3"/><path d="M30 65 Q50 85 70 65" fill="white"/>`;
                else if(emotion === 'cool') faceContent = `<rect x="25" y="40" width="20" height="15" fill="black" stroke="white" stroke-width="2"/><rect x="55" y="40" width="20" height="15" fill="black" stroke="white" stroke-width="2"/><line x1="45" y1="47" x2="55" y2="47" stroke="white" stroke-width="2"/><path d="M40 70 Q50 75 60 70" stroke="white" stroke-width="3" fill="none"/>`;
                else if(emotion === 'shocked') faceContent = `<circle cx="35" cy="40" r="6" fill="white"/><circle cx="65" cy="40" r="6" fill="white"/><circle cx="50" cy="70" r="8" fill="white"/>`;
                else if(emotion === 'sleepy') faceContent = `<path d="M30 45 Q35 40 40 45" stroke="white" stroke-width="3" fill="none"/><path d="M60 45 Q65 40 70 45" stroke="white" stroke-width="3" fill="none"/><circle cx="50" cy="70" r="5" fill="white"/><text x="75" y="30" font-size="15" fill="white" font-family="Arial">z</text>`;
                else if(emotion === 'wink') faceContent = `<circle cx="35" cy="40" r="5" fill="white"/><path d="M60 40 L70 40" stroke="white" stroke-width="3"/><path d="M35 70 Q50 80 65 70" stroke="white" stroke-width="3" fill="none"/>`;
                else if(emotion === 'confused') faceContent = `<circle cx="35" cy="40" r="5" fill="white"/><circle cx="65" cy="40" r="4" fill="white"/><path d="M35 70 Q50 65 65 75" stroke="white" stroke-width="3" fill="none"/>`;
                else if(emotion === 'mask') faceContent = `<circle cx="35" cy="40" r="5" fill="white"/><circle cx="65" cy="40" r="5" fill="white"/><rect x="25" y="55" width="50" height="25" rx="5" fill="white"/>`;
                else faceContent = `<circle cx="35" cy="40" r="5" fill="white"/><circle cx="65" cy="40" r="5" fill="white"/><line x1="35" y1="70" x2="65" y2="70" stroke="white" stroke-width="3"/>`;

                // SVG Construction with Variable Coloring
                // Using CSS Variable for fill directly in SVG logic
                const svgString = `
                <svg viewBox="0 0 100 100" width="100%" height="100%">
                    <circle cx="50" cy="50" r="45" fill="black" stroke="none"/>
                    <!-- Headband (Color Dynamic) -->
                    <rect x="15" y="20" width="70" height="15" rx="5" fill="var(--accent)" />
                    <circle cx="50" cy="27" r="4" fill="rgba(255,255,255,0.5)"/>
                    ${faceContent}
                </svg>`;
                
                btn.innerHTML = svgString;
                btn.onclick = () => sendSticker(svgString);
                container.appendChild(btn);
            });
        };

        window.sendSticker = (svgHtml) => {
            if(currentChatIdString || isChannelChat) {
                const content = svgHtml; // Store raw SVG string
                sendMessage(content, 'sticker');
                toggleStickerPicker();
            } else {
                showToast("Open a chat first!");
            }
        };

        // --- NEW: NAVIGATION PROFILE INTERACTION (LONG PRESS) ---
        function setupNavProfileInteraction() {
            const navProfile = document.getElementById('nav-profile');
            let pressTimer;
            let isLongPress = false;

            navProfile.addEventListener('touchstart', (e) => {
                isLongPress = false;
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    if(navigator.vibrate) navigator.vibrate(50);
                    openAccountSwitcher(); // Open Sheet
                }, 600);
            }, {passive: false});

            navProfile.addEventListener('touchend', (e) => {
                clearTimeout(pressTimer);
                if (isLongPress) {
                    e.preventDefault(); 
                    e.stopPropagation(); 
                } else {
                    switchTab('profile'); // Normal click behavior
                }
            });
            
            // Cancel on scroll/move
            navProfile.addEventListener('touchmove', () => clearTimeout(pressTimer));
        }

        window.openAccountSwitcher = () => {
            accountSwitcherOverlay.style.display = 'block';
            accountSwitcherSheet.classList.add('open');
            renderAccountList();
        };

        window.closeAccountSwitcher = () => {
            accountSwitcherSheet.classList.remove('open');
            setTimeout(() => { accountSwitcherOverlay.style.display = 'none'; }, 300);
        };

        // --- MULTI-ACCOUNT LOGIC ---
        function saveAccountToStorage(user) {
            let accounts = JSON.parse(localStorage.getItem('ninja_accounts') || '[]');
            
            // Remove if exists to update
            accounts = accounts.filter(acc => acc.uid !== user.uid);
            
            // Add current
            // Note: We can't save the full user object securely, just metadata for the list
            // Real auth switching requires re-login in this simplified web context
            
            // We need to fetch current avatar to save
            get(ref(db, `users/${user.uid}`)).then(snap => {
                const data = snap.val();
                let iconData = 'fa-user-ninja';
                let isCustom = false;
                let avatarUrl = '';
                
                if(data) {
                    if(data.icon === 'custom' && data.customAvatar) {
                        isCustom = true;
                        avatarUrl = data.customAvatar;
                    } else {
                        iconData = data.icon || 'fa-user-ninja';
                    }
                    
                    const accountInfo = {
                        uid: user.uid,
                        username: data.username || user.displayName || "Ninja",
                        email: user.email,
                        isCustom: isCustom,
                        avatar: avatarUrl,
                        icon: iconData
                    };
                    
                    accounts.push(accountInfo);
                    localStorage.setItem('ninja_accounts', JSON.stringify(accounts));
                }
            });
        }

        function renderAccountList() {
            const accounts = JSON.parse(localStorage.getItem('ninja_accounts') || '[]');
            accountListContent.innerHTML = '';
            
            accounts.forEach(acc => {
                const isActive = currentUser && currentUser.uid === acc.uid;
                
                const div = document.createElement('div');
                div.className = `as-item ${isActive ? 'active' : ''}`;
                
                let avatarHtml = '';
                if(acc.isCustom && acc.avatar) {
                    avatarHtml = `<img src="${acc.avatar}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
                } else {
                    avatarHtml = `<i class="fa-solid ${acc.icon}"></i>`;
                }
                
                div.innerHTML = `
                    <div class="as-avatar">${avatarHtml}</div>
                    <div class="as-info">
                        <div class="as-name">${acc.username}</div>
                        <div class="as-handle">${acc.email}</div>
                    </div>
                    <div class="as-radio"></div>
                `;
                
                div.onclick = () => handleAccountSwitch(acc.uid);
                accountListContent.appendChild(div);
            });
        }

        window.handleAddAccount = () => {
            closeAccountSwitcher();
            signOut(auth).then(() => {
                // Redirect to login (Auth Screen handles this)
                // Note: Auth listener will reset currentUser to null and show auth screen
                // IMPORTANT: Do NOT clear localStorage accounts here
            });
        };

        window.handleCreateAccount = () => {
             closeAccountSwitcher();
             signOut(auth).then(() => {
                 // Trigger "Join Clan" view immediately
                 setTimeout(() => {
                     document.getElementById('toggle-auth').click(); 
                 }, 500);
             });
        };

        window.handleAccountSwitch = (targetUid) => {
            if(currentUser && currentUser.uid === targetUid) {
                closeAccountSwitcher();
                return; // Already on this account
            }
            
            const accounts = JSON.parse(localStorage.getItem('ninja_accounts') || '[]');
            const targetAcc = accounts.find(a => a.uid === targetUid);
            
            if(targetAcc) {
                // Pre-fill email in login form logic
                document.getElementById('email').value = targetAcc.email;
            }
            
            signOut(auth);
            closeAccountSwitcher();
        };


        // --- CHAT WALLPAPER LOGIC (30 ITEMS + PREVIEW) ---
        window.openChatBackgroundSettings = () => {
            history.pushState({page: 'wallpaper'}, 'Chat Background', '#wallpaper');
            
            const screen = document.getElementById('chat-wallpaper-screen');
            screen.style.display = 'flex';
            setTimeout(() => screen.classList.add('active'), 10);
            
            // Hide details screen if open
            chatDetailScreen.style.display = 'none';
            
            renderChatWallpapers();
        };

        window.closeChatWallpaperScreen = () => {
            if(!isSystemBack && history.state && history.state.page === 'wallpaper') { history.back(); return; }
            const screen = document.getElementById('chat-wallpaper-screen');
            screen.classList.remove('active');
            setTimeout(() => screen.style.display = 'none', 300);
            
            // Return to details screen
            chatDetailScreen.style.display = 'flex';
        };

        window.renderChatWallpapers = () => {
            const basicGrid = document.getElementById('basic-wall-grid');
            const vipGrid = document.getElementById('vip-wall-grid');
            basicGrid.innerHTML = '';
            vipGrid.innerHTML = '';

            // 1. Basic Wallpapers (30 Colors/Gradients/Patterns)
            const basicColors = [
                '#efe7dd', '#ffffff', '#ffebed', '#e3f2fd', '#e8f5e9', '#fff3e0', '#f3e5f5', '#eceff1', '#262d31', '#0b141a',
                '#dcedc8', '#b2dfdb', '#b3e5fc', '#d1c4e9', '#f8bbd0', '#ffccbc', '#ffe0b2', '#fff9c4', '#cfd8dc', '#b0bec5',
                '#546e7a', '#455a64', '#37474f', '#263238', '#212121', '#424242', '#616161', '#757575', '#9e9e9e', '#bdbdbd'
            ];
            
            // Gallery Upload Option (First Item)
            const uploadDiv = document.createElement('div');
            uploadDiv.className = 'wallpaper-option wallpaper-upload';
            uploadDiv.innerHTML = '<i class="fa-solid fa-image"></i><span style="font-size:9px; font-weight:bold; margin-top:5px;">GALLERY</span>';
            uploadDiv.onclick = () => document.getElementById('wall-upload-input').click();
            basicGrid.appendChild(uploadDiv);

            basicColors.forEach(color => {
                const div = document.createElement('div');
                div.className = 'wallpaper-option';
                div.style.backgroundColor = color;
                // NEW: Open Preview
                div.onclick = () => openWallpaperPreview(color, false);
                basicGrid.appendChild(div);
            });

            // 2. VIP Wallpapers (30 Premium Images)
            const vipImages = [
                'https://wallpaperaccess.com/full/1567834.jpg', // Neon City
                'https://i.pinimg.com/736x/8c/98/99/8c98994518b575bfd8c949e91d20548b.jpg', // Abstract Dark
                'https://i.pinimg.com/736x/2d/e8/82/2de882cd4f43463b5c46433230573906.jpg', // Ninja Red
                'https://images.unsplash.com/photo-1492144534655-ae79c964c9d7', // Sports Car
                'https://i.pinimg.com/originals/20/4b/c9/204bc990264df74737f2269562770c64.jpg', // Joker/Attitude
                'https://i.pinimg.com/736x/f6/89/3e/f6893e37036d0b4972e3647343e0d693.jpg', // Gold Luxury
                'https://wallpapercave.com/wp/wp5099307.jpg', // Galaxy Purple
                'https://images.unsplash.com/photo-1511512578047-dfb367046420', // Cyberpunk
                'https://i.pinimg.com/originals/97/c0/07/97c00726d1d93699a7732a3927429672.jpg', // Pastel Clouds
                'https://wallpapercave.com/wp/wp4462630.jpg', // Anime Scenery
                'https://i.pinimg.com/originals/e7/76/01/e77601f021f47970535359d9f9479261.jpg', // Cute Cat
                'https://i.pinimg.com/736x/58/c3/33/58c33377dfcbb3022493dec49d098b02.jpg', // Nature Soft
                'https://wallpapers.com/images/hd/cute-phone-background-859-x-1527-3h54422233213.jpg', // Cute Pink
                'https://i.pinimg.com/736x/18/d9/33/18d93333333333333333333333333333.jpg', // Minimal Bear
                'https://w0.peakpx.com/wallpaper/70/609/HD-wallpaper-whatsapp-background-pattern-patterns-texture-whatsapp-backgrounds-thumbnail.jpg', // Doodle
                'https://wallpaperaccess.com/full/1251351.jpg', // Minimal Geometry
                'https://images.unsplash.com/photo-1550684848-fac1c5b4e853', // Vaporwave
                'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe', // Liquid Oil
                'https://i.pinimg.com/originals/6e/c3/38/6ec338d33e333333333333333333333.jpg', // Black Marble
                'https://wallpaperaccess.com/full/1131217.jpg', // Blue Smoke
                'https://i.pinimg.com/originals/c9/22/68/c92268d92cf85dd787463aa0ca601bf8.jpg', // Abstract Art
                'https://images.unsplash.com/photo-1531604250646-2f0e81856f29', // Neon Lights
                'https://images.unsplash.com/photo-1523821741446-edb2b68bb7a0', // Deep Forest
                'https://images.unsplash.com/photo-1534067783941-51c9c23637bc', // Starry Night
                'https://images.unsplash.com/photo-1507525428034-b723cf961d3e', // Beach Sunset
                'https://images.unsplash.com/photo-1519681393784-d120267933ba', // Mountain Night
                'https://images.unsplash.com/photo-1477346611705-65d1883cee1e', // Misty Mountains
                'https://images.unsplash.com/photo-1493246507139-91e8fad9978e', // Mountain Lake
                'https://images.unsplash.com/photo-1518173946687-a4c8892bbd9f', // Urban City
                'https://images.unsplash.com/photo-1480796927426-f609979314bd'  // Tokyo Night
            ];

            vipImages.forEach(imgUrl => {
                const div = document.createElement('div');
                div.className = 'wallpaper-option';
                if (!isVipUser) {
                    div.style.opacity = "0.5";
                    div.innerHTML = `<img src="${imgUrl}" class="wallpaper-thumb"><div style="position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;color:var(--gold);"><i class="fa-solid fa-lock"></i></div>`;
                    div.onclick = () => showToast("VIP Only Feature!");
                } else {
                    div.innerHTML = `<img src="${imgUrl}" class="wallpaper-thumb">`;
                    // NEW: Open Preview
                    div.onclick = () => openWallpaperPreview(imgUrl, true);
                }
                vipGrid.appendChild(div);
            });
        };

        // --- NEW PREVIEW LOGIC ---
        window.openWallpaperPreview = (src, isImage) => {
            pendingWallpaperSrc = isImage ? `url(${src})` : src;
            pendingWallpaperIsImage = isImage;
            
            const previewScreen = document.getElementById('wallpaper-preview-screen');
            const previewBody = document.getElementById('wp-preview-body');
            
            // Set preview background
            if (isImage) {
                previewBody.style.backgroundImage = `url(${src})`;
                previewBody.style.backgroundColor = 'transparent';
            } else {
                previewBody.style.backgroundImage = 'none';
                previewBody.style.backgroundColor = src;
            }
            
            previewScreen.style.display = 'flex';
        };

        window.closeWallpaperPreview = () => {
            document.getElementById('wallpaper-preview-screen').style.display = 'none';
            pendingWallpaperSrc = '';
        };

        window.applyWallpaperFromPreview = async () => {
            if(!pendingWallpaperSrc) return;
            
            const roomIdentifier = isChannelChat ? currentChannelId : currentChatIdString;
            if(!roomIdentifier) { showToast("Error setting wallpaper"); return; }

            // Save to Firebase
            await update(ref(db, `user-chat-settings/${currentUser.uid}/${roomIdentifier}`), {
                background: pendingWallpaperSrc
            });

            showToast("Background Set!");
            
            // Apply immediately to current chat view if open underneath
            applyChatBackground(roomIdentifier);
            
            closeWallpaperPreview();
            closeChatWallpaperScreen(); // Go back to details
        };

        window.handleWallpaperUpload = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const base64 = ev.target.result;
                openWallpaperPreview(base64, true); // Open Preview with Base64
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        };

        function applyChatBackground(roomId) {
            const msgsDiv = document.getElementById('chat-messages');
            
            // Default styling reset
            msgsDiv.style.backgroundSize = 'cover';
            msgsDiv.style.backgroundPosition = 'center';
            
            get(ref(db, `user-chat-settings/${currentUser.uid}/${roomId}/background`)).then(snap => {
                const bg = snap.val();
                if(bg) {
                    if(bg.startsWith('url')) {
                        msgsDiv.style.backgroundImage = bg;
                        msgsDiv.style.backgroundColor = 'transparent';
                    } else {
                        msgsDiv.style.backgroundImage = 'none';
                        msgsDiv.style.backgroundColor = bg;
                    }
                } else {
                    // Default
                    msgsDiv.style.backgroundImage = 'none';
                    msgsDiv.style.backgroundColor = '#ffffff';
                }
            });
        }

        // --- THEME SCREEN LOGIC (VIP ONLY & MODERNIZED) ---
        let selectedThemeColor = '#d32f2f'; // Default

        window.openThemeScreen = () => {
            if(!isVipUser) {
                showToast("VIP Feature Only!");
                return;
            }

            history.pushState({page: 'theme'}, 'Theme', '#theme');
            const screen = document.getElementById('theme-screen');
            screen.style.display = 'flex';
            setTimeout(() => screen.classList.add('active'), 10);
            document.getElementById('settings-screen').classList.remove('active');
            
            // Hide details if coming from there
            chatDetailScreen.style.display = 'none';

            const currentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
            // Modern Preview updates
            document.getElementById('theme-preview-bubble').style.backgroundColor = currentColor;
            document.getElementById('theme-preview-title-span').style.color = currentColor;
        };

        window.closeThemeScreen = () => {
            if(!isSystemBack && history.state && history.state.page === 'theme') { history.back(); return; }
            const screen = document.getElementById('theme-screen');
            screen.classList.remove('active');
            setTimeout(() => screen.style.display = 'none', 300);
            
            // Return logic
            if(chatScreen.classList.contains('active')) {
                chatDetailScreen.style.display = 'flex'; 
            } else {
                document.getElementById('settings-screen').classList.add('active');
            }
        };

        window.selectThemeColor = (color, element) => {
            selectedThemeColor = color;
            document.querySelectorAll('.color-bubble').forEach(b => b.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('theme-preview-bubble').style.backgroundColor = color;
            document.getElementById('theme-preview-title-span').style.color = color;
        };

        window.applyTheme = () => {
            document.documentElement.style.setProperty('--accent', selectedThemeColor);
            
            if(currentUser) {
                update(ref(db, `users/${currentUser.uid}/settings`), { themeColor: selectedThemeColor });
                localStorage.setItem('ninja_accent', selectedThemeColor); 
            }
            showToast("Theme Applied Successfully!");
            renderNinjaStickers(); // Refresh stickers with new color
            setTimeout(closeThemeScreen, 500);
        };

        // --- NEW: CHAT DETAILS SCREEN LOGIC ---
        window.openChatDetails = async () => {
            if(isAdminChat) { showToast("Admin Channel Info"); return; }
            history.pushState({page: 'chatDetails'}, 'Info', '#details');
            
            const name = document.getElementById('chat-room-name').innerText;
            document.getElementById('cd-name-disp').innerText = name;
            
            const avatarEl = document.getElementById('cd-avatar-disp');
            if (activeChatAvatarHTML.includes('<img')) {
                const src = activeChatAvatarHTML.match(/src="([^"]*)"/)[1];
                avatarEl.innerHTML = `<img src="${src}" class="custom-user-img">`;
            } else {
                avatarEl.innerHTML = activeChatAvatarHTML.replace('width:38px; height:38px;', 'font-size:40px;'); 
            }

            const subDisp = document.getElementById('cd-sub-disp');
            const mediaGrid = document.getElementById('cd-media-grid');
            const blockCol = document.getElementById('cd-block-col');
            const membersOption = document.getElementById('cd-members-option');
            
            mediaGrid.innerHTML = '<div class="loader"></div>';

            if(isChannelChat) {
                // Channel/Group Logic
                blockCol.style.display = 'none'; // Can't block group
                subDisp.innerText = "Group Info";
                membersOption.style.display = 'flex';
                
                get(ref(db, `channels/${currentChannelId}`)).then(snap => {
                    const data = snap.val();
                    if(data) {
                        subDisp.innerText = `${Object.keys(data.members || {}).length} participants`;
                    }
                });

                loadMediaGallery(`channel-messages/${currentChannelId}`);

            } else {
                // Private Chat Logic
                blockCol.style.display = 'flex';
                membersOption.style.display = 'none';
                
                get(ref(db, `users/${currentChatUserUid}`)).then(snap => {
                    const u = snap.val();
                    if(u) subDisp.innerText = u.email || "Ninja User";
                });

                const chatId = [currentUser.uid, currentChatUserUid].sort().join('_');
                loadMediaGallery(`private-messages/${chatId}`);
            }

            chatDetailScreen.style.display = 'flex';
        };

        window.closeChatDetails = () => {
            if(!isSystemBack && history.state && history.state.page === 'chatDetails') { history.back(); return; }
            chatDetailScreen.style.display = 'none';
        };

        function loadMediaGallery(path) {
            const mediaGrid = document.getElementById('cd-media-grid');
            const q = query(ref(db, path), limitToLast(50));
            
            get(q).then(snap => {
                mediaGrid.innerHTML = '';
                const msgs = snap.val();
                if(!msgs) {
                    mediaGrid.innerHTML = '<div style="grid-column:1/-1; padding:20px; text-align:center; color:#999; font-size:12px;">No media shared</div>';
                    return;
                }
                
                const mediaItems = [];
                Object.values(msgs).forEach(msg => {
                    if(msg.type === 'image' || msg.type === 'video') {
                        mediaItems.push(msg);
                    }
                });
                
                if(mediaItems.length === 0) {
                    mediaGrid.innerHTML = '<div style="grid-column:1/-1; padding:20px; text-align:center; color:#999; font-size:12px;">No media shared</div>';
                    return;
                }
                
                mediaItems.reverse().forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'cd-grid-item';
                    
                    if(item.type === 'image') {
                        div.innerHTML = `<img src="${item.image}">`;
                        div.onclick = () => openLightbox(item.image);
                    } else {
                        div.innerHTML = `<video src="${item.video}#t=0.1" preload="metadata"></video><div class="cd-vid-icon"><i class="fa-solid fa-video"></i></div>`;
                        div.onclick = () => openLightbox(item.video, true);
                    }
                    mediaGrid.appendChild(div);
                });
            });
        }

        // --- PINNED SLIDER LOGIC ---
        window.openPinnedSheet = () => {
            pinnedSheetOverlay.style.display = 'block';
            pinnedSheet.classList.add('open');
            // Mock logic for demo, fetch real pinned messages if implemented
            const grid = document.getElementById('pinned-grid-content');
            if(!grid.hasChildNodes() || grid.innerHTML.includes('No pinned')) {
                 // Try to load images from chat as "pinned" for now
                 const chatId = isChannelChat ? `channel-messages/${currentChannelId}` : `private-messages/${[currentUser.uid, currentChatUserUid].sort().join('_')}`;
                 const q = query(ref(db, chatId), limitToLast(10));
                 get(q).then(snap => {
                     const data = snap.val();
                     if(data) {
                         grid.innerHTML = '';
                         Object.values(data).forEach(msg => {
                             if(msg.type === 'image') {
                                 grid.innerHTML += `<div class="cd-grid-item" onclick="openLightbox('${msg.image}')"><img src="${msg.image}"></div>`;
                             }
                         });
                         if(grid.innerHTML === '') grid.innerHTML = '<div style="grid-column:1/-1; padding:20px; text-align:center; color:#999;">No pinned items found.</div>';
                     }
                 });
            }
        };

        window.closePinnedSheet = () => {
            pinnedSheet.classList.remove('open');
            setTimeout(() => { pinnedSheetOverlay.style.display = 'none'; }, 300);
        };

        window.toggleChatPin = () => {
            openPinnedSheet(); 
        };

        window.toggleChatBlock = () => {
             if(currentChatUserUid) {
                 openCustomModal("Block User?", "They won't be able to message you.", async () => {
                      await update(ref(db, `blocked_users/${currentUser.uid}`), { [currentChatUserUid]: true });
                      showToast("User Blocked");
                      closeChatDetails();
                      closeChat();
                 });
             }
        };

        window.showGroupMembersList = () => {
            closeChatDetails();
            openChannelInfo(); 
        };

        // --- BLOCKED USERS LOGIC ---
        window.openBlockedUsersScreen = () => {
            history.pushState({page: 'blocked'}, 'Blocked', '#blocked');
            blockedUsersScreen.style.display = 'flex';
            setTimeout(() => blockedUsersScreen.classList.add('active'), 10);
            
            const list = document.getElementById('blocked-list-container');
            list.innerHTML = '<div class="loader"></div>';
            
            get(ref(db, `blocked_users/${currentUser.uid}`)).then(async snap => {
                list.innerHTML = '';
                const blocked = snap.val();
                if(!blocked) {
                    list.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">No blocked users.</div>';
                    return;
                }
                
                for (const uid of Object.keys(blocked)) {
                    const userSnap = await get(ref(db, `users/${uid}`));
                    const u = userSnap.val();
                    const name = u ? u.username : "Unknown";
                    
                    const div = document.createElement('div');
                    div.className = 'blocked-card';
                    div.innerHTML = `
                        <div class="blocked-info" onclick="viewUserProfile('${uid}', '${name}', 'Blocked')">
                            <div class="avatar"><i class="fa-solid fa-user-slash"></i></div>
                            <div style="font-weight:700;">${name}</div>
                        </div>
                        <button class="unblock-btn" onclick="unblockUser('${uid}')">Unblock</button>
                    `;
                    list.appendChild(div);
                }
            });
            document.getElementById('settings-screen').classList.remove('active');
        };

        window.closeBlockedUsersScreen = () => {
             if(!isSystemBack && history.state && history.state.page === 'blocked') { history.back(); return; }
             blockedUsersScreen.classList.remove('active');
             setTimeout(() => blockedUsersScreen.style.display = 'none', 300);
             document.getElementById('settings-screen').classList.add('active');
        };

        window.unblockUser = async (uid) => {
            await remove(ref(db, `blocked_users/${currentUser.uid}/${uid}`));
            showToast("User Unblocked");
            openBlockedUsersScreen(); 
        };

        window.handleBlockFromLongPress = () => {
            if(!selectedContactId) return;
            closeContactOptions();
            openCustomModal("Block User?", "Are you sure you want to block this ninja?", async () => {
                 await update(ref(db, `blocked_users/${currentUser.uid}`), { [selectedContactId]: true });
                 showToast("User Blocked");
            });
        };

        // --- PAPERCLIP & CROP LOGIC ---
        function setupPaperclipInteraction() {
            const btn = document.getElementById('paperclip-btn');
            let startY = 0;
            let isDragging = false;

            btn.addEventListener('click', (e) => {
                 toggleAttachmentMenu();
            });

            btn.addEventListener('touchstart', (e) => {
                e.preventDefault(); 
                e.stopPropagation();
                isDragging = true;
                startY = e.touches[0].clientY;
                btn.style.transition = 'transform 0.1s ease-out';
                btn.style.transform = 'rotate(45deg) scale(1.2)'; 
            }, {passive: false});

            btn.addEventListener('touchmove', (e) => {
                if(!isDragging) return;
                e.preventDefault();
                e.stopPropagation();
                
                const y = e.touches[0].clientY;
                const diff = Math.abs(startY - y); 
                
                let scale = 1.2 + (diff / 100); 
                if(scale > 2.5) scale = 2.5; 
                
                btn.style.transform = `rotate(45deg) scale(${scale})`;
            }, {passive: false});

            btn.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                isDragging = false;
                
                btn.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                btn.style.transform = 'rotate(45deg) scale(1)';
                
                toggleAttachmentMenu();
            });
        }
        
        function setupCropDrag() {
            if(!cropImageContainer) return;

            const handleStart = (clientX, clientY) => {
                isDraggingCrop = true;
                cropStartDragX = clientX - cropPosX;
                cropStartDragY = clientY - cropPosY;
            };

            const handleMove = (clientX, clientY) => {
                if(!isDraggingCrop) return;
                cropPosX = clientX - cropStartDragX;
                cropPosY = clientY - cropStartDragY;
                
                const zoom = cropZoomSlider.value;
                cropTargetImg.style.transform = `translate(${cropPosX}px, ${cropPosY}px) scale(${zoom})`;
            };

            const handleEnd = () => {
                isDraggingCrop = false;
            };

            cropImageContainer.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleStart(e.touches[0].clientX, e.touches[0].clientY);
            }, {passive: false});

            cropImageContainer.addEventListener('touchmove', (e) => {
                e.preventDefault();
                handleMove(e.touches[0].clientX, e.touches[0].clientY);
            }, {passive: false});

            cropImageContainer.addEventListener('touchend', handleEnd);
            
            cropImageContainer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                handleStart(e.clientX, e.clientY);
            });
            document.addEventListener('mousemove', (e) => {
                if(isDraggingCrop) {
                    e.preventDefault();
                    handleMove(e.clientX, e.clientY);
                }
            });
            document.addEventListener('mouseup', handleEnd);
        }

        window.onpopstate = (e) => {
            isSystemBack = true;
            checkAndCloseActiveScreens();
            isSystemBack = false;
        };

        function checkAndCloseActiveScreens() {
            if (qrScannerScreen.style.display === 'flex') { closeQRScanner(); return; }
            if (document.getElementById('lightbox').style.display === 'flex') { closeLightbox(); return; }
            if (document.getElementById('story-preview-screen').style.display === 'flex') { closeStoryPreview(); return; }
            if (dpCropScreen.style.display === 'flex') { closeCropScreen(); return; }
            if (document.getElementById('icon-picker-modal').style.display === 'flex') { closeIconPicker(); return; }
            if (vipLandingScreen.style.display === 'flex') { closeVipScreen(); return; }
            if (vipPurchaseScreen.style.display === 'flex') { closeVipPurchase(); return; }
            if (document.getElementById('custom-modal-overlay').style.display === 'flex') { closeCustomModal(); return; }
            if (storyViewerScreen.style.display === 'flex') { closeStoryViewer(); return; }
            if (shareProfileScreen.style.display === 'flex') { closeShareProfile(); return; }
            
            if (document.getElementById('theme-screen').style.display === 'flex') { closeThemeScreen(); return; }
            if (document.getElementById('wallpaper-preview-screen').style.display === 'flex') { closeWallpaperPreview(); return; }
            if (document.getElementById('chat-wallpaper-screen').style.display === 'flex') { closeChatWallpaperScreen(); return; }
            if (chatDetailScreen.style.display === 'flex') { closeChatDetails(); return; }
            if (blockedUsersScreen.style.display === 'flex') { closeBlockedUsersScreen(); return; }
            if (pinnedSheet.classList.contains('open')) { closePinnedSheet(); return; }
            if (accountSwitcherSheet.classList.contains('open')) { closeAccountSwitcher(); return; }

            if (pocketDetailScreen.style.display === 'flex') { closePocketDetail(); return; }
            if (newChatScreen.style.display === 'flex') { closeNewChat(); return; }
            if (pocketScreen.style.display === 'flex') { closePocketScreen(); return; }
            if (walletScreen.style.display === 'flex') { closeWalletScreen(); return; } // WALLET CLOSE
            if (chatScreen.classList.contains('active')) { closeChat(); return; }
            if (createChannelScreen.classList.contains('active')) { closeCreateChannel(); return; }
            if (channelInfoScreen.classList.contains('active')) { closeChannelInfo(); return; }
            if (leaderboardScreen.classList.contains('active')) { closeLeaderboard(); return; }
            if (viewProfileScreen.classList.contains('active')) { closeViewProfile(); return; }
            if (editProfileScreen.classList.contains('active')) { closeEditProfile(); return; }
            if (adminDashboardScreen.classList.contains('active')) { closeAdminPanel(); return; }
            if (notificationScreen.classList.contains('active')) { closeNotifications(); return; }
            if (creatorScreen.style.display === 'flex') { closeCreatorScreen(); return; }
            if (document.getElementById('settings-screen').classList.contains('active')) { closeSettings(); return; }
            if (document.getElementById('group-options-modal').style.display === 'flex') { closeGroupOptions(); return; }

            const profileNav = document.getElementById('nav-profile');
            if(profileNav.classList.contains('active-nav')) {
                switchTab('home');
            }
        }

        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                document.body.style.height = `${window.visualViewport.height}px`;
                if(chatScreen.classList.contains('active')) {
                    setTimeout(() => smoothScrollToBottom(), 100);
                }
            });
        }

        function renderSkeleton(containerId, count = 3) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            for(let i=0; i<count; i++) {
                const div = document.createElement('div');
                div.className = 'sk-list-item';
                div.innerHTML = `
                    <div class="skeleton sk-avatar"></div>
                    <div class="sk-info">
                        <div class="skeleton sk-line-1"></div>
                        <div class="skeleton sk-line-2"></div>
                    </div>
                `;
                container.appendChild(div);
            }
        }

        function renderPocketSkeleton() {
            pocketGridContent.innerHTML = '';
            for(let i=0; i<15; i++) {
                const div = document.createElement('div');
                div.className = 'pocket-skeleton-item';
                pocketGridContent.appendChild(div);
            }
        }

        window.showToast = (msg) => {
            toastBox.innerHTML = msg;
            toastBox.classList.add('show');
            setTimeout(() => { toastBox.classList.remove('show'); }, 2000);
        };

        const usernameInput = document.getElementById('username');
        const usernameError = document.getElementById('username-error');

        usernameInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\s+/g, '_');
        });

        document.getElementById('toggle-auth').addEventListener('click', () => {
            isLogin = !isLogin;
            const userIn = document.getElementById('username');
            const btn = document.getElementById('auth-btn');
            const txt = document.getElementById('toggle-auth');
            usernameError.style.display = 'none'; 
            
            if(isLogin) { 
                userIn.style.display = 'none'; 
                userIn.required = false; 
                btn.innerText = 'ENTER DOJO'; 
                txt.innerHTML = "Don't have an account? <b>Join Clan</b>"; 
            } else { 
                userIn.style.display = 'block'; 
                userIn.required = true; 
                btn.innerText = 'JOIN CLAN'; 
                txt.innerHTML = "Already a ninja? <b>Login</b>"; 
            }
        });

        // GOOGLE LOGIN LOGIC
        document.getElementById('google-login-btn').addEventListener('click', async () => {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                const user = result.user;
                
                const userRef = ref(db, `users/${user.uid}`);
                const snapshot = await get(userRef);
                
                if (!snapshot.exists()) {
                    const shortId = Math.floor(100000 + Math.random() * 900000).toString();
                    await set(userRef, {
                        username: user.displayName,
                        email: user.email,
                        uid: user.uid,
                        icon: 'custom',
                        customAvatar: user.photoURL,
                        shortId: shortId,
                        isBanned: false
                    });
                }
            } catch (error) {
                console.error(error);
                showToast("Google Login Failed: " + error.message);
            }
        });

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            let name = document.getElementById('username').value.trim();
            const err = document.getElementById('error-msg');
            const btn = document.getElementById('auth-btn');
            const originalText = btn.innerText;
            
            btn.innerHTML = '<div class="btn-loader"></div> Processing...'; btn.disabled = true; err.innerText = '';
            usernameError.style.display = 'none';

            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, pass);
                } else {
                    const usersRef = ref(db, 'users');
                    const snapshot = await get(usersRef);
                    if (snapshot.exists()) {
                        const users = Object.values(snapshot.val());
                        const isTaken = users.some(u => u.username.toLowerCase() === name.toLowerCase());
                        if (isTaken) {
                             usernameError.innerText = "Username already exists! Try another.";
                             usernameError.style.display = 'block';
                             btn.innerText = originalText; btn.disabled = false;
                             return;
                        }
                    }

                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    await updateProfile(cred.user, { displayName: name });
                    const shortId = Math.floor(100000 + Math.random() * 900000).toString();
                    await set(ref(db, `users/${cred.user.uid}`), { username: name, email: email, uid: cred.user.uid, icon: 'fa-user-ninja', shortId: shortId, isBanned: false });
                    window.location.reload();
                }
            } catch (error) {
                let customMsg = "An error occurred.";
                if(error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    customMsg = "Invalid Email or Password!";
                } else if (error.code === 'auth/invalid-email') {
                    customMsg = "Please enter a valid email format.";
                } else if (error.code === 'auth/email-already-in-use') {
                    customMsg = "Email already in use. Try logging in.";
                } else if (error.code === 'auth/too-many-requests') {
                    customMsg = "Too many attempts. Try again later.";
                } else {
                    customMsg = error.message.replace('Firebase: ', '');
                }
                
                err.innerText = customMsg; 
                btn.innerText = originalText; btn.disabled = false; 
            }
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                authScreen.classList.remove('active');
                homeScreen.classList.add('active');
                mainNav.classList.add('visible'); 
                
                // SAVE ACCOUNT TO STORAGE FOR SWITCHER
                saveAccountToStorage(user);

                onValue(ref(db, `users/${user.uid}/isBanned`), (snap) => {
                    const isBanned = snap.val();
                    if(isBanned === true) {
                        banScreen.style.display = 'flex';
                    } else {
                        banScreen.style.display = 'none';
                    }
                });
                
                // LOAD THEME FROM FIREBASE (VIP ONLY Logic)
                get(ref(db, `users/${user.uid}`)).then(snap => {
                    const uData = snap.val();
                    if(uData && uData.isVip && uData.settings && uData.settings.themeColor) {
                        const cloudTheme = uData.settings.themeColor;
                        document.documentElement.style.setProperty('--accent', cloudTheme);
                        localStorage.setItem('ninja_accent', cloudTheme);
                        selectedThemeColor = cloudTheme;
                    } else {
                        // Reset if not VIP
                        document.documentElement.style.setProperty('--accent', '#d32f2f');
                    }
                });

                setupPresence();
                loadHomeChats();
                loadDiscoverUsers();
                loadRequests();
                loadChannels(); 
                setupSwipeNav(); 
                listenForIncomingCalls();
                loadMyProfile(); 
                markPendingMessagesAsDelivered(user.uid);
                listenForAdminMessages(); 
            } else {
                currentUser = null;
                // RESET THEME ON LOGOUT
                document.documentElement.style.setProperty('--accent', '#d32f2f');
                localStorage.removeItem('ninja_accent');
                
                authScreen.classList.add('active');
                homeScreen.classList.remove('active');
                mainNav.classList.remove('visible'); 
                banScreen.style.display = 'none';
                const btn = document.getElementById('auth-btn');
                btn.innerText = isLogin ? 'ENTER DOJO' : 'JOIN CLAN';
                btn.disabled = false;
            }
        });

        function markPendingMessagesAsDelivered(myUid) {
            get(ref(db, `user-contacts/${myUid}`)).then((snapshot) => {
                if(snapshot.exists()) {
                    snapshot.forEach(childSnap => {
                        const contactUid = childSnap.key;
                        const chatId = [myUid, contactUid].sort().join('_');
                        const chatRef = ref(db, `private-messages/${chatId}`);
                        get(chatRef).then((msgSnap) => {
                             if(msgSnap.exists()) {
                                 msgSnap.forEach(m => {
                                     const msg = m.val();
                                     if(msg.uid !== myUid && msg.status === 'sent') {
                                         update(ref(db, `private-messages/${chatId}/${m.key}`), { status: 'delivered' });
                                     }
                                 });
                             }
                        });
                    });
                }
            });
        }

        function listenForAdminMessages() {
            if(!currentUser) return;
            const adminChatId = [currentUser.uid, 'admin'].sort().join('_');
            const q = query(ref(db, `private-messages/${adminChatId}`), limitToLast(1));
            
            onValue(q, (snap) => {
                const msgs = snap.val();
                if(msgs) {
                    const lastMsg = Object.values(msgs)[0];
                    if((lastMsg.uid === 'admin' || lastMsg.sender === 'Admin') && currentChatUserUid !== 'admin') {
                         document.getElementById('admin-msg-dot').classList.add('active');
                    }
                }
            });
        }

        window.openNewChat = () => {
            history.pushState({page: 'newchat'}, 'New Chat', '#newchat');
            newChatScreen.style.display = 'flex';
            
            const contactListContainer = document.getElementById('new-chat-contact-list');
            contactListContainer.innerHTML = '';
            
            get(ref(db, `user-contacts/${currentUser.uid}`)).then(async (snapshot) => {
                const contacts = snapshot.val();
                if(contacts) {
                    let delay = 0;
                    for (const contact of Object.values(contacts)) {
                            const userSnap = await get(ref(db, `users/${contact.uid}`));
                            const userData = userSnap.val();
                            
                            let avatarHtml = '';
                            if (userData && userData.icon === 'custom' && userData.customAvatar) {
                                avatarHtml = `<img src="${userData.customAvatar}" style="width:100%; height:100%; object-fit:cover;">`;
                            } else {
                                const icon = userData && userData.icon ? userData.icon : 'fa-user-ninja';
                                avatarHtml = `<i class="fa-solid ${icon}"></i>`;
                            }

                        const row = document.createElement('div');
                        row.className = 'nc-contact-row slide-in-up';
                        row.style.animationDelay = `${delay}s`;
                        row.onclick = () => {
                            closeNewChat();
                            openChat(contact.uid, contact.name, true);
                        };
                        
                        row.innerHTML = `
                            <div class="nc-contact-avatar">${avatarHtml}</div>
                            <div class="nc-contact-info">
                                <h4>${contact.name}</h4>
                                <p>Tap to message</p>
                            </div>
                            <div class="nc-add-icon"><i class="fa-regular fa-comment-dots"></i></div>
                        `;
                        
                        contactListContainer.appendChild(row);
                        delay += 0.05;
                    }
                } else {
                        contactListContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">No contacts found. Use Discover to find Ninjas.</div>';
                }
            });
        };

        window.closeNewChat = () => {
            if(!isSystemBack && history.state && history.state.page === 'newchat') { history.back(); return; }
            newChatScreen.style.display = 'none';
        };
        
        window.openPocketScreen = () => {
            history.pushState({page: 'pocket'}, 'Pocket', '#pocket');
            pocketScreen.style.display = 'flex';
            updatePocketStats();
            profileScreen.classList.remove('active');
            mainNav.classList.remove('visible');
        };

        // --- NEW WALLET FUNCTIONS ---
        window.openWalletScreen = () => {
            history.pushState({page: 'wallet'}, 'Wallet', '#wallet');
            walletScreen.style.display = 'flex';
            settingsScreen.classList.remove('active');
        };

        window.closeWalletScreen = () => {
            if(!isSystemBack && history.state && history.state.page === 'wallet') { history.back(); return; }
            walletScreen.style.display = 'none';
            settingsScreen.classList.add('active');
        };

        async function updatePocketStats() {
            const storageText = document.getElementById('pocket-storage-text');
            const storagePercent = document.getElementById('storage-percent');
            
            if(isVipUser) {
                storagePercent.innerText = "5%";
                storageText.innerText = "5GB of 100GB Used";
            } else {
                storagePercent.innerText = "45%";
                storageText.innerText = "450MB of 1GB Used";
            }

            const photoSnap = await get(ref(db, `pocket/${currentUser.uid}/photos`));
            const videoSnap = await get(ref(db, `pocket/${currentUser.uid}/videos`));
            
            const photoCount = photoSnap.exists() ? Object.keys(photoSnap.val()).length : 0;
            const videoCount = videoSnap.exists() ? Object.keys(videoSnap.val()).length : 0;
            
            document.getElementById('count-photos').innerText = `${photoCount} Items`;
            document.getElementById('count-videos').innerText = `${videoCount} Items`;
        }

        window.closePocketScreen = () => {
            if(!isSystemBack && history.state && history.state.page === 'pocket') { history.back(); return; }
            pocketScreen.style.display = 'none';
            profileScreen.classList.add('active');
            mainNav.classList.add('visible');
        };

        window.openPocketDetail = (type) => {
            history.pushState({page: 'pocketDetail'}, 'Pocket Detail', '#pocketDetail');
            currentPocketType = type;
            pocketDetailTitle.innerText = type === 'photos' ? 'My Photos' : 'My Videos';
            const input = document.getElementById('pocket-upload-input');
            if(type === 'photos') input.accept = 'image/*';
            else input.accept = 'video/*';
            pocketDetailScreen.style.display = 'flex';
            renderPocketSkeleton();
            loadPocketItems(type);
        };

        window.closePocketDetail = () => {
            if(!isSystemBack && history.state && history.state.page === 'pocketDetail') { history.back(); return; }
            pocketDetailScreen.style.display = 'none';
        };

        window.triggerPocketUpload = () => {
            document.getElementById('pocket-upload-input').click();
        };

        window.handlePocketFileSelect = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            if(file.size > 5 * 1024 * 1024) {
                showToast("File too large (Max 5MB)");
                return;
            }
            showToast("Saving to Cloud...");
            const reader = new FileReader();
            reader.onload = (ev) => {
                uploadToPocket(ev.target.result);
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        };

        window.uploadToPocket = async (base64) => {
            await push(ref(db, `pocket/${currentUser.uid}/${currentPocketType}`), {
                media: base64,
                timestamp: Date.now()
            });
            showToast("Saved Successfully!");
            updatePocketStats();
        };

        window.loadPocketItems = (type) => {
            onValue(ref(db, `pocket/${currentUser.uid}/${type}`), (snap) => {
                pocketGridContent.innerHTML = '';
                const data = snap.val();
                if(!data) {
                    pocketGridContent.innerHTML = `<div style="grid-column: 1/-1; padding:20px; text-align:center; color:#999; font-size:12px;">No ${type} saved yet.</div>`;
                    return;
                }
                Object.values(data).reverse().forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'insta-item';
                    if(type === 'photos') {
                        div.innerHTML = `<img src="${item.media}">`;
                        div.onclick = () => openLightbox(item.media);
                    } else {
                        div.innerHTML = `<video src="${item.media}#t=0.1" preload="metadata"></video><div class="insta-vid-icon"><i class="fa-solid fa-video"></i></div>`;
                        div.onclick = () => openLightbox(item.media, true);
                    }
                    pocketGridContent.appendChild(div);
                });
            });
        };

        window.handleEditProfile = async () => {
            history.pushState({page: 'editProfile'}, 'Edit Profile', '#editProfile');
            const userSnap = await get(ref(db, `users/${currentUser.uid}`));
            const userData = userSnap.val();
            document.getElementById('edit-p-name').value = currentUser.displayName;
            document.getElementById('edit-p-bio').value = userData.bio || '';
            const iconPreview = document.getElementById('edit-p-icon-preview');
            if (userData.icon === 'custom' && userData.customAvatar) {
                 iconPreview.innerHTML = `<img src="${userData.customAvatar}" class="custom-user-img">`;
                 tempSelectedIcon = null;
            } else {
                 currentProfileIcon = userData.icon || 'fa-user-ninja';
                 tempSelectedIcon = currentProfileIcon;
                 iconPreview.innerHTML = `<i class="fa-solid ${currentProfileIcon}"></i>`;
            }
            isVipUser = userData.isVip || false;
            editProfileScreen.style.display = 'flex';
            setTimeout(() => editProfileScreen.classList.add('active'), 10);
            profileScreen.classList.remove('active');
            mainNav.classList.remove('visible'); 
        };

        window.closeEditProfile = () => {
            if(!isSystemBack && history.state && history.state.page === 'editProfile') { history.back(); return; }
            editProfileScreen.classList.remove('active');
            setTimeout(() => editProfileScreen.style.display = 'none', 300);
            profileScreen.classList.add('active');
            mainNav.classList.add('visible');
        };

        window.handleSaveProfile = async () => {
            const newName = document.getElementById('edit-p-name').value;
            const newBio = document.getElementById('edit-p-bio').value;
            if(!newName) { showToast("Name cannot be empty"); return; }
            await updateProfile(currentUser, { displayName: newName });
            const updates = { username: newName, bio: newBio };
            if (tempSelectedIcon) { updates.icon = tempSelectedIcon; }
            await update(ref(db, `users/${currentUser.uid}`), updates);
            showToast("Profile Saved!");
            loadMyProfile(); 
            closeEditProfile();
        };

        window.openIconPicker = () => {
            iconPickerModal.style.display = 'flex';
            renderProfileIcons();
        };
        
        window.openIconPickerForGroup = () => {
             const input = document.getElementById('custom-profile-upload');
             window.isCroppingForGroup = true;
             input.click();
        };

        window.closeIconPicker = () => {
            iconPickerModal.style.display = 'none';
        };
        
        document.getElementById('custom-profile-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            openCropScreen(file);
        });

        window.openCropScreen = (file) => {
            history.pushState({page: 'crop'}, 'Crop', '#crop');
            const reader = new FileReader();
            reader.onload = (event) => {
                rawCropImage.src = event.target.result;
                rawCropImage.onload = () => {
                    cropTargetImg.src = rawCropImage.src;
                    cropZoomSlider.value = 1;
                    cropPosX = 0;
                    cropPosY = 0;
                    cropTargetImg.style.transform = 'translate(0px, 0px) scale(1)';
                    dpCropScreen.style.display = 'flex';
                    iconPickerModal.style.display = 'none';
                };
            };
            reader.readAsDataURL(file);
        };

        window.closeCropScreen = () => {
            if(!isSystemBack && history.state && history.state.page === 'crop') { history.back(); return; }
            dpCropScreen.style.display = 'none';
            document.getElementById('custom-profile-upload').value = ''; 
        };

        window.saveCroppedImage = () => {
            const saveBtn = document.querySelector('.crop-btn.save');
            const originalText = saveBtn.innerText;
            saveBtn.innerHTML = '<div class="btn-loader-red"></div> Processing...';
            saveBtn.disabled = true;

            setTimeout(() => {
                const imgEl = document.getElementById('crop-target-img');
                const viewportEl = document.querySelector('.crop-circle-border');
                const imgRect = imgEl.getBoundingClientRect();
                const viewRect = viewportEl.getBoundingClientRect();
                const scaleX = imgEl.naturalWidth / imgRect.width;
                const scaleY = imgEl.naturalHeight / imgRect.height;
                const cropX = (viewRect.left - imgRect.left) * scaleX;
                const cropY = (viewRect.top - imgRect.top) * scaleY;
                const cropWidth = viewRect.width * scaleX;
                const cropHeight = viewRect.height * scaleY;
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const size = 512;
                canvas.width = size;
                canvas.height = size;
                ctx.fillStyle = "#ffffff"; 
                ctx.fillRect(0,0, size, size);
                ctx.drawImage(imgEl, cropX, cropY, cropWidth, cropHeight, 0, 0, size, size);
                const base64 = canvas.toDataURL('image/jpeg', 0.90);

                if (window.isCroppingForGroup) {
                    const preview = document.getElementById('new-group-icon-preview');
                    preview.src = base64;
                    preview.style.display = 'block';
                    preview.dataset.base64 = base64; 
                    showToast("Group Icon Set!");
                    closeCropScreen();
                    window.isCroppingForGroup = false;
                    saveBtn.innerText = originalText;
                    saveBtn.disabled = false;
                } else {
                    update(ref(db, `users/${currentUser.uid}`), {
                            customAvatar: base64,
                            icon: 'custom'
                    }).then(() => {
                            showToast("Profile Photo Updated!");
                            document.getElementById('edit-p-icon-preview').innerHTML = `<img src="${base64}" class="custom-user-img">`;
                            tempSelectedIcon = null;
                            closeCropScreen();
                            closeIconPicker();
                            loadMyProfile();
                            saveBtn.innerText = originalText;
                            saveBtn.disabled = false;
                    });
                }
            }, 100);
        };

        window.renderProfileIcons = () => {
            const basicGrid = document.getElementById('basic-icon-grid');
            const vipGrid = document.getElementById('vip-icon-grid');
            basicGrid.innerHTML = '';
            vipGrid.innerHTML = '';
            const basicIcons = ['fa-user-ninja', 'fa-user-astronaut', 'fa-user-tie', 'fa-user-doctor', 'fa-user-graduate', 'fa-user-injured', 'fa-user-nurse', 'fa-user-shield', 'fa-user-clock', 'fa-user-pen'];
            const vipIcons = ['fa-dragon', 'fa-skull', 'fa-ghost', 'fa-fire', 'fa-bolt', 'fa-mask', 'fa-crown', 'fa-gem', 'fa-rocket', 'fa-shield-cat'];

            basicIcons.forEach(icon => {
                const div = document.createElement('div');
                div.className = `pf-icon-opt ${tempSelectedIcon === icon ? 'selected' : ''}`;
                div.innerHTML = `<i class="fa-solid ${icon}"></i>`;
                div.onclick = () => selectProfileIcon(icon);
                basicGrid.appendChild(div);
            });

            const plusDiv = document.createElement('div');
            plusDiv.className = 'pf-icon-opt';
            plusDiv.innerHTML = '<i class="fa-solid fa-plus"></i>';
            plusDiv.style.color = '#d32f2f'; 
            plusDiv.style.border = '2px dashed #d32f2f'; 
            plusDiv.style.backgroundColor = '#fff5f5'; 
            plusDiv.onclick = () => { window.isCroppingForGroup = false; document.getElementById('custom-profile-upload').click(); };
            basicGrid.appendChild(plusDiv);

            vipIcons.forEach(icon => {
                const div = document.createElement('div');
                if (isVipUser) {
                    div.className = `pf-icon-opt ${tempSelectedIcon === icon ? 'selected' : ''}`;
                    div.onclick = () => selectProfileIcon(icon);
                    div.innerHTML = `<i class="fa-solid ${icon} vip-gold-icon"></i>`;
                } else {
                    div.className = `pf-icon-opt vip-locked`;
                    div.onclick = () => showToast("Requires VIP Badge!");
                    div.innerHTML = `<i class="fa-solid ${icon}"></i>`;
                }
                vipGrid.appendChild(div);
            });
        };

        window.selectProfileIcon = (icon) => {
            tempSelectedIcon = icon;
            document.getElementById('edit-p-icon-preview').innerHTML = `<i class="fa-solid ${icon} ${isVipUser && ['fa-dragon', 'fa-skull', 'fa-ghost', 'fa-fire', 'fa-bolt', 'fa-mask', 'fa-crown', 'fa-gem', 'fa-rocket', 'fa-shield-cat'].includes(icon) ? 'vip-gold-icon' : ''}"></i>`;
            renderProfileIcons(); 
            setTimeout(() => { closeIconPicker(); }, 200);
        };

        window.buyVip = async () => {
             if(isVipUser) { showToast("You are already VIP!"); return; }
             const confirm = window.confirm("Become a VIP Ninja for Exclusive Icons?");
             if(confirm) {
                 await update(ref(db, `users/${currentUser.uid}`), { isVip: true });
                 isVipUser = true;
                 showToast("Welcome to VIP Club!");
                 loadMyProfile(); 
             }
        };

        // --- NEW VIP FLOW LOGIC ---
        window.openVipScreen = () => {
            if(isVipUser) { showToast("You are already VIP!"); return; }
            history.pushState({page: 'vipLanding'}, 'VIP', '#vip');
            
            // Show Modern Landing Page
            vipLandingScreen.style.display = 'flex';
            setTimeout(() => vipLandingScreen.classList.add('active'), 10);
            
            mainNav.classList.remove('visible');
        };

        window.closeVipScreen = () => {
            if(!isSystemBack && history.state && history.state.page === 'vipLanding') { history.back(); return; }
            
            vipLandingScreen.classList.remove('active');
            setTimeout(() => vipLandingScreen.style.display = 'none', 300);
            
            mainNav.classList.add('visible');
        };

        window.goToPurchaseScreen = () => {
            // Hide Landing
            vipLandingScreen.classList.remove('active');
            setTimeout(() => vipLandingScreen.style.display = 'none', 300);
            
            // Show Purchase
            history.pushState({page: 'vipPurchase'}, 'Purchase', '#purchase');
            vipPurchaseScreen.style.display = 'flex';
            setTimeout(() => vipPurchaseScreen.classList.add('active'), 10);
        };

        window.closeVipPurchase = () => {
            if(!isSystemBack && history.state && history.state.page === 'vipPurchase') { history.back(); return; }
            
            vipPurchaseScreen.classList.remove('active');
            setTimeout(() => vipPurchaseScreen.style.display = 'none', 300);
            
            // Go back to Landing
            vipLandingScreen.style.display = 'flex';
            setTimeout(() => vipLandingScreen.classList.add('active'), 10);
        };

        window.selectPlan = (planName, price) => {
            // Close purchase screen completely
            vipPurchaseScreen.classList.remove('active');
            vipPurchaseScreen.style.display = 'none';
            vipLandingScreen.classList.remove('active');
            vipLandingScreen.style.display = 'none';
            
            mainNav.classList.add('visible');
            
            openChat('admin', 'VIP Support', false); 
            setTimeout(() => {
                const input = document.getElementById('msg-input');
                input.value = `I want to buy ${planName} VIP for ${price}`;
                input.focus();
                input.dispatchEvent(new Event('input'));
            }, 500);
        };

        // --- NEW CREATOR ACCOUNT LOGIC ---
        window.openCreatorScreen = () => {
            history.pushState({page: 'creator'}, 'Creator Verification', '#creator');
            document.getElementById('creator-screen-name').innerText = currentUser.displayName || "Ninja";
            get(ref(db, `verification_requests/${currentUser.uid}`)).then(snap => {
                 if(snap.exists() && snap.val().status === 'pending') {
                      const btn = document.getElementById('btn-verify-submit');
                      btn.innerHTML = "PENDING APPROVAL";
                      btn.style.background = "#555";
                      btn.disabled = true;
                 }
            });
            const avEl = document.getElementById('creator-screen-avatar');
            if(myAvatarHTML.includes('<img')) {
                avEl.innerHTML = myAvatarHTML;
                avEl.style.border = '3px solid var(--accent)';
            } else {
                avEl.innerHTML = myAvatarHTML; 
            }
            creatorScreen.style.display = 'flex';
            setTimeout(() => creatorScreen.classList.add('active'), 10);
            mainNav.classList.remove('visible');
        };

        window.closeCreatorScreen = () => {
            if(!isSystemBack && history.state && history.state.page === 'creator') { history.back(); return; }
            creatorScreen.classList.remove('active');
            setTimeout(() => creatorScreen.style.display = 'none', 300);
            mainNav.classList.add('visible');
        };
        
        window.selectPlatform = (el, platformName) => {
            document.querySelectorAll('.creator-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            selectedCreatorPlatform = platformName;
        };

        window.submitCreatorVerification = async () => {
             const realName = document.getElementById('creator-real-name').value;
             const phone = document.getElementById('creator-phone').value;
             const age = document.getElementById('creator-age').value;
             const gender = document.getElementById('creator-gender').value;
             if(!realName || !phone || !age) { showToast("Please fill all details!"); return; }
             const btn = document.getElementById('btn-verify-submit');
             btn.innerHTML = '<div class="btn-loader"></div> Sending...';
             btn.disabled = true;
             await set(ref(db, `verification_requests/${currentUser.uid}`), {
                 uid: currentUser.uid,
                 username: currentUser.displayName,
                 realName: realName,
                 phone: phone,
                 age: age,
                 gender: gender,
                 platform: selectedCreatorPlatform,
                 timestamp: Date.now(),
                 status: 'pending'
             });
             await push(ref(db, 'admin_notifications'), {
                 title: "New Creator Request",
                 desc: `${currentUser.displayName} has requested creator verification.`,
                 img: "https://wallpapers.com/images/high/cool-neon-blue-profile-picture-u9y9ydo971k9mdcf.webp",
                 time: Date.now(),
                 badge: "ACTION REQUIRED"
             });
             btn.innerHTML = "PENDING APPROVAL";
             btn.style.background = "#555";
             showToast("Verification Sent to Admin!");
        };

        // --- ONLINE NOTIFICATION ---
        function showOnlineNotify(contact) {
            onNotifName.innerText = contact.name;
            activeNotifUid = contact.uid;
            onlineNotify.style.display = 'flex';
            if(notifTimeout) clearTimeout(notifTimeout);
            notifTimeout = setTimeout(() => {
                onlineNotify.style.display = 'none';
                activeNotifUid = null;
            }, 4000);
        }

        window.handleOnlineNotifyClick = () => {
            if(activeNotifUid && onNotifName.innerText) {
                openChat(activeNotifUid, onNotifName.innerText, true);
                onlineNotify.style.display = 'none';
                activeNotifUid = null;
            }
        };

        // --- NOTIFICATION SCREEN LOGIC ---
        window.openNotifications = () => {
            history.pushState({page: 'notifications'}, 'Notifications', '#notifications');
            notificationScreen.style.display = 'flex';
            setTimeout(() => notificationScreen.classList.add('active'), 10);
            homeScreen.classList.remove('active');
            mainNav.classList.remove('visible');
            loadNotifications();
        };

        window.closeNotifications = () => {
            if(!isSystemBack && history.state && history.state.page === 'notifications') { history.back(); return; }
            notificationScreen.classList.remove('active');
            setTimeout(() => notificationScreen.style.display = 'none', 300);
            homeScreen.classList.add('active');
            mainNav.classList.add('visible');
        };

        function loadNotifications() {
            notifListContent.innerHTML = '<div class="loader"></div>';
            onValue(ref(db, 'admin_notifications'), (snapshot) => {
                notifListContent.innerHTML = '';
                const data = snapshot.val();
                if (!data) {
                    const sampleData = [
                        {
                            title: "VIP MEMBERSHIP SALE",
                            desc: "Get 50% OFF on yearly VIP membership. Unlock exclusive badges, icons and priority support today!",
                            img: "https://wallpapers.com/images/high/cool-ninja-wallpaper-1080-x-1920-y3s0q2q2q2q2q2q2.jpg",
                            time: Date.now(),
                            badge: "LIMITED OFFER"
                        }
                    ];
                    sampleData.forEach(notif => renderNotification(notif));
                    return;
                }
                Object.values(data).reverse().forEach(notif => renderNotification(notif));
            });
        }

        function renderNotification(notif) {
            const dateStr = new Date(notif.time).toLocaleDateString();
            const badgeHtml = notif.badge ? `<div class="notif-badge">${notif.badge}</div>` : '';
            const div = document.createElement('div');
            div.className = 'notif-card';
            div.innerHTML = `
                <div class="notif-image-box">
                    <img src="${notif.img}" class="notif-img">
                    ${badgeHtml}
                </div>
                <div class="notif-content">
                    <div class="notif-title">${notif.title}</div>
                    <div class="notif-desc">${notif.desc}</div>
                     <div class="notif-footer">
                        <span class="notif-time">${dateStr}</span>
                        <button class="notif-btn" onclick="openChat('admin', 'Admin', false)">
                            CHAT <i class="fa-solid fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            `;
            notifListContent.appendChild(div);
        }

        // --- NEW: CREATE GROUP SCREEN LOGIC ---
        window.openCreateChannel = async () => {
            if(document.getElementById('new-chat-screen').style.display === 'flex') {
                closeNewChat();
            }
            if(document.getElementById('settings-screen').classList.contains('active')) {
                closeSettings();
            }
            const channelsRef = query(ref(db, 'channels'), orderByChild('creatorId'), equalTo(currentUser.uid));
            const snapshot = await get(channelsRef);
            if (snapshot.exists() && !isVipUser) {
                showToast("Free Limit Reached! Buy VIP.");
                return;
            }
            history.pushState({page: 'createChannel'}, 'New Group', '#createChannel');
            document.getElementById('new-group-name-input').value = '';
            document.getElementById('new-group-icon-preview').style.display = 'none';
            document.getElementById('new-group-icon-preview').dataset.base64 = '';
            selectedGroupMembers = [];
            renderCreateGroupContacts();
            createChannelScreen.style.display = 'flex';
            setTimeout(() => createChannelScreen.classList.add('active'), 10);
        };

        window.renderCreateGroupContacts = () => {
            const listContainer = document.getElementById('create-group-contact-list');
            listContainer.innerHTML = '<div class="loader"></div>';
            get(ref(db, `user-contacts/${currentUser.uid}`)).then(async (snapshot) => {
                listContainer.innerHTML = '';
                const contacts = snapshot.val();
                if(!contacts) {
                    listContainer.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">No contacts to add</div>';
                    return;
                }
                for (const contact of Object.values(contacts)) {
                     const userSnap = await get(ref(db, `users/${contact.uid}`));
                     const userData = userSnap.val();
                     let avatarHtml = '<i class="fa-solid fa-user-ninja"></i>';
                     if (userData && userData.icon === 'custom' && userData.customAvatar) {
                         avatarHtml = `<img src="${userData.customAvatar}" style="width:100%; height:100%; object-fit:cover;">`;
                     } else if (userData && userData.icon) {
                         avatarHtml = `<i class="fa-solid ${userData.icon}"></i>`;
                     }
                     const div = document.createElement('div');
                     div.className = 'contact-select-item';
                     div.id = `contact-sel-${contact.uid}`;
                     div.onclick = () => toggleGroupMemberSelect(contact.uid);
                     div.innerHTML = `
                        <div class="contact-select-checkbox"></div>
                        <div class="avatar" style="width:40px; height:40px; margin-right:15px; background:#f5f5f5;">${avatarHtml}</div>
                        <div style="flex:1;">
                            <div style="font-weight:700; color:#333;">${contact.name}</div>
                            <div style="font-size:11px; color:#888;">Tap to select</div>
                        </div>
                     `;
                     listContainer.appendChild(div);
                }
            });
        };

        window.toggleGroupMemberSelect = (uid) => {
            const el = document.getElementById(`contact-sel-${uid}`);
            if(selectedGroupMembers.includes(uid)) {
                selectedGroupMembers = selectedGroupMembers.filter(id => id !== uid);
                el.classList.remove('selected');
            } else {
                selectedGroupMembers.push(uid);
                el.classList.add('selected');
            }
        };

        window.submitCreateGroup = async () => {
             const name = document.getElementById('new-group-name-input').value.trim();
             const iconBase64 = document.getElementById('new-group-icon-preview').dataset.base64;
             if(!name) { showToast("Group subject required"); return; }
             if(selectedGroupMembers.length === 0) { showToast("At least 1 member required"); return; }
             const btn = document.querySelector('.floating-create-btn');
             btn.style.transform = 'scale(0.8)';
             showToast("Creating Group...");
             const channelId = push(child(ref(db), 'channels')).key;
             const membersObj = { [currentUser.uid]: { role: 'Leader', joinTime: Date.now() } };
             selectedGroupMembers.forEach(uid => { membersObj[uid] = { role: 'Member', joinTime: Date.now() }; });
             const iconVal = iconBase64 ? 'custom' : 'fa-users'; 
             const groupData = {
                name: name,
                creatorRole: 'Leader',
                icon: iconVal,
                creatorId: currentUser.uid,
                activeLeader: currentUser.uid,
                autoJoin: false,
                type: 'private', 
                members: membersObj,
                timestamp: Date.now()
             };
             if(iconBase64) { groupData.customIcon = iconBase64; }
             await set(ref(db, `channels/${channelId}`), groupData);
             showToast("Group Created!");
             closeCreateChannel();
             setTimeout(() => { openChat(channelId, name, false, true); }, 500);
        };

        window.closeCreateChannel = () => {
            if(!isSystemBack && history.state && history.state.page === 'createChannel') { history.back(); return; }
            createChannelScreen.classList.remove('active');
            setTimeout(() => createChannelScreen.style.display = 'none', 300);
        };

        window.selectChannelIcon = (el, iconClass) => {
            document.querySelectorAll('.icon-option').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('selected-icon').value = iconClass;
        };
        
        window.selectPrivacy = (val) => {
            document.getElementById('radio-pub').classList.remove('selected-radio');
            document.getElementById('radio-priv').classList.remove('selected-radio');
            if(val === 'public') document.getElementById('radio-pub').classList.add('selected-radio');
            else document.getElementById('radio-priv').classList.add('selected-radio');
        };

        window.toggleCustomRole = (select) => {
            const input = document.getElementById('custom-role-input');
            if(select.value === 'Custom') input.style.display = 'block';
            else input.style.display = 'none';
        };

        // --- SETTINGS FUNCTIONS ---
        window.openSettings = () => {
            history.pushState({page: 'settings'}, 'Settings', '#settings');
            const settingsScreen = document.getElementById('settings-screen');
            settingsScreen.style.display = 'flex';
            setTimeout(() => settingsScreen.classList.add('active'), 10);
            profileScreen.classList.remove('active');
            mainNav.classList.remove('visible');
        };

        window.closeSettings = () => {
            if(!isSystemBack && history.state && history.state.page === 'settings') { history.back(); return; }
            const settingsScreen = document.getElementById('settings-screen');
            settingsScreen.classList.remove('active');
            setTimeout(() => settingsScreen.style.display = 'none', 300);
            profileScreen.classList.add('active');
            mainNav.classList.add('visible');
        };

        window.openSelectLeader = () => {
             selectContactModal.style.display = 'flex';
             renderSkeleton('contact-picker-list');
             onValue(ref(db, `user-contacts/${currentUser.uid}`), (snapshot) => {
                contactPickerList.innerHTML = '';
                const contacts = snapshot.val();
                if (!contacts) { contactPickerList.innerHTML = '<div style="padding:20px; text-align:center;">No contacts found.</div>'; return; }
                Object.values(contacts).forEach(contact => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.onclick = () => confirmSelectLeader(contact.uid, contact.name);
                    let avHtml = `<div class="avatar"><i class="fa-solid fa-user-ninja"></i></div>`; 
                    div.innerHTML = `${avHtml}<div class="chat-info"><h3>${contact.name}</h3></div><i class="fa-solid fa-plus text-red"></i>`;
                    contactPickerList.appendChild(div);
                });
            });
        };

        window.confirmSelectLeader = (uid, name) => {
            document.getElementById('active-leader-uid').value = uid;
            document.getElementById('selected-leader-name').innerText = name;
            selectContactModal.style.display = 'none';
        };
        
        window.closeSelectContactModal = () => {
             selectContactModal.style.display = 'none';
        };

        function loadChannels() {
            renderSkeleton('channel-list');
            onValue(ref(db, 'channels'), (snapshot) => {
                channelList.innerHTML = '';
                const channelsData = snapshot.val();
                const searchTermInput = document.getElementById('channel-search');
                
                if(!channelsData) { channelList.innerHTML = `<div class="empty-state"><i class="fa-solid fa-satellite-dish"></i><p>No channels yet</p></div>`; return; }
                
                let channelsArray = Object.entries(channelsData).map(([key, val]) => ({...val, id: key}));
                let rankArray = [...channelsArray];
                rankArray.sort((a, b) => {
                    const countA = Object.keys(a.members || {}).length;
                    const countB = Object.keys(b.members || {}).length;
                    return countB - countA;
                });
                
                const rankMap = {};
                rankArray.forEach((ch, index) => {
                    if (index < 3) rankMap[ch.id] = index;
                });

                channelsArray.sort((a, b) => b.timestamp - a.timestamp);
                
                channelsArray.forEach(channel => {
                    const safeType = (channel.type || 'public').toLowerCase();
                    const isPrivate = safeType === 'private';
                    if (isPrivate) { return; }

                    const isOwner = channel.creatorId === currentUser.uid;
                    const div = document.createElement('div');
                    div.className = 'list-item channel-item';
                    div.dataset.name = channel.name.toLowerCase();
                    div.dataset.uid = channel.id; 
                    
                    let badgeHtml = `<span class="channel-type-badge badge-public"><i class="fa-solid fa-globe"></i> Public</span>`;
                    let lockHtml = !channel.autoJoin ? '<i class="fa-solid fa-lock lock-icon" title="Request to Join"></i>' : '';
                    let actionHtml = isOwner ? '<span style="font-size:10px; color:#888; border:1px solid #ddd; padding:2px 6px; border-radius:10px;">Admin</span>' : '';

                    div.onclick = () => openChat(channel.id, channel.name, false, true);

                    const pinIcon = isOwner ? '<i class="fa-solid fa-thumbtack" style="font-size:10px; color:var(--gray); margin-left:5px;"></i>' : '';
                    let rankIconHtml = '';
                    if (rankMap[channel.id] !== undefined) {
                        const r = rankMap[channel.id];
                        if(r === 0) rankIconHtml = `<div class="rank-badge badge-gold"><i class="fa-solid fa-trophy"></i> #1 GOLD</div>`;
                        else if(r === 1) rankIconHtml = `<div class="rank-badge badge-silver"><i class="fa-solid fa-trophy"></i> #2 SILVER</div>`;
                        else if(r === 2) rankIconHtml = `<div class="rank-badge badge-platinum"><i class="fa-solid fa-trophy"></i> #3 PLATINUM</div>`;
                    }

                    let iconContent;
                    if(channel.icon === 'custom' && channel.customIcon) {
                        iconContent = `<img src="${channel.customIcon}" style="width:100%; height:100%; object-fit:cover;">`;
                    } else {
                        iconContent = `<i class="fa-solid ${channel.icon || 'fa-users'}"></i>`;
                    }

                    div.innerHTML = `
                        <div class="avatar-container"><div class="avatar" style="overflow:hidden;">${iconContent}</div></div>
                        <div class="chat-info">
                            <h3>${channel.name} ${pinIcon}</h3>
                            ${rankIconHtml}
                            <div style="display:flex; align-items:center; margin-top:4px;">${badgeHtml} ${lockHtml} <span style="font-size:11px; color:#777; margin-left:5px;"> ${Object.keys(channel.members || {}).length} members</span></div>
                        </div>
                        ${actionHtml}
                    `;
                    channelList.appendChild(div);
                });
            });
        }

        window.filterChannels = () => {
             const input = document.getElementById('channel-search').value.toLowerCase();
             const items = document.querySelectorAll('.channel-item');
             items.forEach(item => {
                const name = item.dataset.name;
                const uid = item.dataset.uid.toLowerCase();
                if(name.includes(input) || uid.includes(input)) item.style.display = 'flex';
                else item.style.display = 'none';
             });
        };

        // --- LEADERBOARD LOGIC ---
        window.openLeaderboard = async () => {
            history.pushState({page: 'leaderboard'}, 'Leaderboard', '#leaderboard');
            leaderboardScreen.style.display = 'flex';
            setTimeout(() => leaderboardScreen.classList.add('active'), 10);
            leaderboardListContent.innerHTML = '<div class="loader"></div>';

            const snapshot = await get(ref(db, 'channels'));
            leaderboardListContent.innerHTML = '';
            
            if(!snapshot.exists()) {
                leaderboardListContent.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">No channels found.</div>';
                return;
            }

            const channels = Object.values(snapshot.val());
            channels.sort((a, b) => {
                const countA = Object.keys(a.members || {}).length;
                const countB = Object.keys(b.members || {}).length;
                return countB - countA;
            });

            for(let i=0; i<100; i++) {
                if (i < channels.length) {
                    const channel = channels[i];
                    const membersCount = Object.keys(channel.members || {}).length;
                    let rankClass = '';
                    let iconHtml = '<i class="fa-solid fa-hashtag"></i>';

                    if(i === 0) { rankClass = 'top-rank rank-1'; iconHtml = '<i class="fa-solid fa-trophy"></i>'; }
                    else if(i === 1) { rankClass = 'top-rank rank-2'; iconHtml = '<i class="fa-solid fa-medal"></i>'; }
                    else if(i === 2) { rankClass = 'top-rank rank-3'; iconHtml = '<i class="fa-solid fa-medal"></i>'; }

                    const div = document.createElement('div');
                    div.className = `lb-item ${rankClass.includes('top-rank') ? 'top-rank' : ''}`;
                    div.innerHTML = `
                        <div class="lb-rank ${rankClass}">${iconHtml} ${i+1}</div>
                        <div class="avatar" style="width:40px;height:40px;font-size:16px;margin-left:10px;"><i class="fa-solid ${channel.icon || 'fa-users'}"></i></div>
                        <div class="lb-info">
                            <div class="lb-name">${channel.name}</div>
                            <div class="lb-members">${membersCount} Members</div>
                        </div>
                    `;
                    leaderboardListContent.appendChild(div);
                } else {
                    const div = document.createElement('div');
                    div.className = 'lb-placeholder';
                    div.innerHTML = `<div class="lb-ph-rank">#${i+1}</div><div class="lb-ph-dash">-</div>`;
                    leaderboardListContent.appendChild(div);
                }
            }
        };

        window.closeLeaderboard = () => {
            if(!isSystemBack && history.state && history.state.page === 'leaderboard') { history.back(); return; }
            leaderboardScreen.classList.remove('active');
            setTimeout(() => leaderboardScreen.style.display = 'none', 300);
        };

        window.handleTelegramJoin = (channelId, autoJoin) => {
            if(autoJoin) {
                update(ref(db, `channels/${channelId}/members/${currentUser.uid}`), { role: 'Member', joinTime: Date.now() });
                showToast("Joined Channel!");
                setTimeout(() => openChat(channelId, document.getElementById('chat-room-name').innerText, false, true), 500);
            } else {
                set(ref(db, `channels/${channelId}/requests/${currentUser.uid}`), { name: currentUser.displayName, uid: currentUser.uid, timestamp: Date.now() });
                showToast("Request Sent to Leaders");
                const btn = document.querySelector('.btn-tg-join');
                if(btn) {
                    btn.innerText = "PENDING...";
                    btn.classList.add('pending');
                    btn.onclick = null;
                }
            }
        };

        // --- CHANNEL INFO LOGIC ---
        window.openChannelInfo = async () => {
            if(!currentChatIdString && !isChannelChat) return;
            history.pushState({page: 'channelInfo'}, 'Channel Info', '#info');
            const content = document.getElementById('channel-info-content');
            content.innerHTML = '<div class="loader"></div>';
            
            channelInfoScreen.style.display = 'flex';
            setTimeout(() => channelInfoScreen.classList.add('active'), 10);

            const snap = await get(ref(db, `channels/${currentChannelId}`));
            const data = snap.val();
            const memberCount = Object.keys(data.members || {}).length;

            let membersHtml = '';
            const memberPromises = Object.keys(data.members || {}).map(async (uid) => {
                const userSnap = await get(ref(db, `users/${uid}`));
                const user = userSnap.val();
                const role = data.members[uid].role;
                const name = user ? user.username : "Unknown Ninja";
                
                let avatarHtml;
                if(user && user.icon === 'custom' && user.customAvatar) {
                     avatarHtml = `<img src="${user.customAvatar}" class="custom-user-img">`;
                } else {
                     const icon = user && user.icon ? user.icon : 'fa-user-ninja';
                     avatarHtml = `<i class="fa-solid ${icon}"></i>`;
                }

                return `<div class="list-item" onclick="viewUserProfile('${uid}', '${name}', '${role}')"><div class="avatar-container"><div class="avatar">${avatarHtml}</div></div><div class="chat-info"><h3>${name}</h3><p>${role}</p></div></div>`;
            });

            const membersList = await Promise.all(memberPromises);

            let leaveBtnHtml = '';
            if (currentUser.uid !== data.creatorId && data.members[currentUser.uid]) {
                leaveBtnHtml = `<div class="leave-btn-container"><button class="leave-channel-btn" onclick="leaveChannel('${currentChannelId}')"><i class="fa-solid fa-arrow-right-from-bracket"></i> Leave Channel</button></div>`;
            }

            let iconDisplay;
            if(data.icon === 'custom' && data.customIcon) {
                iconDisplay = `<img src="${data.customIcon}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
            } else {
                iconDisplay = `<i class="fa-solid ${data.icon || 'fa-users'}"></i>`;
            }

            content.innerHTML = `
                <div class="info-card">
                    <div class="info-icon" style="overflow:hidden; display:flex; justify-content:center; align-items:center;">${iconDisplay}</div>
                    <div class="info-title">${data.name}</div>
                    <div class="info-sub">${memberCount} Members  ${(data.type || 'public').toUpperCase()}</div>
                </div>
                ${leaveBtnHtml}
                <div class="member-list-header">MEMBERS</div>
                <div>${membersList.join('')}</div>
            `;
        };

        window.closeChannelInfo = () => {
            if(!isSystemBack && history.state && history.state.page === 'channelInfo') { history.back(); return; }
            channelInfoScreen.classList.remove('active');
            setTimeout(() => channelInfoScreen.style.display = 'none', 300);
        };

        window.leaveChannel = async (channelId) => {
            openCustomModal("Leave Channel?", "You will stop receiving messages.", async () => {
                await remove(ref(db, `channels/${channelId}/members/${currentUser.uid}`));
                showToast("Left Channel");
                closeChannelInfo();
                closeChat(); 
            });
        };

        // --- UPDATED USER PROFILE LOGIC ---
        window.viewUserProfile = async (uid, name, role) => {
            history.pushState({page: 'viewProfile'}, 'Profile', '#profile');
            
            document.getElementById('vp-name-disp').innerText = name;
            
            const userSnap = await get(ref(db, `users/${uid}`));
            const userData = userSnap.val();
            
            const bio = (userData && userData.bio) ? userData.bio : "No bio available";
            document.getElementById('vp-bio-disp').innerText = bio;
            document.getElementById('vp-status-text').innerText = role || "Ninja";
            
            const avatarEl = document.getElementById('vp-avatar-disp');
            const isUserVip = (userData && userData.isVip) || false;
            
            let innerHtml = '';
            let lightboxUrl = '';
            
            if (userData && userData.icon === 'custom' && userData.customAvatar) {
                 innerHtml = `<img src="${userData.customAvatar}" class="custom-user-img">`;
                 lightboxUrl = userData.customAvatar;
            } else {
                 const iconClass = (userData && userData.icon) ? userData.icon : 'fa-user-ninja';
                 innerHtml = `<i class="fa-solid ${iconClass} ${isUserVip ? 'vip-gold-icon' : ''}"></i>`;
                 lightboxUrl = iconClass;
            }

            if(isUserVip) {
                 avatarEl.innerHTML = `${innerHtml}<div class="vip-tick-overlay"><i class="fa-solid fa-check"></i></div>`;
                 avatarEl.style.borderColor = "var(--gold)";
                 avatarEl.style.boxShadow = "0 0 20px rgba(255, 215, 0, 0.4)";
            } else {
                 avatarEl.innerHTML = innerHtml;
                 avatarEl.style.borderColor = "var(--accent)";
                 avatarEl.style.boxShadow = "0 10px 25px rgba(211, 47, 47, 0.2)";
            }
            
            const storySnap = await get(query(ref(db, 'public_stories'), orderByChild('uid'), equalTo(uid)));
            let hasActiveStory = false;
            if(storySnap.exists()){
                storySnap.forEach(s => { if((Date.now() - s.val().timestamp) < 86400000) hasActiveStory = true; });
            }

            if(hasActiveStory) {
                if(!avatarEl.querySelector('.pp-border-ring')) {
                    const ring = document.createElement('div');
                    ring.className = 'pp-border-ring';
                    ring.style.border = '3px solid var(--accent)';
                    ring.style.top = '-6px'; ring.style.left = '-6px'; ring.style.right = '-6px'; ring.style.bottom = '-6px';
                    avatarEl.style.position = 'relative';
                    avatarEl.appendChild(ring);
                }
            }

            avatarEl.onclick = (e) => {
                e.stopPropagation();
                checkAndOpenStory(uid, false, lightboxUrl);
            };

            const actionBtn = document.getElementById('vp-action-main-btn');
            const contactCheck = await get(child(ref(db), `user-contacts/${currentUser.uid}/${uid}`));
            
            // Logic for Chat vs Add Friend Button
            if(uid === currentUser.uid) {
                actionBtn.style.display = 'none';
            } else if(contactCheck.exists()) {
                actionBtn.style.display = 'flex';
                actionBtn.className = 'vp-big-btn btn-chat-action';
                actionBtn.innerHTML = '<i class="fa-solid fa-message"></i> Chat';
                actionBtn.onclick = () => {
                    closeViewProfile();
                    openChat(uid, name, true);
                };
            } else {
                actionBtn.style.display = 'flex';
                actionBtn.className = 'vp-big-btn btn-add-action';
                actionBtn.innerHTML = '<i class="fa-solid fa-user-plus"></i> Add Friend';
                actionBtn.onclick = () => {
                    sendRequest(uid);
                    actionBtn.innerText = "Request Sent";
                    actionBtn.disabled = true; 
                };
            }

            viewProfileScreen.style.display = 'flex';
            setTimeout(() => viewProfileScreen.classList.add('active', 'anim-zoom-enter'), 10);
            
            mainNav.classList.remove('visible');
        };

        window.closeViewProfile = () => {
            if(!isSystemBack && history.state && history.state.page === 'viewProfile') { history.back(); return; }
            
            viewProfileScreen.classList.remove('anim-zoom-enter');
            viewProfileScreen.classList.add('anim-zoom-exit');
            
            setTimeout(() => {
                viewProfileScreen.style.display = 'none';
                viewProfileScreen.classList.remove('active', 'anim-zoom-exit');
                
                if(!chatScreen.classList.contains('active')) {
                    mainNav.classList.add('visible');
                }
            }, 300);
        };

        window.loadMyProfile = () => {
            if(currentUser) {
                document.getElementById('my-profile-name').innerText = currentUser.displayName || "Ninja User";
                document.getElementById('my-profile-email').innerText = currentUser.email;
                
                onValue(ref(db, `users/${currentUser.uid}`), (snap) => {
                    const data = snap.val();
                    if(data) {
                        const icon = data.icon || 'fa-user-ninja';
                        const bio = data.bio || "No bio available";
                        isVipUser = data.isVip || false;
                        isUserAdmin = data.isAdmin || false; 
                        
                        currentProfileIcon = icon;

                        const iconEl = document.getElementById('my-profile-icon');
                        let lightboxUrl = '';
                        
                        const navIcon = document.getElementById('nav-profile-icon');
                        const navLabel = document.querySelector('#nav-profile span');

                        // --- NAV BAR UPDATE LOGIC ---
                        const navContainer = document.getElementById('nav-profile-img-container');

                        if (data.icon === 'custom' && data.customAvatar) {
                             const imgTag = `<img src="${data.customAvatar}" class="custom-user-img">`;
                             iconEl.innerHTML = imgTag;
                             myAvatarHTML = imgTag; 
                             iconEl.className = ""; 
                             lightboxUrl = data.customAvatar;

                             // Inject Image into Nav
                             navContainer.innerHTML = `<img src="${data.customAvatar}" class="nav-profile-img">`;
                        } else {
                             const iTag = `<i class="fa-solid ${icon}"></i>`;
                             iconEl.innerHTML = iTag;
                             myAvatarHTML = iTag; 
                             iconEl.className = `${isVipUser ? 'vip-gold-icon' : ''}`; 
                             lightboxUrl = icon;
                             
                             // Inject Icon into Nav (Fallback)
                             navContainer.innerHTML = `<i class="fa-solid fa-user nav-profile-icon-fallback"></i>`;
                        }

                        const avatarContainer = document.getElementById('my-profile-avatar-container');
                        avatarContainer.onclick = () => checkAndOpenStory(currentUser.uid, true, lightboxUrl);

                        document.getElementById('my-profile-bio').innerText = bio;
                        
                        if(avatarContainer) {
                            get(query(ref(db, 'public_stories'), orderByChild('uid'), equalTo(currentUser.uid))).then(storySnap => {
                                if(storySnap.exists()) {
                                    let hasActive = false;
                                    const now = Date.now();
                                    const oneDay = 24 * 60 * 60 * 1000;
                                    
                                    storySnap.forEach(s => {
                                        if((now - s.val().timestamp) < oneDay) hasActive = true;
                                    });
                                    
                                    if(hasActive) {
                                        avatarContainer.classList.add('has-story');
                                    } else {
                                        avatarContainer.classList.remove('has-story');
                                    }
                                } else {
                                    avatarContainer.classList.remove('has-story');
                                }
                            });
                        }

                        const adminBtn = document.getElementById('admin-panel-btn');
                        if(isUserAdmin) {
                            adminBtn.style.display = 'block';
                        } else {
                            adminBtn.style.display = 'none';
                        }

                        const vipBox = document.getElementById('vip-countdown-box');
                        if(vipBox) vipBox.style.display = 'none';
                    }
                });
            }
        };

        // --- SHARE PROFILE (QR CODE) FUNCTION ---
        window.openShareProfile = async () => {
            history.pushState({page: 'share'}, 'Share Profile', '#share');
            const screen = document.getElementById('share-profile-screen');
            screen.style.display = 'flex';
            
            const userSnap = await get(ref(db, `users/${currentUser.uid}`));
            const userData = userSnap.val();
            
            const name = userData.username || "Ninja";
            const shortId = userData.shortId || "000000"; 
            
            document.getElementById('share-qr-name').innerText = name;
            document.getElementById('share-short-id').innerText = shortId.toString().replace(/(\d{3})(\d{3})/, "$1 $2"); 
            
            const avatarEl = document.getElementById('share-qr-avatar');
            
            if (userData.icon === 'custom' && userData.customAvatar) {
                 avatarEl.innerHTML = `<img src="${userData.customAvatar}" class="custom-user-img">`;
            } else {
                 avatarEl.innerHTML = `<i class="fa-solid ${userData.icon || 'fa-user-ninja'}"></i>`;
            }

            const qrContainer = document.getElementById('qrcode-container');
            qrContainer.innerHTML = ''; 
            
            new QRCode(qrContainer, {
                text: `ninjatag:${shortId}`,
                width: 180,
                height: 180,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            const overlay = document.createElement('div');
            overlay.className = 'qr-overlay-icon';
            overlay.innerHTML = `<i class="fa-solid fa-user-secret" style="font-size:22px;"></i>`;
            qrContainer.appendChild(overlay);
        };

        window.closeShareProfile = () => {
            if(!isSystemBack && history.state && history.state.page === 'share') { history.back(); return; }
            document.getElementById('share-profile-screen').style.display = 'none';
        };

        window.shareProfileNative = async () => {
            const shortId = document.getElementById('share-short-id').innerText;
            const shareData = {
                title: 'Ninja Chat Profile',
                text: `Add me on Ninja Chat! My Ninja Code is: ${shortId}`,
                url: window.location.href 
            };
            
            if (navigator.share) {
                try { await navigator.share(shareData); } catch (err) {}
            } else {
                navigator.clipboard.writeText(shareData.text);
                showToast("Code copied to clipboard!");
            }
        };

        // --- NEW: QR SCANNER LOGIC (REAL CAMERA) ---
        
        window.openQRScanner = () => {
            history.pushState({page: 'scanner'}, 'Scan QR', '#scanner');
            document.getElementById('qr-scanner-screen').style.display = 'flex';
            
            // Using html5-qrcode library
            if(window.html5QrCode) { 
                // If exists, restart
                startCameraScan();
            } else {
                window.html5QrCode = new Html5Qrcode("qr-reader");
                startCameraScan();
            }
        };

        function startCameraScan() {
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            window.html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                showToast("Camera Error: " + err);
                closeQRScanner();
            });
        }

        function onScanSuccess(decodedText, decodedResult) {
            // Check format
            if(decodedText.startsWith('ninjatag:')) {
                const targetShortId = decodedText.split(':')[1];
                
                // Stop scanning
                window.html5QrCode.stop().then(() => {
                    document.getElementById('qr-scanner-screen').style.display = 'none';
                    handleScannedUser(targetShortId);
                }).catch(err => {
                    console.error(err);
                    document.getElementById('qr-scanner-screen').style.display = 'none';
                    handleScannedUser(targetShortId); // Proceed anyway
                });
            } else {
                showToast("Invalid Ninja Tag!");
            }
        }

        window.closeQRScanner = () => {
            if(!isSystemBack && history.state && history.state.page === 'scanner') { history.back(); return; }
            
            if(window.html5QrCode && window.html5QrCode.isScanning) {
                window.html5QrCode.stop().then(() => {
                    document.getElementById('qr-scanner-screen').style.display = 'none';
                }).catch(err => {
                    document.getElementById('qr-scanner-screen').style.display = 'none';
                });
            } else {
                document.getElementById('qr-scanner-screen').style.display = 'none';
            }
        };

        async function handleScannedUser(shortId) {
            showToast("Ninja Found! Connecting...");
            
            // 1. Find User UID by ShortID
            const q = query(ref(db, 'users'), orderByChild('shortId'), equalTo(shortId));
            const snapshot = await get(q);
            
            if(snapshot.exists()) {
                const userKey = Object.keys(snapshot.val())[0];
                const targetUser = snapshot.val()[userKey];
                const targetUid = targetUser.uid;
                
                if(targetUid === currentUser.uid) {
                    showToast("You scanned yourself!");
                    return;
                }

                // 2. Add Contact Directly (Auto-Accept Logic)
                await set(ref(db, `user-contacts/${currentUser.uid}/${targetUid}`), { 
                    name: targetUser.username, 
                    uid: targetUid 
                });
                
                // Also add me to them
                await set(ref(db, `user-contacts/${targetUid}/${currentUser.uid}`), { 
                    name: currentUser.displayName, 
                    uid: currentUser.uid 
                });

                // Remove any pending requests
                await remove(ref(db, `friend-requests/${currentUser.uid}/${targetUid}`));
                await remove(ref(db, `friend-requests/${targetUid}/${currentUser.uid}`));

                showToast("Connected! Opening Chat...");
                
                // 3. Open Chat
                closeNewChat();
                openChat(targetUid, targetUser.username, true);

            } else {
                showToast("User not found!");
            }
        }

        function startVipTimer(expiryTimestamp) {
            clearInterval(vipCountdownInterval);
        }

        // --- PROFILE TAP VS LONG PRESS LOGIC ---
        window.setupProfileInteraction = (element, imageUrl, isSelf = false, targetUid = null) => {
            let pressTimer;
            let isLongPress = false;
            let startX = 0, startY = 0;

            const newElement = element.cloneNode(true);
            if(element.parentNode) {
                element.parentNode.replaceChild(newElement, element);
            }
            element = newElement;

            element.addEventListener('touchstart', (e) => {
                isLongPress = false;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    if(navigator.vibrate) navigator.vibrate(50);
                    // LONG PRESS: Open DP Lightbox (Always)
                    if(imageUrl.startsWith('data:image') || imageUrl.startsWith('http')) {
                        openLightbox(imageUrl);
                    } else {
                        openLightbox(imageUrl, false, true);
                    }
                }, 600);
            }, {passive: false});

            element.addEventListener('touchend', (e) => {
                clearTimeout(pressTimer);
                const diffX = Math.abs(e.changedTouches[0].clientX - startX);
                const diffY = Math.abs(e.changedTouches[0].clientY - startY);

                if (diffX > 10 || diffY > 10) return; 

                if (!isLongPress) {
                    const uidToCheck = isSelf ? currentUser.uid : targetUid;
                    checkAndOpenStory(uidToCheck, isSelf, imageUrl);
                }
            });
            
            element.addEventListener('touchmove', () => clearTimeout(pressTimer));
            
            element.addEventListener('click', (e) => {
                if(e.detail > 0) { 
                     const uidToCheck = isSelf ? currentUser.uid : targetUid;
                     checkAndOpenStory(uidToCheck, isSelf, imageUrl);
                }
            });
        };

        // --- STORY VIEWER LOGIC (WITH 24H EXPIRY) ---
        window.checkAndOpenStory = async (uid, isSelf, avatarUrl) => {
            const snapshot = await get(query(ref(db, 'public_stories'), orderByChild('uid'), equalTo(uid)));
            
            if(snapshot.exists()) {
                const stories = [];
                const updates = {};
                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000;
                
                snapshot.forEach(child => {
                    const story = child.val();
                    if ((now - story.timestamp) > oneDay) {
                        if(isSelf) {
                            updates[`public_stories/${child.key}`] = null;
                        }
                    } else {
                        stories.push({ key: child.key, ...story });
                    }
                });
                
                if(Object.keys(updates).length > 0) update(ref(db), updates);

                stories.sort((a, b) => a.timestamp - b.timestamp);
                
                if(stories.length > 0) {
                    openStoryViewer(stories, uid, isSelf, avatarUrl);
                } else {
                    handleNoStory(isSelf, avatarUrl);
                }
            } else {
                handleNoStory(isSelf, avatarUrl);
            }
        };

        function handleNoStory(isSelf, avatarUrl) {
            if(avatarUrl.startsWith('data:image') || avatarUrl.startsWith('http')) {
                openLightbox(avatarUrl);
            } else {
                openLightbox(avatarUrl, false, true);
            }
        }

        window.openStoryViewer = (stories, uid, isSelf, avatarUrl) => {
            currentStoryList = stories;
            currentStoryIndex = 0;
            
            const first = stories[0];
            document.getElementById('sv-name').innerText = first.username;
            
            const avEl = document.getElementById('sv-avatar');
            if(avatarUrl.startsWith('data:image') || avatarUrl.startsWith('http')) {
                avEl.innerHTML = `<img src="${avatarUrl}" class="custom-user-img">`;
            } else {
                avEl.innerHTML = `<i class="fa-solid ${avatarUrl}"></i>`;
            }

            const menuBtn = document.querySelector('.story-menu-btn');
            menuBtn.style.display = isSelf ? 'block' : 'none';
            
            storyViewerScreen.style.display = 'flex';
            
            renderStoryItem(currentStoryIndex);
        };

        function renderStoryItem(index) {
            if(index >= currentStoryList.length) {
                closeStoryViewer();
                return;
            }
            
            const story = currentStoryList[index];
            const imgEl = document.getElementById('sv-img');
            const vidEl = document.getElementById('sv-video');
            const badge = document.getElementById('sv-close-friend-badge');
            const barsContainer = document.getElementById('story-bars');
            
            document.getElementById('sv-time').innerText = timeAgo(story.timestamp);
            
            if(story.type === 'close_friends') badge.style.display = 'flex';
            else badge.style.display = 'none';
            
            barsContainer.innerHTML = '';
            currentStoryList.forEach((s, i) => {
                const bar = document.createElement('div');
                bar.className = 'story-progress-bar';
                const fill = document.createElement('div');
                fill.className = 'story-progress-fill';
                
                if(i < index) fill.style.width = '100%';
                else if(i === index) fill.style.width = '0%';
                else fill.style.width = '0%';
                
                bar.appendChild(fill);
                barsContainer.appendChild(bar);
            });

            if(story.mediaType === 'image') {
                vidEl.style.display = 'none';
                vidEl.pause();
                imgEl.style.display = 'block';
                imgEl.src = story.media;
                startStoryTimer(5000); 
            } else {
                imgEl.style.display = 'none';
                vidEl.style.display = 'block';
                vidEl.src = story.media;
                vidEl.currentTime = 0;
                vidEl.play();
                vidEl.onloadedmetadata = () => {
                    const dur = vidEl.duration * 1000;
                    startStoryTimer(dur > 30000 ? 30000 : dur);
                };
            }
            
            loadStoryStats(story.key);
        }

        function startStoryTimer(duration) {
            if(storyTimer) clearInterval(storyTimer);
            
            const bars = document.querySelectorAll('.story-progress-fill');
            const activeBar = bars[currentStoryIndex];
            
            let startTime = Date.now();
            
            storyTimer = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const pct = Math.min((elapsed / duration) * 100, 100);
                
                if(activeBar) activeBar.style.width = `${pct}%`;
                
                if(elapsed >= duration) {
                    clearInterval(storyTimer);
                    nextStoryItem();
                }
            }, 50);
        }

        window.nextStoryItem = () => {
            if(document.getElementById('story-menu-dropdown').style.display === 'block') {
                toggleStoryMenu();
                return;
            }
            if(document.getElementById('story-stats-sheet').classList.contains('open')) {
                closeStoryStats();
                return;
            }

            currentStoryIndex++;
            renderStoryItem(currentStoryIndex);
        };

        window.closeStoryViewer = () => {
            if(storyTimer) clearInterval(storyTimer);
            const vid = document.getElementById('sv-video');
            vid.pause();
            vid.src = "";
            storyViewerScreen.style.display = 'none';
            document.getElementById('story-menu-dropdown').style.display = 'none';
            closeStoryStats();
        };

        window.toggleStoryMenu = () => {
            const menu = document.getElementById('story-menu-dropdown');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        };

        window.deleteCurrentStory = async () => {
            const story = currentStoryList[currentStoryIndex];
            if(story && story.uid === currentUser.uid) {
                const confirm = window.confirm("Delete this story?");
                if(confirm) {
                    await remove(ref(db, `public_stories/${story.key}`));
                    showToast("Story Deleted");
                    currentStoryList.splice(currentStoryIndex, 1);
                    if(currentStoryList.length === 0) {
                        closeStoryViewer();
                        const cont = document.getElementById('my-profile-avatar-container');
                        if(cont) cont.classList.remove('has-story');
                    } else {
                        if(currentStoryIndex >= currentStoryList.length) currentStoryIndex = 0;
                        renderStoryItem(currentStoryIndex);
                    }
                }
            }
            toggleStoryMenu();
        };

        function setupStorySwipe() {
            storyViewerScreen.addEventListener('touchstart', (e) => {
                storySwipeStartY = e.touches[0].clientY;
            }, {passive: false});

            storyViewerScreen.addEventListener('touchend', (e) => {
                const endY = e.changedTouches[0].clientY;
                const diff = storySwipeStartY - endY;
                
                if(diff > 50) {
                    openStoryStats();
                }
                else if(diff < -50) {
                    if(document.getElementById('story-stats-sheet').classList.contains('open')) {
                        closeStoryStats();
                    } else {
                        closeStoryViewer();
                    }
                }
            }, {passive: false});
        }

        function openStoryStats() {
            const story = currentStoryList[currentStoryIndex];
            if(story.uid !== currentUser.uid) return; 
            
            if(storyTimer) clearInterval(storyTimer); 
            document.getElementById('sv-video').pause();
            document.getElementById('story-stats-sheet').classList.add('open');
        }

        function closeStoryStats() {
            document.getElementById('story-stats-sheet').classList.remove('open');
            const story = currentStoryList[currentStoryIndex];
            if(story.mediaType === 'video') document.getElementById('sv-video').play();
            renderStoryItem(currentStoryIndex);
        }

        function loadStoryStats(storyKey) {
            const count = Math.floor(Math.random() * 5); 
            document.getElementById('view-count').innerText = count;
            const list = document.getElementById('stats-list-content');
            list.innerHTML = '';
            
            if(count === 0) {
                list.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">No views yet</div>';
            } else {
                for(let i=0; i<count; i++) {
                    const div = document.createElement('div');
                    div.className = 'stat-item';
                    div.innerHTML = `
                        <div class="avatar" style="width:30px; height:30px; font-size:14px;"><i class="fa-solid fa-user-ninja"></i></div>
                        <div style="font-size:13px; font-weight:bold;">Ninja Viewer ${i+1}</div>
                        <div style="margin-left:auto; color:var(--accent); font-size:12px;"><i class="fa-solid fa-heart"></i> Liked</div>
                    `;
                    list.appendChild(div);
                }
            }
        }

        window.triggerGallery = () => {
            document.getElementById('photo-input').click();
            document.getElementById('attachment-menu').classList.remove('open');
        };

        window.triggerStoryUpload = () => {
            document.getElementById('story-file-input').click();
        };

        document.getElementById('story-file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const previewScreen = document.getElementById('story-preview-screen');
            storyImgPreview.style.display = 'none';
            storyVideoPreview.style.display = 'none';
            
            currentImageBase64 = null;
            currentVideoBase64 = null;
            currentMediaType = null;
            
            storyScale = 1;
            storyTranslateX = 0;
            storyTranslateY = 0;
            storyTextOverlays = [];
            document.querySelectorAll('.draggable-text').forEach(el => el.remove());
            
            updateStoryTransform(); 

            const reader = new FileReader();
            
            if (file.type.startsWith('image/')) {
                reader.onload = (ev) => {
                    storyImgPreview.src = ev.target.result;
                    storyImgPreview.style.display = 'block';
                    currentImageBase64 = ev.target.result;
                    currentMediaType = 'image';
                };
                reader.readAsDataURL(file);
            } else if (file.type.startsWith('video/')) {
                reader.onload = (ev) => {
                    storyVideoPreview.src = ev.target.result;
                    storyVideoPreview.style.display = 'block';
                    currentVideoBase64 = ev.target.result;
                    currentMediaType = 'video';
                };
                reader.readAsDataURL(file);
            }

            previewScreen.style.display = 'flex';
            e.target.value = '';
        });

        window.closeStoryPreview = () => {
             document.getElementById('story-preview-screen').style.display = 'none';
             const vid = document.getElementById('story-video-preview');
             vid.pause();
             vid.src = "";
        };

        function setupStoryGestures() {
            storyMediaContainer.addEventListener('touchstart', handleStoryTouchStart, {passive: false});
            storyMediaContainer.addEventListener('touchmove', handleStoryTouchMove, {passive: false});
            storyMediaContainer.addEventListener('touchend', handleStoryTouchEnd);
            
            storyMediaContainer.addEventListener('mousedown', (e) => {
                storyIsDragging = true;
                storyStartX = e.clientX;
                storyStartY = e.clientY;
            });
            storyMediaContainer.addEventListener('mousemove', (e) => {
                if(!storyIsDragging) return;
                const dx = e.clientX - storyStartX;
                const dy = e.clientY - storyStartY;
                storyTranslateX += dx;
                storyTranslateY += dy;
                storyStartX = e.clientX;
                storyStartY = e.clientY;
                updateStoryTransform();
            });
            storyMediaContainer.addEventListener('mouseup', () => storyIsDragging = false);
        }

        function handleStoryTouchStart(e) {
            e.preventDefault();
            if (e.touches.length === 2) {
                storyStartDist = getDistance(e.touches);
            } else if (e.touches.length === 1) {
                storyIsDragging = true;
                storyStartX = e.touches[0].clientX;
                storyStartY = e.touches[0].clientY;
            }
        }

        function handleStoryTouchMove(e) {
            e.preventDefault();
            if (e.touches.length === 2) {
                const newDist = getDistance(e.touches);
                const scaleChange = newDist / storyStartDist;
                
                const newScale = storyScale * scaleChange;
                if(newScale > 0.5 && newScale < 5) {
                    storyScale = newScale;
                    storyStartDist = newDist; 
                    updateStoryTransform();
                }
            } else if (e.touches.length === 1 && storyIsDragging) {
                const dx = e.touches[0].clientX - storyStartX;
                const dy = e.touches[0].clientY - storyStartY;
                
                storyTranslateX += dx;
                storyTranslateY += dy;
                
                storyStartX = e.touches[0].clientX;
                storyStartY = e.touches[0].clientY;
                updateStoryTransform();
            }
        }

        function handleStoryTouchEnd(e) {
            storyIsDragging = false;
        }

        function getDistance(touches) {
            return Math.hypot(
                touches[0].clientX - touches[1].clientX,
                touches[0].clientY - touches[1].clientY
            );
        }

        function updateStoryTransform() {
            const transform = `translate(${storyTranslateX}px, ${storyTranslateY}px) scale(${storyScale})`;
            storyImgPreview.style.transform = transform;
            storyVideoPreview.style.transform = transform;
        }

        window.openStoryTextEditor = () => {
            storyTextEditor.style.display = 'flex';
            storyTextInput.value = '';
            storyTextInput.focus();
        };

        window.closeStoryTextEditor = () => {
            storyTextEditor.style.display = 'none';
        };

        window.addStoryText = () => {
            const text = storyTextInput.value.trim();
            if(text) {
                const textEl = document.createElement('div');
                textEl.className = 'draggable-text';
                textEl.innerText = text;
                
                let tx = 0, ty = 0, tStartX = 0, tStartY = 0;
                
                textEl.addEventListener('touchstart', (e) => {
                    e.stopPropagation(); 
                    tStartX = e.touches[0].clientX - tx;
                    tStartY = e.touches[0].clientY - ty;
                    textEl.classList.add('active');
                });
                
                textEl.addEventListener('touchmove', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    tx = e.touches[0].clientX - tStartX;
                    ty = e.touches[0].clientY - tStartY;
                    textEl.style.transform = `translate(calc(-50% + ${tx}px), calc(-50% + ${ty}px))`;
                });
                
                textEl.addEventListener('touchend', () => textEl.classList.remove('active'));

                storyMediaContainer.appendChild(textEl);
            }
            closeStoryTextEditor();
        };

        window.uploadStoryToStore = async (type = 'public') => {
            if (!currentMediaType) return;

            closeStoryPreview();
            
            const avatarContainer = document.getElementById('my-profile-avatar-container');
            if (avatarContainer) {
                avatarContainer.classList.add('uploading');
                avatarContainer.classList.remove('has-story'); 
            }
            
            showToast(type === 'public' ? "Uploading to Story..." : "Sharing with Close Friends...");

            const storyData = {
                uid: currentUser.uid,
                username: currentUser.displayName,
                timestamp: Date.now(),
                type: type, 
                mediaType: currentMediaType
            };

            if (currentMediaType === 'image') {
                storyData.media = currentImageBase64;
            } else {
                storyData.media = currentVideoBase64;
            }

            setTimeout(async () => {
                await push(ref(db, 'public_stories'), storyData);
                
                if (avatarContainer) {
                    avatarContainer.classList.remove('uploading');
                    avatarContainer.classList.add('has-story');
                }
                showToast("Story Uploaded!");
            }, 1000);
        };

        // --- ADMIN PANEL LOGIC ---
        window.openAdminPanel = () => {
            if(!isUserAdmin) { showToast("Access Denied"); return; }
            history.pushState({page: 'admin'}, 'Admin', '#admin');
            
            adminDashboardScreen.style.display = 'flex';
            setTimeout(() => adminDashboardScreen.classList.add('active'), 10);
            mainNav.classList.remove('visible'); 
            profileScreen.classList.remove('active');

            get(ref(db, 'users')).then((snap) => {
                if(snap.exists()) {
                    const users = Object.values(snap.val());
                    document.getElementById('stat-total-users').innerText = users.length;
                    
                    const vipCount = users.filter(u => u.isVip === true).length;
                    document.getElementById('stat-vip-users').innerText = vipCount;
                }
            });

            get(ref(db, 'status')).then((snap) => {
                if(snap.exists()) {
                    const statuses = Object.values(snap.val());
                    const onlineCount = statuses.filter(s => s.state === 'online').length;
                    document.getElementById('stat-online-users').innerText = onlineCount;
                }
            });

            onValue(ref(db, 'app_settings/maintenance_mode'), (snap) => {
                const isMaintenance = snap.val() || false;
                const btn = document.getElementById('kill-switch-btn');
                const txt = document.getElementById('kill-switch-text');
                
                if(isMaintenance) {
                    btn.classList.add('active');
                    btn.style.background = "#444";
                    txt.innerText = "DEACTIVATE MAINTENANCE MODE";
                } else {
                    btn.classList.remove('active');
                    btn.style.background = "var(--accent)";
                    txt.innerText = "ACTIVATE MAINTENANCE MODE";
                }
            });
        };

        window.closeAdminPanel = () => {
            if(!isSystemBack && history.state && history.state.page === 'admin') { history.back(); return; }
            adminDashboardScreen.classList.remove('active');
            setTimeout(() => adminDashboardScreen.style.display = 'none', 300);
            profileScreen.classList.add('active');
            mainNav.classList.add('visible');
        };

        window.toggleMaintenanceMode = () => {
            get(ref(db, 'app_settings/maintenance_mode')).then((snap) => {
                const current = snap.val() || false;
                const confirmMsg = current ? "Turn ON the app for everyone?" : "Turn OFF the app for everyone (Emergency)?";
                
                openCustomModal("Admin Action", confirmMsg, async () => {
                    await set(ref(db, 'app_settings/maintenance_mode'), !current);
                    showToast("System State Updated");
                });
            });
        };

        // --- IMAGE & VIDEO & DOC HANDLING ---
        window.handlePhotoSelect = (input) => {
            if (!input.files || !input.files[0]) return;
            
            const file = input.files[0];

            micBtn.style.display = 'none';
            sendBtn.style.display = 'flex';

            currentImageBase64 = null;
            currentVideoBase64 = null;
            currentMediaType = null;
            currentVideoDuration = null;
            currentVideoSize = null;

            const validImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            const validVideoTypes = ['video/mp4', 'video/webm', 'video/ogg'];
            
            if (!validImageTypes.includes(file.type) && !validVideoTypes.includes(file.type)) {
                showToast("Invalid file type. Select Image or Video.");
                resetInput();
                return;
            }

            if (file.type.startsWith('image/')) {
                 if (file.size > 5 * 1024 * 1024) { 
                     showToast("Image too large (Max 5MB)");
                     resetInput();
                     return;
                 }
            } else if (file.type.startsWith('video/')) {
                 if (file.size > 10 * 1024 * 1024) { 
                     showToast("Video too large (Max 10MB)");
                     resetInput();
                     return;
                 }
            }

            const reader = new FileReader();

            if (file.type.startsWith('video/')) {
                currentVideoSize = (file.size / (1024 * 1024)).toFixed(1) + ' MB';

                const videoUrl = URL.createObjectURL(file);
                const tempVideo = document.createElement('video');
                tempVideo.src = videoUrl;
                
                tempVideo.onloadedmetadata = () => {
                    if (tempVideo.duration > 60) {
                        showToast("Video limit is 1 minute!");
                        resetInput();
                        return;
                    }
                    const m = Math.floor(tempVideo.duration / 60);
                    const s = Math.floor(tempVideo.duration % 60);
                    currentVideoDuration = `${m}:${s < 10 ? '0' : ''}${s}`;
                    tempVideo.currentTime = 1; 
                };

                tempVideo.onseeked = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = tempVideo.videoWidth;
                    canvas.height = tempVideo.videoHeight;
                    
                    const MAX_DIM = 480; 
                    if (canvas.width > MAX_DIM || canvas.height > MAX_DIM) {
                        const scale = Math.min(MAX_DIM / canvas.width, MAX_DIM / canvas.height);
                        canvas.width *= scale;
                        canvas.height *= scale;
                    }
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(tempVideo, 0, 0, canvas.width, canvas.height);
                    
                    previewImgTag.src = canvas.toDataURL('image/jpeg');
                    imagePreview.classList.add('show');
                    
                    reader.onload = (e) => {
                        currentVideoBase64 = e.target.result;
                        currentMediaType = 'video';
                        micBtn.style.display = 'none';
                        sendBtn.style.display = 'flex';
                    };
                    reader.readAsDataURL(file);
                };

            } 
            else if (file.type.startsWith('image/')) {
                reader.onload = (e) => {
                    currentImageBase64 = e.target.result;
                    currentMediaType = 'image';
                    previewImgTag.src = currentImageBase64;
                    imagePreview.classList.add('show');
                    micBtn.style.display = 'none';
                    sendBtn.style.display = 'flex';
                };
                reader.readAsDataURL(file);
            }
        };

        window.handleDocumentSelect = (input) => {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            
            if(file.size > 2 * 1024 * 1024) {
                showToast("File too large (Max 2MB)");
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                sendMessage(file.name, 'document', e.target.result, file.size);
            };
            reader.readAsDataURL(file);
        };

        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }

        window.openDoc = (url) => {
            const a = document.createElement('a');
            a.href = url;
            a.download = "download"; 
            a.target = "_blank";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };

        // --- LOCATION SHARING FUNCTIONS ---
        window.handleLocationShare = () => {
            if(!navigator.geolocation) {
                showToast("Geolocation is not supported by your browser");
                return;
            }
            
            showToast("Fetching location...");
            
            navigator.geolocation.getCurrentPosition((position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const coordString = `${lat},${lng}`;
                
                sendMessage(coordString, 'location');
                toggleAttachmentMenu(); 
                
            }, (error) => {
                showToast("Unable to retrieve location: " + error.message);
            });
        };

        // --- CONTACT SHARING ---
        window.handleContactShare = async () => {
            if ('contacts' in navigator && 'ContactsManager' in window) {
                try {
                    const props = ['name', 'tel'];
                    const opts = { multiple: false };
                    
                    const contacts = await navigator.contacts.select(props, opts);
                    
                    if (contacts.length) {
                        const contact = contacts[0];
                        const contactData = {
                            name: contact.name[0] || "Unknown",
                            tel: contact.tel[0] || ""
                        };
                        
                        sendMessage(JSON.stringify(contactData), 'contact');
                        toggleAttachmentMenu();
                    }
                } catch (ex) {
                }
            } else {
                showToast("Contact Picker not supported on this device/browser.");
            }
        };

        window.openMap = (link) => {
            window.open(link, '_blank');
        };

        function resetInput() {
            document.getElementById('photo-input').value = '';
            document.getElementById('doc-input').value = '';
            micBtn.style.display = 'flex';
            sendBtn.style.display = 'none';
        }

        window.cancelPhoto = () => {
            currentImageBase64 = null;
            currentVideoBase64 = null;
            currentMediaType = null;
            imagePreview.classList.remove('show');
            resetInput();
        };

        // --- LIGHTBOX FUNCTION ---
        window.openLightbox = (src, isVideo = false, isIcon = false) => {
            history.pushState({page: 'lightbox'}, 'Photo', '#photo');
            const lb = document.getElementById('lightbox');
            lb.style.display = 'flex';
            lb.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
            lb.classList.remove('zoomed'); 
            
            setTimeout(() => {
                lb.classList.add('active'); 
            }, 10);
            
            if (isIcon) {
                lightboxImg.style.display = 'none';
                lightboxVideo.style.display = 'none';
                lightboxIcon.style.display = 'flex';
                lightboxIcon.innerHTML = `<i class="fa-solid ${src}"></i>`;
            } else if (isVideo) {
                lightboxImg.style.display = 'none';
                lightboxIcon.style.display = 'none';
                lightboxVideo.style.display = 'block';
                lightboxVideo.src = src;
                lightboxVideo.play();
            } else {
                lightboxVideo.style.display = 'none';
                lightboxVideo.pause();
                lightboxIcon.style.display = 'none';
                lightboxImg.style.display = 'block';
                lightboxImg.src = src;
                lightboxImg.style.transform = ''; 
            }
        };

        window.closeLightbox = () => {
            if(!isSystemBack && history.state && history.state.page === 'lightbox') { history.back(); return; }
            const lb = document.getElementById('lightbox');
            lb.classList.remove('active'); 
            
            lb.style.display = 'none';
            lb.classList.remove('zoomed');
            lightboxVideo.pause();
            lightboxVideo.src = "";
            document.getElementById('lightbox-img').style.transform = ''; 
        };
        
        // --- SWIPE & ZOOM LOGIC FOR LIGHTBOX ---
        function setupLightboxSwipe() {
            let lbStartY = 0;
            let lastTap = 0; 
            const lb = document.getElementById('lightbox');
            const lbImg = document.getElementById('lightbox-img');
            const lbIcon = document.getElementById('lightbox-icon');
            
            lb.addEventListener('touchstart', e => { 
                const now = Date.now();
                if (now - lastTap < 300) {
                    e.preventDefault();
                    lb.classList.toggle('zoomed');
                }
                lastTap = now;
                lbStartY = e.touches[0].clientX; 
            }, {passive: false});

            lb.addEventListener('touchmove', e => {
                if(lb.classList.contains('zoomed')) return; 

                const currentY = e.touches[0].clientY;
                const diff = currentY - lbStartY;
                
                if(diff > 0) { 
                    e.preventDefault();
                    if(lbImg.style.display === 'block') lbImg.style.transform = `translateY(${diff}px)`;
                    if(lbIcon.style.display === 'flex') lbIcon.style.transform = `translateY(${diff}px)`;
                    
                    const opacity = Math.max(0, 0.9 - (diff/400));
                    lb.style.backgroundColor = `rgba(255,255,255,${opacity})`;
                }
            }, {passive: false});

            lb.addEventListener('touchend', e => {
                if(lb.classList.contains('zoomed')) return;

                const diff = e.changedTouches[0].clientY - lbStartY;
                if(diff > 100) { 
                    history.back(); 
                } else {
                    lbImg.style.transform = '';
                    lbIcon.style.transform = '';
                    lb.style.backgroundColor = 'rgba(255,255,255,0.9)';
                }
            });
        }
        
        window.openCustomModal = (title, text, onConfirm) => {
            if(isModalOpen) return; 
            isModalOpen = true;
            modalTitle.innerText = title;
            modalText.innerText = text;
            modalConfirmBtn.onclick = () => {
                onConfirm();
                closeCustomModal();
            };
            customModalOverlay.style.display = 'flex';
        };

        window.closeCustomModal = () => {
            customModalOverlay.style.display = 'none';
            isModalOpen = false;
        };

        window.openContactOptions = (uid, name) => {
            selectedContactId = uid;
            selectedContactName = name;
            optHeaderName.innerText = name;
            
            const customNameBtn = document.getElementById('btn-custom-name');
            if(customNameBtn) {
                if(!isVipUser) {
                    customNameBtn.classList.add('locked');
                    customNameBtn.innerHTML = `<i class="fa-solid fa-lock"></i> Custom Name (VIP)`;
                } else {
                    customNameBtn.classList.remove('locked');
                    customNameBtn.innerHTML = `<i class="fa-solid fa-pen-nib"></i> Custom Name`;
                }
            }

            contactOptionsModal.style.display = 'flex';
        };

        window.closeContactOptions = () => {
            contactOptionsModal.style.display = 'none';
        };

        window.handleBlock = () => { showToast("Block feature coming soon"); closeContactOptions(); };
        
        window.handleReport = () => { 
            closeContactOptions();
            document.getElementById('report-modal-overlay').style.display = 'flex';
        };
        
        window.submitReport = (type) => {
            document.getElementById('report-modal-overlay').style.display = 'none';
            showToast(`Reported: ${type}. Admins will review.`);
        };

        window.handleCustomName = () => {
             if (!isVipUser) {
                 showToast("VIP Badge Required to Change Names!");
                 return;
             }
             closeContactOptions();
             document.getElementById('custom-name-modal-overlay').style.display = 'flex';
             document.getElementById('custom-name-input').value = selectedContactName.startsWith('# ') ? selectedContactName.substring(2) : selectedContactName;
        };

        window.saveCustomName = async () => {
            const input = document.getElementById('custom-name-input').value;
            if(!input) return;
            const newName = "# " + input;
            
            if(selectedContactId) {
                await update(ref(db, `user-contacts/${currentUser.uid}/${selectedContactId}`), {
                    name: newName
                });
                showToast("Custom Name Set!");
            }
            document.getElementById('custom-name-modal-overlay').style.display = 'none';
        };

        window.handleDeleteContact = () => {
            openCustomModal("Delete Contact?", "This will remove the user and DELETE all chat history.", async () => {
                if(!selectedContactId) return;
                const chatId = [currentUser.uid, selectedContactId].sort().join('_');
                await remove(ref(db, `user-contacts/${currentUser.uid}/${selectedContactId}`));
                await remove(ref(db, `private-messages/${chatId}`));
                loadDiscoverUsers();
                showToast("Contact & Data Deleted");
                closeContactOptions();
            });
            contactOptionsModal.style.display = 'none'; 
        };

        // --- GROUP LONG PRESS LOGIC ---
        let selectedGroupForOptions = null;

        window.openGroupOptions = (channelId, name) => {
            selectedGroupForOptions = channelId;
            document.getElementById('group-opt-header-name').innerText = name;
            document.getElementById('group-options-modal').style.display = 'flex';
        };

        window.closeGroupOptions = () => {
            document.getElementById('group-options-modal').style.display = 'none';
        };

        window.handleReportGroup = () => {
            closeGroupOptions();
            showToast("Group Reported. Admins will review.");
        };

        window.confirmLeaveGroup = () => {
            closeGroupOptions();
            openCustomModal("Leave Group?", "You will stop receiving messages and it will be removed from your list.", async () => {
                if(selectedGroupForOptions && currentUser) {
                    await remove(ref(db, `channels/${selectedGroupForOptions}/members/${currentUser.uid}`));
                    showToast("Left Group");
                    // loadHomeChats() uses onValue so it will update automatically
                }
            });
        };

        function resetDiscoverButton(targetUid) {
            const btn = document.getElementById(`btn-${targetUid}`);
            if(btn) {
                btn.innerText = "Add +";
                btn.className = "add-btn"; 
                btn.onclick = (e) => { event.stopPropagation(); sendRequest(targetUid); };
                btn.disabled = false;
            }
        }

        // --- NEW WHATSAPP-LIKE VOICE RECORDING LOGIC ---
        function setupVoiceRecording() {
            // Touch Start -> Initiate Recording
            micBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startVoiceRecording(e);
            }, {passive: false});

            // Touch Move -> Handle cancellation slide
            micBtn.addEventListener('touchmove', (e) => {
                e.preventDefault();
                handleVoiceMove(e);
            }, {passive: false});

            // Touch End -> Stop & Send
            micBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                stopVoiceInteraction();
            }, {passive: false});

            // Mouse Events for Desktop Testing
            micBtn.addEventListener('mousedown', (e) => {
                startVoiceRecording(e);
                const moveHandler = (moveE) => handleVoiceMove(moveE);
                const upHandler = () => {
                    stopVoiceInteraction();
                    document.removeEventListener('mousemove', moveHandler);
                    document.removeEventListener('mouseup', upHandler);
                };
                document.addEventListener('mousemove', moveHandler);
                document.addEventListener('mouseup', upHandler);
            });
            
            // Handle simple click (just a toast)
            micBtn.onclick = (e) => {
                // If it wasn't a long press handled by touchstart
                if(!isRecording && !isVoiceLocked) {
                    showToast("Hold to record, release to send");
                }
            };
        }

        async function startVoiceRecording(e) {
            if(isVoiceLocked) return; 

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { showToast("Voice recording not supported"); return; }
            
            const touch = e.touches ? e.touches[0] : e;
            voiceTouchStartY = touch.clientY;
            voiceTouchStartX = touch.clientX;

            // Optional: Delay slightly to differentiate tap vs hold, but instant is snappier
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
                mediaRecorder.start();
                
                isRecording = true;
                micBtn.classList.add('recording', 'active-hold');
                
                // Show UI Elements
                voiceLockIndicator.style.display = 'flex';
                voiceSlideCancel.style.display = 'flex';
                recPreview.classList.add('show');
                trashIcon.style.display = 'block';
                trashIcon.style.transform = 'scale(0.8)';
                trashIcon.style.opacity = '0.5';
                
                document.getElementById('msg-input').disabled = true;
                
                recStartTime = Date.now();
                recInterval = setInterval(() => {
                    const diff = Math.floor((Date.now() - recStartTime) / 1000);
                    const m = Math.floor(diff / 60);
                    const s = diff % 60;
                    const timeStr = `${m}:${s < 10 ? '0' : ''}${s}`;
                    recTimerTxt.innerText = timeStr;
                    recLockedTimeTxt.innerText = timeStr; 
                }, 1000);

                if(currentChatIdString && !isAdminChat && !isChannelChat) {
                    set(ref(db, `typing_status/${currentChatIdString}/${currentUser.uid}`), 'recording');
                }
                
                if(navigator.vibrate) navigator.vibrate(50);

            } catch (err) { showToast("Microphone access denied"); }
        }

        function handleVoiceMove(e) {
            if(!isRecording || isVoiceLocked) return;
            
            const touch = e.touches ? e.touches[0] : e;
            const diffY = touch.clientY - voiceTouchStartY; 
            const diffX = touch.clientX - voiceTouchStartX; 

            // Slide Up to Lock
            if(diffY < -50) {
                lockVoiceRecording();
            }

            // Move Mic Left with Finger
            if(diffX < 0) {
                micBtn.style.transform = `translateX(${diffX}px) scale(1.2)`;
                
                // Opacity of Slide text
                const cancelOpacity = Math.max(0, 1 - (Math.abs(diffX) / 100));
                voiceSlideCancel.style.opacity = cancelOpacity;
                
                // Scale Trash Can
                const trashScale = Math.min(1.5, 0.8 + (Math.abs(diffX) / 100));
                trashIcon.style.transform = `scale(${trashScale})`;
                trashIcon.style.opacity = Math.min(1, 0.5 + (Math.abs(diffX) / 100));
            }

            // Cancel Threshold (swiped far left)
            if(diffX < -150) {
                trashIcon.classList.add('anim-trash-in');
                setTimeout(() => {
                    cancelVoiceRecording();
                    trashIcon.classList.remove('anim-trash-in');
                }, 200);
            }
        }

        function stopVoiceInteraction() {
            if(isVoiceLocked) return; 
            
            if(isRecording) {
                // If duration is very short (tap), cancel it
                if (Date.now() - recStartTime < 500) {
                    cancelVoiceRecording();
                    showToast("Hold to record");
                } else {
                    sendVoiceRecording();
                }
            }
        }

        function lockVoiceRecording() {
            isVoiceLocked = true;
            micBtn.classList.remove('active-hold'); 
            micBtn.style.transform = 'none';
            
            voiceLockIndicator.style.display = 'none';
            voiceSlideCancel.style.display = 'none';
            recPreview.classList.remove('show');
            trashIcon.style.display = 'none';
            
            document.querySelector('.msg-input-area').style.display = 'none'; 
            recordingLockedView.style.display = 'flex'; 
            
            if(navigator.vibrate) navigator.vibrate(50);
        }

        window.cancelVoiceRecording = () => {
            if(mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            cleanupVoiceUI();
            if(navigator.vibrate) navigator.vibrate(50);
        };

        window.sendVoiceRecording = async () => {
            if(mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                
                setTimeout(() => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    // Calculate duration roughly
                    const durationSecs = Math.floor((Date.now() - recStartTime) / 1000);
                    const m = Math.floor(durationSecs / 60);
                    const s = durationSecs % 60;
                    currentVideoDuration = `${m}:${s < 10 ? '0' : ''}${s}`; // Temporarily store duration

                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = () => { 
                        sendMessage(null, 'audio', reader.result); 
                    };
                    
                    if(mediaRecorder.stream) {
                        mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    }
                }, 200);
            }
            cleanupVoiceUI();
        };

        function cleanupVoiceUI() {
            isRecording = false;
            isVoiceLocked = false;
            audioChunks = [];
            
            micBtn.classList.remove('recording', 'active-hold');
            micBtn.style.transform = 'none';
            voiceSlideCancel.style.opacity = '1';
            
            voiceLockIndicator.style.display = 'none';
            voiceSlideCancel.style.display = 'none';
            recPreview.classList.remove('show');
            recordingLockedView.style.display = 'none';
            trashIcon.style.display = 'none';
            
            document.querySelector('.msg-input-area').style.display = 'flex'; 
            
            document.getElementById('msg-input').disabled = false;
            recTimerTxt.innerText = "0:00";
            recLockedTimeTxt.innerText = "0:00";
            clearInterval(recInterval);
            
            if(currentChatIdString && !isAdminChat && !isChannelChat) {
                set(ref(db, `typing_status/${currentChatIdString}/${currentUser.uid}`), false);
            }
        }

        // --- WEBRTC CALLS ---
        window.switchCamera = async () => {
            if (currentFacingMode === 'user') currentFacingMode = 'environment';
            else currentFacingMode = 'user';
            if(localStream) { localStream.getVideoTracks().forEach(track => track.stop()); }
            const videoConstraints = { width: { ideal: 640 }, height: { ideal: 480 }, frameRate: { max: 24 }, facingMode: { exact: currentFacingMode } };
            try {
                const newStream = await navigator.mediaDevices.getUserMedia({ video: videoConstraints, audio: true });
                const videoTrack = newStream.getVideoTracks()[0];
                const sender = peerConnection.getSenders().find(s => s.track.kind === 'video');
                if(sender) sender.replaceTrack(videoTrack);
                localVideo.srcObject = newStream;
                localStream = newStream;
            } catch (e) { showToast("Cannot switch camera"); }
        };

        window.startCall = async (type) => {
            if(!currentChatUserUid || isAdminChat || isChannelChat) return; 
            currentFacingMode = 'user'; 
            
            const overlay = document.getElementById('call-overlay');
            overlay.classList.add('connecting'); // Local video full screen
            overlay.classList.remove('connected');

            if(type === 'audio') { overlay.classList.add('audio-mode'); flipBtn.style.display = 'none'; } else { overlay.classList.remove('audio-mode'); flipBtn.style.display = 'flex'; }
            
            callRemoteName.innerText = document.getElementById('chat-room-name').innerText;
            callStatusText.innerText = "CALLING...";
            callTimerDisplay.style.display = 'none';
            overlay.style.display = 'flex';
            
            document.querySelector('.call-info-top').classList.remove('ui-hidden');
            document.querySelector('.call-controls').classList.remove('ui-hidden');
            
            // Set Remote Avatar
            const callAvatarEl = document.querySelector('.audio-placeholder .call-avatar');
            if (activeChatAvatarHTML.includes('<img')) {
                const src = activeChatAvatarHTML.match(/src="([^"]*)"/)[1];
                callAvatarEl.innerHTML = `<img src="${src}">`;
            } else {
                callAvatarEl.innerHTML = activeChatAvatarHTML;
            }
            
            audioOutgoing.play().catch(e => {});

            const callRef = ref(db, `calls/${currentChatUserUid}`);
            const constraints = { audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }, video: type === 'video' ? { width: { ideal: 640 }, height: { ideal: 480 }, frameRate: { max: 24 }, facingMode: 'user' } : false };
            try {
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                localVideo.srcObject = localStream;
                peerConnection = new RTCPeerConnection(servers);
                peerConnection.onconnectionstatechange = () => { 
                    const state = peerConnection.connectionState; 
                    if(state === 'disconnected' || state === 'failed') { 
                        callStatusText.innerText = "Reconnecting..."; 
                        callStatusText.style.color = "var(--accent)"; 
                    } else if (state === 'connected') { 
                        callStatusText.innerText = "CONNECTED"; 
                        callStatusText.style.color = "var(--gold)"; 
                        audioOutgoing.pause();
                        audioOutgoing.currentTime = 0;
                        overlay.classList.remove('connecting'); // Local video small
                        overlay.classList.add('connected');
                    } 
                };
                localStream.getTracks().forEach(track => { peerConnection.addTrack(track, localStream); });
                peerConnection.ontrack = (event) => { remoteVideo.srcObject = event.streams[0]; };
                peerConnection.onicecandidate = (event) => { if (event.candidate) push(child(callRef, 'callerCandidates'), event.candidate.toJSON()); };
                const offerDescription = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offerDescription);
                await set(callRef, { callerId: currentUser.uid, callerName: currentUser.displayName, type: type, offer: { type: offerDescription.type, sdp: offerDescription.sdp } });
                onValue(callRef, (snapshot) => { const data = snapshot.val(); if (data && data.answer && !peerConnection.currentRemoteDescription) { peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer)); audioOutgoing.pause(); callStatusText.innerText = "CONNECTED"; startCallTimer(); } if (!data) handleCallCleanup(); });
                onChildAdded(child(callRef, 'calleeCandidates'), (snapshot) => { if(peerConnection) peerConnection.addIceCandidate(new RTCIceCandidate(snapshot.val())); });
            } catch (err) { alert("Could not access media."); handleCallCleanup(); }
        };

        window.toggleCallUI = (e) => {
            if(isDragging) return;
            if(e.target.closest('.call-btn') || e.target.closest('.call-avatar')) return;
            
            const overlay = document.getElementById('call-overlay');
            const bottom = document.querySelector('.call-controls');
            const topInfo = document.querySelector('.call-info-top');
            
            bottom.classList.toggle('ui-hidden');
            topInfo.classList.toggle('ui-hidden');

            if (bottom.classList.contains('ui-hidden')) {
                overlay.classList.remove('ui-active');
            } else {
                overlay.classList.add('ui-active');
            }
        };

        function listenForIncomingCalls() {
            onValue(ref(db, `calls/${currentUser.uid}`), (snapshot) => {
                const data = snapshot.val();
                if (data && data.offer && !isCallActive) {
                    incomingCallData = data;
                    document.getElementById('incoming-name').innerText = data.callerName;
                    incomingCallModal.style.display = 'flex';
                    audioIncoming.src = 'https://assets.mixkit.co/active_storage/sfx/2044/2044-preview.mp3';
                    audioIncoming.play().catch(e => {});
                } else { 
                    incomingCallModal.style.display = 'none'; 
                    audioIncoming.pause(); 
                    audioIncoming.currentTime = 0; 
                }
            });
        }

        window.acceptCall = async () => {
            isCallActive = true; 
            currentFacingMode = 'user';
            incomingCallModal.style.display = 'none'; 
            audioIncoming.pause(); audioIncoming.currentTime = 0; 

            const overlay = document.getElementById('call-overlay');
            overlay.classList.remove('connecting');
            overlay.classList.add('connected'); // Local video small from start of acceptance

            if(incomingCallData.type === 'audio') { overlay.classList.add('audio-mode'); flipBtn.style.display = 'none'; } else { overlay.classList.remove('audio-mode'); flipBtn.style.display = 'flex'; }
            callRemoteName.innerText = incomingCallData.callerName; callStatusText.innerText = "CONNECTING..."; overlay.style.display = 'flex';
            
            document.querySelector('.call-info-top').classList.remove('ui-hidden');
            document.querySelector('.call-controls').classList.remove('ui-hidden');
            overlay.classList.add('ui-active');

            // Set Remote Avatar
            const callAvatarEl = document.querySelector('.audio-placeholder .call-avatar');
            callAvatarEl.innerHTML = '<i class="fa-solid fa-user-ninja"></i>'; 
            
            get(ref(db, `users/${incomingCallData.callerId}`)).then(snap => {
                const uData = snap.val();
                if (uData) {
                    if(uData.icon === 'custom' && uData.customAvatar) {
                        callAvatarEl.innerHTML = `<img src="${uData.customAvatar}">`;
                    } else {
                        callAvatarEl.innerHTML = `<i class="fa-solid ${uData.icon || 'fa-user-ninja'}"></i>`;
                    }
                }
            });

            const constraints = { audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }, video: incomingCallData.type === 'video' ? { width: { ideal: 640 }, height: { ideal: 480 }, frameRate: { max: 24 }, facingMode: 'user' } : false };
            try {
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                localVideo.srcObject = localStream;
                peerConnection = new RTCPeerConnection(servers);
                peerConnection.onconnectionstatechange = () => { const state = peerConnection.connectionState; if(state === 'disconnected' || state === 'failed') { callStatusText.innerText = "Reconnecting..."; callStatusText.style.color = "var(--accent)"; } else if (state === 'connected') { callStatusText.innerText = "CONNECTED"; callStatusText.style.color = "var(--gold)"; } };
                localStream.getTracks().forEach(track => { peerConnection.addTrack(track, localStream); });
                peerConnection.ontrack = (event) => { remoteVideo.srcObject = event.streams[0]; };
                peerConnection.onicecandidate = (event) => { if (event.candidate) push(child(ref(db, `calls/${currentUser.uid}`), 'calleeCandidates'), event.candidate.toJSON()); };
                onChildAdded(child(ref(db, `calls/${currentUser.uid}`), 'callerCandidates'), (snapshot) => { if(peerConnection) peerConnection.addIceCandidate(new RTCIceCandidate(snapshot.val())); });
                await peerConnection.setRemoteDescription(new RTCSessionDescription(incomingCallData.offer));
                const answerDescription = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answerDescription);
                await update(ref(db, `calls/${currentUser.uid}`), { answer: { type: answerDescription.type, sdp: answerDescription.sdp } });
                callStatusText.innerText = "CONNECTED"; startCallTimer();
                onValue(ref(db, `calls/${currentUser.uid}`), (snap) => { if(!snap.exists()) handleCallCleanup(); });
            } catch(err) { handleCallCleanup(); }
        };

        window.rejectCall = async () => { incomingCallModal.style.display = 'none'; audioIncoming.pause(); audioIncoming.currentTime = 0; await remove(ref(db, `calls/${currentUser.uid}`)); };
        window.endCall = async () => { if(currentChatUserUid) await remove(ref(db, `calls/${currentChatUserUid}`)); await remove(ref(db, `calls/${currentUser.uid}`)); handleCallCleanup(); };

        function handleCallCleanup() {
            isCallActive = false; 
            if(localStream) { localStream.getTracks().forEach(track => { track.stop(); track.enabled = false; }); localStream = null; }
            if(localVideo.srcObject) { localVideo.srcObject.getTracks().forEach(t => t.stop()); localVideo.srcObject = null; }
            if(peerConnection) { peerConnection.close(); peerConnection = null; }
            
            audioOutgoing.pause(); audioOutgoing.currentTime = 0;
            audioIncoming.pause(); audioIncoming.currentTime = 0;

            clearInterval(callTimerInterval);
            callTimerDisplay.innerText = "00:00"; callTimerDisplay.style.display = 'none'; 
            
            const overlay = document.getElementById('call-overlay');
            overlay.style.display = 'none'; 
            overlay.classList.remove('connecting', 'connected', 'ui-active');
            
            incomingCallModal.style.display = 'none';
            callStatusText.style.color = "var(--gold)";
        }

        function startCallTimer() {
            callSeconds = 0; callTimerDisplay.style.display = 'block'; clearInterval(callTimerInterval);
            callTimerInterval = setInterval(() => { callSeconds++; const mins = Math.floor(callSeconds / 60); const secs = callSeconds % 60; callTimerDisplay.innerText = `${mins < 10 ? '0' : ''}${mins}:${secs < 10 ? '0' : ''}${secs}`; }, 1000);
        }

        window.toggleMute = () => { if(localStream) { const at = localStream.getAudioTracks()[0]; at.enabled = !at.enabled; document.getElementById('mute-btn').classList.toggle('active'); }};
        window.toggleSpeaker = () => { document.getElementById('speaker-btn').classList.toggle('active'); if(remoteVideo) remoteVideo.muted = !remoteVideo.muted; };

        // --- NAVIGATION & LOGIC ---
        function setupSwipeNav() {
            const screens = [homeScreen, requestsScreen, discoverScreen, channelScreen, profileScreen];
            const tabs = ['home', 'requests', 'discover', 'channel', 'profile'];
            screens.forEach(screen => {
                let startX = 0; let startY = 0;
                screen.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; startY = e.touches[0].clientY; });
                screen.addEventListener('touchend', (e) => {
                    const diffX = e.changedTouches[0].clientX - startX;
                    const diffY = e.changedTouches[0].clientY - startY;
                    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 60) {
                        const currentTabId = document.querySelector('.nav-item.active-nav').id;
                        let currentIndex = 0;
                        if(currentTabId === 'nav-home') currentIndex = 0;
                        if(currentTabId === 'nav-requests') currentIndex = 1;
                        if(currentTabId === 'nav-discover') currentIndex = 2;
                        if(currentTabId === 'nav-channel') currentIndex = 3;
                        if(currentTabId === 'nav-profile') currentIndex = 4;
                        
                        if (diffX < 0 && currentIndex < 4) { switchTab(tabs[currentIndex + 1], 'swipe-left'); } 
                        else if (diffX > 0 && currentIndex > 0) { switchTab(tabs[currentIndex - 1], 'swipe-right'); }
                    }
                });
            });
        }

        window.switchTab = (tab, effect = 'tap') => {
            const currentActive = document.querySelector('.screen.active');
            const targetScreen = document.getElementById(`${tab}-screen`);
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active-nav'));
            
            if(tab === 'home') document.getElementById('nav-home').classList.add('active-nav');
            if(tab === 'requests') document.getElementById('nav-requests').classList.add('active-nav');
            if(tab === 'discover') document.getElementById('nav-discover').classList.add('active-nav');
            if(tab === 'channel') document.getElementById('nav-channel').classList.add('active-nav');
            if(tab === 'profile') {
                document.getElementById('nav-profile').classList.add('active-nav');
                loadMyProfile();
            }
            
            if(currentActive) currentActive.classList.remove('active', 'anim-tap', 'anim-slide-left', 'anim-slide-right');
            targetScreen.classList.add('active');
            if(effect === 'tap') targetScreen.classList.add('anim-tap');
            else if(effect === 'swipe-left') targetScreen.classList.add('anim-slide-left');
            else if(effect === 'swipe-right') targetScreen.classList.add('anim-slide-right');
        };

        function setupPresence() {
            const connectedRef = ref(db, ".info/connected");
            const userStatusRef = ref(db, `status/${currentUser.uid}`);
            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    onDisconnect(userStatusRef).set({ state: 'offline', last_changed: serverTimestamp() });
                    set(userStatusRef, { state: 'online', last_changed: serverTimestamp() });
                }
            });
        }

        window.logout = () => {
            if(currentUser) set(ref(db, `status/${currentUser.uid}`), { state: 'offline', last_changed: serverTimestamp() });
            // FIX: Removed window.location.reload() to prevent white screen
            signOut(auth);
        };

        function timeAgo(dateParam) {
            if (!dateParam) return '';
            const date = new Date(dateParam);
            const seconds = Math.round((new Date() - date) / 1000);
            if (seconds < 60) return 'Just now';
            const minutes = Math.round(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.round(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.round(hours / 24);
            return `${days}d ago`;
        }

        function formatDateLabel(timestamp) {
            const date = new Date(timestamp);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === today.toDateString()) return "Today";
            if (date.toDateString() === yesterday.toDateString()) return "Yesterday";
            const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            const diffTime = Math.abs(today - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            if (diffDays < 7) return days[date.getDay()];
            return date.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function loadDiscoverUsers() {
            renderSkeleton('discover-list');
            get(ref(db, `user-contacts/${currentUser.uid}`)).then((contactSnap) => {
                const contacts = contactSnap.val() || {};
                
                onValue(ref(db, 'users'), (snapshot) => {
                    discoverList.innerHTML = '';
                    const users = snapshot.val();
                    if (!users) { discoverList.innerHTML = '<div style="padding:20px;text-align:center">No users found.</div>'; return; }
                    Object.values(users).forEach(user => {
                        if (user.uid === currentUser.uid || contacts[user.uid]) return;
                        
                        const div = document.createElement('div');
                        div.className = 'list-item';
                        
                        const isVip = user.isVip || false;
                        const vipBadgeHtml = isVip ? `<div class="vip-badge">VIP</div>` : '';
                        
                        let avatarHtml = '';
                        let lightboxUrl = '';
                        let isIcon = false;

                        if (user.icon === 'custom' && user.customAvatar) {
                            avatarHtml = `<img src="${user.customAvatar}" class="custom-user-img">`;
                            lightboxUrl = user.customAvatar;
                        } else {
                            const iconClass = `fa-solid ${user.icon || 'fa-user-ninja'} ${isVip ? 'vip-gold-icon' : ''}`;
                            avatarHtml = `<i class="${iconClass}"></i>`;
                            lightboxUrl = user.icon || 'fa-user-ninja';
                            isIcon = true;
                        }
                        
                        div.onclick = () => viewUserProfile(user.uid, user.username, 'Member');
                        
                        div.innerHTML = `
                            <div class="avatar-container" onclick="event.stopPropagation(); openLightbox('${lightboxUrl}', false, ${isIcon})">
                                <div class="avatar">${avatarHtml}</div>
                                ${vipBadgeHtml}
                            </div>
                            <div class="chat-info"><h3>${user.username}</h3><p>Ninja</p></div>
                            <button class="add-btn" id="btn-${user.uid}" onclick="event.stopPropagation(); sendRequest('${user.uid}')">Add +</button>
                        `;
                        discoverList.appendChild(div);
                        updateButtonState(user.uid);
                    });
                });
            });
        }

        window.sendRequest = async (targetUid) => {
            const btn = document.getElementById(`btn-${targetUid}`);
            btn.innerText = 'Sending...';
            await set(ref(db, `friend-requests/${targetUid}/${currentUser.uid}`), { name: currentUser.displayName, uid: currentUser.uid });
            
            btn.innerText = 'Requested'; 
            btn.classList.add('requested');
            btn.onclick = (e) => { event.stopPropagation(); cancelRequest(targetUid); };
        };

        window.cancelRequest = async (targetUid) => {
            const btn = document.getElementById(`btn-${targetUid}`);
            btn.innerText = 'Canceling...';
            await remove(ref(db, `friend-requests/${targetUid}/${currentUser.uid}`));
            
            btn.innerText = 'Add +';
            btn.classList.remove('requested');
            btn.onclick = (e) => { event.stopPropagation(); sendRequest(targetUid); };
        };

        async function updateButtonState(targetUid) {
            const btn = document.getElementById(`btn-${targetUid}`);
            if(!btn) return;
            const friendSnap = await get(child(ref(db), `user-contacts/${currentUser.uid}/${targetUid}`));
            if(friendSnap.exists()) { 
                btn.innerText = 'Added'; 
                btn.classList.add('requested'); 
                btn.disabled = true; 
                return; 
            }
            const reqRef = child(ref(db), `friend-requests/${targetUid}/${currentUser.uid}`);
            const reqSnap = await get(reqRef);
            if(reqSnap.exists()) { 
                btn.innerText = 'Requested'; 
                btn.classList.add('requested'); 
                btn.onclick = (e) => { event.stopPropagation(); cancelRequest(targetUid); };
                btn.disabled = false;
            }
        }

        window.filterDiscover = () => {
            const input = document.getElementById('discover-search').value.toUpperCase();
            const items = discoverList.getElementsByClassName('list-item');
            for (let item of items) {
                const name = item.getElementsByTagName('h3')[0].innerText;
                item.style.display = name.toUpperCase().indexOf(input) > -1 ? 'flex' : 'none';
            }
        };

        function loadRequests() {
            renderSkeleton('requests-list');
            onValue(ref(db, `friend-requests/${currentUser.uid}`), (snapshot) => {
                requestsList.innerHTML = '';
                const reqs = snapshot.val();
                if(!reqs) { requestsList.innerHTML = `<div class="empty-state"><i class="fa-solid fa-ghost"></i><p>No new requests</p></div>`; return; }
                
                Object.values(reqs).forEach(async req => {
                    const userSnap = await get(ref(db, `users/${req.uid}`));
                    const userData = userSnap.val();
                    let avatarHtml = '';
                    let lightboxUrl = '';
                    let isIcon = false;
                    let isVip = userData && userData.isVip;

                    if (userData && userData.icon === 'custom' && userData.customAvatar) {
                        avatarHtml = `<img src="${userData.customAvatar}" class="custom-user-img">`;
                        lightboxUrl = userData.customAvatar;
                    } else {
                        const icon = userData && userData.icon ? userData.icon : 'fa-user-ninja';
                        const iconClass = `fa-solid ${icon} ${isVip ? 'vip-gold-icon' : ''}`;
                        avatarHtml = `<i class="${iconClass}"></i>`;
                        lightboxUrl = icon;
                        isIcon = true;
                    }
                    
                    const div = document.createElement('div');
                    div.className = 'req-card'; 
                    const safeName = req.name.replace(/'/g, "\\'"); 
                    
                    div.onclick = (e) => {
                        if(!e.target.closest('.action-btn-dark') && !e.target.closest('.avatar-container')) {
                             viewUserProfile(req.uid, req.name, 'Pending');
                        }
                    };

                    div.innerHTML = `
                        <div class="req-header">
                            <div class="avatar-container" onclick="event.stopPropagation(); openLightbox('${lightboxUrl}', false, ${isIcon})">
                                <div class="avatar">${avatarHtml}</div>
                                ${isVip ? '<div class="vip-badge">VIP</div>' : ''}
                            </div>
                            <div class="req-info">
                                <div class="req-name">${req.name}</div>
                                <div class="req-uid">@${userData ? userData.username : 'ninja'}</div>
                            </div>
                        </div>
                        <div class="req-actions">
                            <button class="action-btn-dark btn-dark-accept" onclick="event.stopPropagation(); acceptRequest('${req.uid}', '${safeName}')">
                                <i class="fa-solid fa-check"></i> ACCEPT
                            </button>
                            <button class="action-btn-dark btn-dark-reject" onclick="event.stopPropagation(); rejectRequest('${req.uid}')">
                                <i class="fa-solid fa-xmark"></i> REJECT
                            </button>
                        </div>`;
                    requestsList.appendChild(div);
                });
            });
        }

        window.acceptRequest = async (senderUid, senderName) => {
            await set(ref(db, `user-contacts/${currentUser.uid}/${senderUid}`), { name: senderName, uid: senderUid });
            await set(ref(db, `user-contacts/${senderUid}/${currentUser.uid}`), { name: currentUser.displayName, uid: currentUser.uid });
            await remove(ref(db, `friend-requests/${currentUser.uid}/${senderUid}`));
        };

        window.rejectRequest = async (senderUid) => { await remove(ref(db, `friend-requests/${currentUser.uid}/${senderUid}`)); resetDiscoverButton(senderUid); };

        function loadHomeChats() {
            renderSkeleton('private-chat-list');
            
            // 1. Fetch Direct Contacts
            onValue(ref(db, `user-contacts/${currentUser.uid}`), (snapshot) => {
                const contacts = snapshot.val() || {};
                
                // 2. Fetch Channels (to filter private groups I'm in)
                onValue(ref(db, 'channels'), (channelSnap) => {
                    privateChatList.innerHTML = '';
                    const channelsData = channelSnap.val() || {};
                    
                    let chatItems = [];

                    // Process Direct Contacts
                    Object.values(contacts).forEach(contact => {
                        chatItems.push({ type: 'direct', data: contact });
                    });

                    // Process Private Groups
                    Object.entries(channelsData).forEach(([key, channel]) => {
                        const isMember = channel.members && channel.members[currentUser.uid];
                        const isPrivate = (channel.type === 'private');
                        
                        // If I am a member AND it is a private group
                        if (isMember && isPrivate) {
                            chatItems.push({ type: 'group', id: key, data: channel });
                        }
                    });

                    if (chatItems.length === 0) { 
                        privateChatList.innerHTML = '<div style="padding:20px; text-align:center; color:#999; font-size:13px;">No chats yet.</div>'; 
                        return; 
                    }

                    // Render merged list
                    chatItems.forEach(async item => {
                        const div = document.createElement('div');
                        div.className = 'list-item';

                        if (item.type === 'direct') {
                            const contact = item.data;
                            // ... Existing contact rendering logic ...
                            const userSnap = await get(ref(db, `users/${contact.uid}`));
                            const userData = userSnap.val();
                            const isVip = userData && userData.isVip ? true : false;
                            const vipBadgeHtml = isVip ? `<div class="vip-badge">VIP</div>` : '';

                            let avatarHtml = '';
                            let lightboxUrl = '';
                            let isIcon = false;

                            if (userData && userData.icon === 'custom' && userData.customAvatar) {
                                avatarHtml = `<img src="${userData.customAvatar}" class="custom-user-img">`;
                                lightboxUrl = userData.customAvatar;
                            } else {
                                const icon = userData && userData.icon ? userData.icon : 'fa-user-ninja';
                                const iconClass = `fa-solid ${icon} ${isVip ? 'vip-gold-icon' : ''}`;
                                avatarHtml = `<i class="${iconClass}"></i>`;
                                lightboxUrl = icon;
                                isIcon = true;
                            }

                            div.onclick = (e) => { 
                                if(!e.target.closest('.avatar-container')) {
                                    openChat(contact.uid, contact.name, true); 
                                }
                            };
                            
                            // Setup Long Press for contacts
                            let pressTimer;
                            let isLongPress = false;
                            div.addEventListener('touchstart', (e) => {
                                if(e.target.closest('.avatar-container')) return; 
                                isLongPress = false;
                                div.classList.add('scale-active');
                                pressTimer = setTimeout(() => { 
                                    isLongPress = true;
                                    openContactOptions(contact.uid, contact.name); 
                                    if(navigator.vibrate) navigator.vibrate(50);
                                }, 600);
                            }, {passive: false});
                            div.addEventListener('touchend', () => { clearTimeout(pressTimer); div.classList.remove('scale-active'); });
                            div.addEventListener('touchmove', () => { clearTimeout(pressTimer); div.classList.remove('scale-active'); });

                            div.innerHTML = `
                                <div class="avatar-container" onclick="event.stopPropagation(); setupProfileInteraction(this, '${lightboxUrl}', false, '${contact.uid}')">
                                    <div class="avatar">${avatarHtml}</div>
                                    ${vipBadgeHtml}
                                    <div id="status-${contact.uid}" class="status-dot"></div>
                                </div>
                                <div class="chat-info">
                                    <h3>${contact.name} <span id="last-time-${contact.uid}" class="last-active-txt"></span></h3>
                                    <p id="last-msg-${contact.uid}">...</p>
                                </div>
                            `;
                            
                            // Listen to last message
                            const chatId = [currentUser.uid, contact.uid].sort().join('_');
                            const q = query(ref(db, `private-messages/${chatId}`), limitToLast(1));
                            onValue(q, (snap) => {
                                const data = snap.val();
                                const lastMsgEl = document.getElementById(`last-msg-${contact.uid}`);
                                if(data) {
                                    const msg = Object.values(data)[0];
                                    let txt = msg.text;
                                    
                                    // Custom preview for Voice/Audio
                                    if(msg.type === 'audio') {
                                        // UPDATED LOGIC: Green Mic if unplayed
                                        const isUnplayed = (msg.uid !== currentUser.uid && !msg.audioPlayed);
                                        const iconColor = isUnplayed ? '#00e676' : 'var(--gray)';
                                        const textColor = isUnplayed ? '#000' : '#555';
                                        const fontWeight = isUnplayed ? '900' : '500';
                                        
                                        lastMsgEl.innerHTML = `<span style="display:flex; align-items:center; gap:4px; color:${textColor}; font-weight:${fontWeight};"><i class="fa-solid fa-microphone" style="font-size:12px; color:${iconColor};"></i> Voice</span>`;
                                    } else if (msg.type === 'sticker') {
                                        lastMsgEl.innerText = "Sticker";
                                    } else if (msg.type === 'image') {
                                        lastMsgEl.innerHTML = `<span style="display:flex; align-items:center; gap:5px; color:#555; font-weight:500;"><i class="fa-regular fa-image" style="font-size:13px;"></i> Photo</span>`;
                                    } else {
                                        if(msg.type !== 'text') txt = `[${msg.type}]`;
                                        if(lastMsgEl) lastMsgEl.innerText = txt;
                                    }
                                } else {
                                    if(lastMsgEl) lastMsgEl.innerText = "Start conversation";
                                }
                            });

                            // Status listener logic
                            onValue(ref(db, `status/${contact.uid}`), (snap) => {
                                const status = snap.val();
                                const dot = document.getElementById(`status-${contact.uid}`);
                                const timeTxt = document.getElementById(`last-time-${contact.uid}`);
                                if(dot && status) {
                                    if(status.state === 'online') { 
                                        dot.classList.remove('offline'); dot.classList.add('online'); 
                                        timeTxt.innerText = "Active"; timeTxt.style.color = "var(--green)";
                                    } else { 
                                        dot.classList.remove('online'); dot.classList.add('offline'); 
                                        timeTxt.innerText = ""; 
                                    }
                                }
                            });

                        } else {
                            // GROUP (Private Channel)
                            const channel = item.data;
                            const channelId = item.id;
                            
                            let iconContent;
                            if(channel.icon === 'custom' && channel.customIcon) {
                                iconContent = `<img src="${channel.customIcon}" style="width:100%; height:100%; object-fit:cover;">`;
                            } else {
                                iconContent = `<i class="fa-solid ${channel.icon || 'fa-users'}"></i>`;
                            }

                            div.onclick = () => openChat(channelId, channel.name, false, true);

                            // GROUP LONG PRESS LOGIC
                            let pressTimer;
                            let isLongPress = false;
                            div.addEventListener('touchstart', (e) => {
                                if(e.target.closest('.avatar-container')) return;
                                isLongPress = false;
                                div.classList.add('scale-active');
                                pressTimer = setTimeout(() => {
                                    isLongPress = true;
                                    openGroupOptions(channelId, channel.name);
                                    if(navigator.vibrate) navigator.vibrate(50);
                                }, 600);
                            }, {passive: false});
                            div.addEventListener('touchend', () => { clearTimeout(pressTimer); div.classList.remove('scale-active'); });
                            div.addEventListener('touchmove', () => { clearTimeout(pressTimer); div.classList.remove('scale-active'); });

                            div.innerHTML = `
                                <div class="avatar-container">
                                    <div class="avatar">${iconContent}</div>
                                </div>
                                <div class="chat-info">
                                    <h3>${channel.name}</h3>
                                    <p id="last-msg-grp-${channelId}">Group Chat</p>
                                </div>
                            `;

                            // Listen to group last message
                            const q = query(ref(db, `channel-messages/${channelId}`), limitToLast(1));
                            onValue(q, (snap) => {
                                const data = snap.val();
                                const lastMsgEl = document.getElementById(`last-msg-grp-${channelId}`);
                                if(data) {
                                    const msg = Object.values(data)[0];
                                    
                                    if(msg.type === 'audio') {
                                        // UPDATED LOGIC: Green Mic if unplayed
                                        const isUnplayed = (msg.uid !== currentUser.uid && !msg.audioPlayed);
                                        const iconColor = isUnplayed ? '#00e676' : 'var(--gray)';
                                        const fontWeight = isUnplayed ? '900' : '500';
                                        const senderBold = isUnplayed ? 'color:black;' : '';

                                        lastMsgEl.innerHTML = `<span style="display:flex; align-items:center; gap:4px; color:#555; font-weight:${fontWeight};"><b style="${senderBold}">${msg.sender}:</b> <i class="fa-solid fa-microphone" style="font-size:12px; color:${iconColor};"></i> Voice</span>`;
                                    } else if (msg.type === 'sticker') {
                                        lastMsgEl.innerText = `${msg.sender}: Sticker`;
                                    } else if (msg.type === 'image') {
                                        lastMsgEl.innerHTML = `<span style="display:flex; align-items:center; gap:5px; color:#555; font-weight:500;"><b>${msg.sender}:</b> <i class="fa-regular fa-image" style="font-size:13px;"></i> Photo</span>`;
                                    } else {
                                        let txt = msg.sender + ": " + (msg.type !== 'text' ? `[${msg.type}]` : msg.text);
                                        if(lastMsgEl) lastMsgEl.innerText = txt.length > 25 ? txt.substring(0,25)+'...' : txt;
                                    }
                                }
                            });
                        }

                        privateChatList.appendChild(div);
                    });
                });
            });
        }

        // --- SCROLL LOGIC ---
        const msgsDiv = document.getElementById('chat-messages');
        msgsDiv.addEventListener('scroll', () => {
            if (msgsDiv.scrollTop + msgsDiv.clientHeight >= msgsDiv.scrollHeight - 50) {
                unreadScrollCount = 0;
                scrollBtn.classList.remove('show');
            }
        });

        window.instantScrollToBottom = () => {
            msgsDiv.scrollTop = msgsDiv.scrollHeight;
            unreadScrollCount = 0;
            scrollBtn.classList.remove('show');
        };

        window.smoothScrollToBottom = () => {
            msgsDiv.scrollTo({ top: msgsDiv.scrollHeight, behavior: 'smooth' });
            unreadScrollCount = 0;
            scrollBtn.classList.remove('show');
        };

        // --- CHAT LOGIC ---
        let chatPath = '';
        let unsubscribeChatAdd = null;
        let unsubscribeChatChange = null;
        let unsubscribeChatRemove = null;
        
        window.openChat = async (id, name, isPrivate, isChannel = false) => {
            currentChatUserUid = id;
            isChannelChat = isChannel; 
            
            // Fix for Back Button Navigation
            if (isChannel && channelScreen.classList.contains('active')) {
                returnToPage = 'channel';
            } else {
                returnToPage = 'home';
            }
            
            history.pushState({page: 'chat', id: id}, name, '#chat');

            let displayName = name;
            if(displayName.length > 15) displayName = displayName.substring(0, 15) + "..";
            document.getElementById('chat-room-name').innerText = displayName;
            
            chatRoomStatus.innerText = "Connecting...";
            if(unsubscribeHeaderStatus) { unsubscribeHeaderStatus(); unsubscribeHeaderStatus = null; }

            chatFooter.style.display = 'flex'; 
            callButtons.style.display = 'flex';
            telegramJoinBar.style.display = 'none'; 
            
            if(id === 'admin') {
                document.getElementById('admin-msg-dot').classList.remove('active');
            }

            const headerIcon = document.getElementById('chat-header-icon');
            const headerClickArea = document.getElementById('chat-header-clickable');
            
            headerIcon.innerHTML = '<i class="fa-solid fa-user-ninja"></i>';
            headerClickArea.onclick = null; 
            
            activeChatAvatarHTML = '<i class="fa-solid fa-user-ninja"></i>'; 

            if(isPrivate) {
                get(ref(db, `users/${id}`)).then(snap => {
                    const uData = snap.val();
                    if(uData) {
                         const isVip = uData.isVip || false;
                         
                         if(uData.icon === 'custom' && uData.customAvatar) {
                             const imgHTML = `<img src="${uData.customAvatar}" class="custom-user-img">`;
                             headerIcon.innerHTML = imgHTML;
                             activeChatAvatarHTML = imgHTML; 
                         } else {
                             const icon = uData.icon || 'fa-user-ninja';
                             const vipClass = isVip ? 'vip-gold-icon' : '';
                             const iHTML = `<i class="fa-solid ${icon} ${vipClass}"></i>`;
                             headerIcon.innerHTML = iHTML;
                             activeChatAvatarHTML = iHTML; 
                         }
                         
                         // Update chat bubbles too
                         document.querySelectorAll('.msg-row-avatar').forEach(el => {
                             el.innerHTML = activeChatAvatarHTML;
                             el.onclick = (e) => {
                                e.stopPropagation();
                                let src = "";
                                let isIcon = false;
                                if(activeChatAvatarHTML.includes('<img')) {
                                    const match = activeChatAvatarHTML.match(/src="([^"]*)"/);
                                    if(match) src = match[1];
                                } else {
                                    const match = activeChatAvatarHTML.match(/class="fa-solid ([^"]*)"/);
                                    if(match) { src = match[1]; isIcon = true; }
                                }
                                if(src) openLightbox(src, false, isIcon);
                             };
                         });
                    }
                });

                // --- HEADER SPLIT ACTIONS (INSTA STYLE) ---
                // 1. Icon Click -> View Profile
                headerIcon.onclick = (e) => {
                    e.stopPropagation();
                    viewUserProfile(id, name, 'Contact');
                };

                // 2. Name Click -> Chat Info
                headerClickArea.onclick = () => openChatDetails();

                unsubscribeHeaderStatus = onValue(ref(db, `status/${id}`), (snap) => {
                    const data = snap.val();
                    const typingRef = ref(db, `typing_status/${[currentUser.uid, id].sort().join('_')}/${id}`);
                    get(typingRef).then((tSnap) => {
                        if(tSnap.val() === 'typing' || tSnap.val() === true) { chatRoomStatus.innerText = "Typing..."; chatRoomStatus.style.color = "var(--accent)"; } 
                        else if (tSnap.val() === 'recording') { chatRoomStatus.innerText = "Recording..."; chatRoomStatus.style.color = "var(--accent)"; }
                        else {
                             if(data && data.state === 'online') { chatRoomStatus.innerText = "Online"; chatRoomStatus.style.color = "var(--green)"; } 
                             else if (data && data.last_changed) { chatRoomStatus.innerText = "Last seen " + timeAgo(data.last_changed); chatRoomStatus.style.color = "#888"; } 
                             else { chatRoomStatus.innerText = "Offline"; chatRoomStatus.style.color = "#888"; }
                        }
                    });
                });
            } else { 
                chatRoomStatus.innerText = isChannel ? "Group" : "Official Channel"; 
                chatRoomStatus.style.color = "#888"; 
                callButtons.style.display = 'none';

                if(isChannel) {
                    currentChannelId = id;
                    
                    get(ref(db, `channels/${id}`)).then(snap => {
                        const cData = snap.val();
                        if(cData) {
                             if (cData.customIcon) {
                                 headerIcon.innerHTML = `<img src="${cData.customIcon}" style="width:100%;height:100%;object-fit:cover;">`;
                             } else {
                                 headerIcon.innerHTML = `<i class="fa-solid ${cData.icon}"></i>`;
                             }
                        }
                    });

                    // Groups: Both click open details
                    headerIcon.onclick = () => openChatDetails();
                    headerClickArea.onclick = () => openChatDetails();

                    const chanRef = ref(db, `channels/${id}`);
                    const chanSnap = await get(chanRef);
                    const chanData = chanSnap.val();
                    const myUid = currentUser.uid;

                    if(chanData) {
                        const isOwner = chanData.creatorId === myUid;
                        const isLeader = (chanData.activeLeader === myUid) || 
                                        (chanData.members && chanData.members[myUid] && chanData.members[myUid].role === 'Leader');
                        const isMember = chanData.members && chanData.members[myUid];
                        const isPending = chanData.requests && chanData.requests[myUid];

                        if (isOwner || isLeader) {
                            chatFooter.style.display = 'flex';
                            telegramJoinBar.style.display = 'none';
                        } else if (isMember) {
                            chatFooter.style.display = 'flex';
                            telegramJoinBar.style.display = 'none';
                        } else {
                            chatFooter.style.display = 'none';
                            telegramJoinBar.style.display = 'flex';
                            
                            if (isPending) {
                                telegramJoinBar.innerHTML = `<button class="btn-tg-join pending">JOIN PENDING...</button>`;
                            } else {
                                const btnText = chanData.autoJoin ? "JOIN CHANNEL" : "REQUEST TO JOIN";
                                telegramJoinBar.innerHTML = `<button class="btn-tg-join" onclick="handleTelegramJoin('${id}', ${chanData.autoJoin})">${btnText}</button>`;
                            }
                        }
                    }
                } else {
                    headerIcon.innerHTML = `<i class="fa-solid fa-user-secret"></i>`;
                }
            }

            msgsDiv.innerHTML = `
                <div class="chat-skeleton-container">
                    <div class="skeleton sk-msg left"></div>
                    <div class="skeleton sk-msg right"></div>
                    <div class="skeleton sk-msg left"></div>
                    <div class="skeleton sk-msg right"></div>
                    <div class="skeleton sk-msg left"></div>
                </div>`;
            
            cancelReply();
            homeScreen.classList.remove('active'); 
            channelScreen.classList.remove('active');
            chatScreen.classList.add('active');
            profileScreen.classList.remove('active');
            mainNav.classList.remove('visible');

            isAdminChat = (id === 'admin');
            if(isAdminChat) { callButtons.style.display = 'none'; msgsDiv.classList.add('admin-bg'); chatNavbar.classList.add('gold-header'); } 
            else { msgsDiv.classList.remove('admin-bg'); chatNavbar.classList.remove('gold-header'); }

            if (isPrivate) {
                const chatId = [currentUser.uid, id].sort().join('_');
                currentChatIdString = chatId;
                chatPath = `private-messages/${chatId}`;
                const typingRef = ref(db, `typing_status/${chatId}/${id}`);
                
                unsubscribeTyping = onValue(typingRef, (snap) => {
                   const status = snap.val();
                   const box = document.getElementById('typing-indicator-box');
                   
                    if(status === 'typing' || status === true) { 
                       box.style.display = 'flex';
                       box.innerHTML = `
                           <div class="typing-dots">
                               <div class="t-dot"></div><div class="t-dot"></div><div class="t-dot"></div>
                           </div>`;
                       chatRoomStatus.innerText = "Typing..."; chatRoomStatus.style.color = "var(--accent)";
                       audioTyping.play().catch(e => {});
                   } else if (status === 'recording') {
                       box.style.display = 'flex';
                       box.innerHTML = `
                           <div class="recording-wave">
                               <div class="r-bar"></div><div class="r-bar"></div><div class="r-bar"></div><div class="r-bar"></div><div class="r-bar"></div>
                           </div>
                           <div class="indicator-text">RECORDING...</div>`;
                       chatRoomStatus.innerText = "Recording..."; chatRoomStatus.style.color = "var(--accent)";
                       audioTyping.pause(); audioTyping.currentTime = 0;
                   } else {
                       box.style.display = 'none';
                       get(ref(db, `status/${id}`)).then((sSnap) => {
                           const sData = sSnap.val();
                           if(sData && sData.state === 'online') { chatRoomStatus.innerText = "Online"; chatRoomStatus.style.color = "var(--green)"; }
                           else if (sData && sData.last_changed) { chatRoomStatus.innerText = "Last seen " + timeAgo(sData.last_changed); chatRoomStatus.style.color = "#888"; }
                           else { chatRoomStatus.innerText = "Offline"; chatRoomStatus.style.color = "#888"; }
                       });
                       audioTyping.pause(); audioTyping.currentTime = 0;
                   }
                });
            } else if (isChannel) {
                chatPath = `channel-messages/${id}`;
                document.getElementById('typing-indicator-box').style.display = 'none';
                currentChatIdString = null;
            } else {
                chatPath = `rooms/${id}/messages`;
                document.getElementById('typing-indicator-box').style.display = 'none';
                currentChatIdString = null;
            }

            // --- APPLY PER-CHAT WALLPAPER HERE ---
            applyChatBackground(currentChatIdString || currentChannelId);

            const q = query(ref(db, chatPath), limitToLast(50));
            chatOpenTimestamp = Date.now();
            msgsDiv.innerHTML = ''; 
            lastRenderedDate = null; 

            const input = document.getElementById('msg-input');
            if(currentChatIdString && chatDrafts[currentChatIdString]) {
                input.value = chatDrafts[currentChatIdString];
                input.dispatchEvent(new Event('input'));
            } else {
                input.value = '';
                micBtn.style.display = 'flex';
                sendBtn.style.display = 'none';
            }
            
            unsubscribeChatAdd = onChildAdded(q, (snapshot) => {
                const msg = snapshot.val();
                msg.key = snapshot.key;

                if (msg.deletedBy && msg.deletedBy[currentUser.uid]) return;

                if(isPrivate && msg.uid !== currentUser.uid && msg.status !== 'sent') {
                     // If needed: update(ref(db, `${chatPath}/${msg.key}`), { status: 'seen' });
                }

                const msgDateLabel = formatDateLabel(msg.timestamp);
                if (msgDateLabel !== lastRenderedDate) {
                    const dateDiv = document.createElement('div');
                    dateDiv.className = 'date-separator';
                    dateDiv.innerText = msgDateLabel;
                    msgsDiv.appendChild(dateDiv);
                    lastRenderedDate = msgDateLabel;
                }

                renderMessage(msg);

                if (msg.timestamp > chatOpenTimestamp && msg.uid !== currentUser.uid) {
                    audioTung.play().catch(e => {}); 
                    if(speechEnabled) {
                        const utterance = new SpeechSynthesisUtterance(msg.text);
                        window.speechSynthesis.speak(utterance);
                    }
                }

                const isInitialLoad = (Date.now() - msg.timestamp) > 2000; 
                if (isInitialLoad) {
                    instantScrollToBottom();
                } else {
                    smoothScrollToBottom();
                }
            });

            unsubscribeChatChange = onChildChanged(q, (snapshot) => {
                const msg = snapshot.val();
                const key = snapshot.key;
                
                if (msg.deletedBy && msg.deletedBy[currentUser.uid]) {
                    const container = document.getElementById(`bubble-${key}`)?.closest('.msg-container');
                    if(container) container.remove();
                    return;
                }

                const existingBubble = document.getElementById(`bubble-${key}`);
                if (existingBubble) {
                    if(msg.uid === currentUser.uid) {
                        const meta = existingBubble.querySelector('.msg-meta');
                        if(meta) {
                            const oldTick = meta.querySelector('.tick-icon');
                            if(oldTick) oldTick.remove();
                            meta.insertAdjacentHTML('beforeend', getTickHtml(msg.status || 'sent'));
                        }
                    }
                    
                    const reactionDiv = document.getElementById(`react-${key}`);
                    if (reactionDiv) {
                        if (msg.reactions) {
                            let reactionHtml = '';
                            const counts = {};
                            Object.values(msg.reactions).forEach(emoji => { counts[emoji] = (counts[emoji] || 0) + 1; });
                            Object.entries(counts).forEach(([emoji, count]) => { 
                                reactionHtml += `<div class="reaction-badge">${emoji} ${count > 1 ? count : ''}</div>`; 
                            });
                            reactionDiv.innerHTML = reactionHtml;
                            reactionDiv.style.display = 'flex';
                        } else {
                            reactionDiv.innerHTML = '';
                            reactionDiv.style.display = 'none';
                        }
                    }
                }
            });

            unsubscribeChatRemove = onChildRemoved(q, (snapshot) => {
                const key = snapshot.key;
                const container = document.getElementById(`bubble-${key}`)?.closest('.msg-container');
                if(container) {
                    container.style.transition = 'opacity 0.3s, height 0.3s';
                    container.style.opacity = '0';
                    container.style.height = '0';
                    setTimeout(() => container.remove(), 300);
                }
            });
        };

        window.closeChat = () => { 
            if(!isSystemBack && history.state && history.state.page === 'chat') { history.back(); return; }

            const input = document.getElementById('msg-input');
            if(currentChatIdString && input.value.trim()) {
                chatDrafts[currentChatIdString] = input.value.trim();
            } else if(currentChatIdString) {
                delete chatDrafts[currentChatIdString];
            }

            if(unsubscribeChatAdd) { unsubscribeChatAdd(); unsubscribeChatAdd = null; }
            if(unsubscribeChatChange) { unsubscribeChatChange(); unsubscribeChatChange = null; }
            if(unsubscribeChatRemove) { unsubscribeChatRemove(); unsubscribeChatRemove = null; }
            
            if(unsubscribeTyping) { unsubscribeTyping(); unsubscribeTyping = null; }
            if(unsubscribeHeaderStatus) { unsubscribeHeaderStatus(); unsubscribeHeaderStatus = null; }
            
            audioTyping.pause();
            audioTyping.currentTime = 0;

            chatScreen.classList.remove('active'); 
            
            if(returnToPage === 'channel') {
                channelScreen.classList.add('active');
                document.getElementById('nav-channel').classList.add('active-nav');
                document.getElementById('nav-home').classList.remove('active-nav');
            } else {
                homeScreen.classList.add('active'); 
                document.getElementById('nav-home').classList.add('active-nav');
                document.getElementById('nav-channel').classList.remove('active-nav');
            }
            
            mainNav.classList.add('visible'); 
            chatNavbar.classList.remove('gold-header'); 
            currentChatUserUid = null; 
            currentChatIdString = null;
            isChannelChat = false;
            currentChannelId = null;
            scrollBtn.classList.remove('show');
            unreadScrollCount = 0;
            chatFooter.style.display = 'flex';
            telegramJoinBar.style.display = 'none';
            document.getElementById('typing-indicator-box').style.display = 'none';
            closeSelectionMode();
            const menu = document.getElementById('attachment-menu');
            if(menu) menu.classList.remove('open');
            stickerPicker.classList.remove('open'); // Close Sticker Picker
            document.getElementById('speech-settings-menu').classList.remove('show');
        };

        msgInput.addEventListener('input', function() {
            // Auto-resize logic
            this.style.height = 'auto'; 
            this.style.height = (this.scrollHeight) + 'px'; 

            if(!currentChatIdString || isAdminChat || isChannelChat) return;
            
            const value = this.value.trim();
            const speechBtn = document.querySelector('.admin-speech-btn');
            
            if(value.length > 0) {
                micBtn.style.display = 'none';
                sendBtn.style.display = 'flex';
                // Hide speech button when typing
                if(speechBtn) speechBtn.style.display = 'none';
            } else {
                micBtn.style.display = 'flex';
                sendBtn.style.display = 'none';
                // Show speech button when empty
                if(speechBtn) speechBtn.style.display = 'flex';
            }

            if(typingTimeout) clearTimeout(typingTimeout);
            set(ref(db, `typing_status/${currentChatIdString}/${currentUser.uid}`), 'typing');
            typingTimeout = setTimeout(() => {
                set(ref(db, `typing_status/${currentChatIdString}/${currentUser.uid}`), false);
            }, 1000);
        });

        document.getElementById('msg-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if(isSendingMessage) return; 
            isSendingMessage = true;
            if(sendBtn) sendBtn.style.opacity = '0.5';

            if(currentMediaType === 'image' && currentImageBase64) {
                await sendMessage(null, 'image', currentImageBase64);
            } else if (currentMediaType === 'video' && currentVideoBase64) {
                await sendMessage(null, 'video', currentVideoBase64);
            } else {
                const input = document.getElementById('msg-input');
                if(input.value.trim()) {
                    await sendMessage(input.value, 'text');
                    input.value = '';
                    input.style.height = '38px'; // Reset height
                    micBtn.style.display = 'flex';
                    sendBtn.style.display = 'none';
                    // Show speech button again
                    const speechBtn = document.querySelector('.admin-speech-btn');
                    if(speechBtn) speechBtn.style.display = 'flex';
                    if(currentChatIdString) delete chatDrafts[currentChatIdString];
                }
            }

            setTimeout(() => {
                isSendingMessage = false;
                if(sendBtn) sendBtn.style.opacity = '1';
            }, 500);
        });

        async function sendMessage(content, type = 'text', mediaBase64 = null, fileSize = null) {
            if(currentChatIdString) set(ref(db, `typing_status/${currentChatIdString}/${currentUser.uid}`), false);

            let initialStatus = 'sent';
            if(!isAdminChat && !isChannelChat) {
                const statusSnap = await get(ref(db, `status/${currentChatUserUid}`));
                if(statusSnap.exists() && statusSnap.val().state === 'online') {
                    initialStatus = 'delivered';
                }
            }

            const msgData = { 
                text: type === 'text' || type === 'sticker' ? content : (type === 'image' ? 'Image' : (type === 'video' ? 'Video' : (type === 'location' ? 'Location' : (type === 'contact' ? 'Contact' : 'Document')))), 
                type: type,
                sender: currentUser.displayName, 
                uid: currentUser.uid, 
                timestamp: Date.now(), 
                status: initialStatus 
            };
            
            // --- NEW: WHATSAPP STYLE FAKE SPINNER FOR MEDIA ---
            let tempMsgId = null;
            if (type === 'image' || type === 'video') {
                tempMsgId = `temp-${Date.now()}`;
                const sizeDisplay = currentVideoSize || (fileSize ? formatBytes(fileSize) : "2.5 MB"); 
                renderTempUploadBubble(tempMsgId, type, mediaBase64, sizeDisplay);
                smoothScrollToBottom();
            }

            if(type === 'audio') {
                msgData.audio = mediaBase64;
                msgData.duration = currentVideoDuration || '0:00'; 
            }
            if(type === 'image') msgData.image = mediaBase64;
            if(type === 'video') {
                 msgData.video = mediaBase64;
                 msgData.duration = currentVideoDuration || '0:00';
                 msgData.fileSize = currentVideoSize || '0 MB';
            }
            if(type === 'document') {
                msgData.docUrl = mediaBase64; 
                msgData.fileName = content; 
                msgData.fileSize = formatBytes(fileSize);
            }

            if(replyingToMsg && !isAdminChat) msgData.replyTo = { text: replyingToMsg.text, sender: replyingToMsg.sender };
            
            // Artificial Delay to simulate upload and show spinner
            if(tempMsgId) await new Promise(r => setTimeout(r, 1500));

            await push(ref(db, chatPath), msgData);
            
            // Remove Temp Bubble
            if(tempMsgId) {
                const el = document.getElementById(tempMsgId);
                if(el) el.remove();
            }

            cancelReply();
            if(type === 'image' || type === 'video' || type === 'document') cancelPhoto();
        }

        // --- NEW FUNCTION: RENDER TEMP SPINNER BUBBLE ---
        function renderTempUploadBubble(tempId, type, base64, sizeTxt) {
            const container = document.createElement('div');
            container.className = 'msg-container me';
            container.id = tempId;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'msg-content-wrapper';
            
            let contentHtml = '';
            if(type === 'image') {
                contentHtml = `
                <div style="position:relative; width:fit-content; border-radius:10px; overflow:hidden; margin-top:5px;">
                    <img src="${base64}" class="msg-img" style="opacity:0.5; margin:0;">
                    <div class="msg-upload-overlay">
                        <div class="msg-upload-spinner"></div>
                        <div class="msg-upload-size">${sizeTxt}</div>
                    </div>
                </div>`;
            } else {
                contentHtml = `
                <div style="position:relative; width:fit-content; border-radius:10px; overflow:hidden; margin-top:5px; background:black;">
                    <video src="${base64}#t=0.1" class="msg-video-thumb" style="opacity:0.5; margin:0;"></video>
                    <div class="msg-upload-overlay">
                        <div class="msg-upload-spinner"></div>
                        <div class="msg-upload-size">${sizeTxt}</div>
                    </div>
                </div>`;
            }

            wrapper.innerHTML = `<div class="msg" style="background:var(--msg-me); color:white; border-radius:12px 0 12px 12px;">${contentHtml}</div>`;
            container.appendChild(wrapper);
            document.getElementById('chat-messages').appendChild(container);
        }

        window.cancelReply = () => { replyingToMsg = null; document.getElementById('reply-bar').classList.remove('show'); };

        function getTickHtml(status) {
            if(status === 'sent') return `<i class="fa-solid fa-check tick-icon"></i>`;
            if(status === 'delivered') return `<i class="fa-solid fa-check-double tick-icon"></i>`;
            if(status === 'seen') return `<i class="fa-solid fa-check-double tick-icon blue"></i>`;
            return `<i class="fa-solid fa-check tick-icon"></i>`;
        }

        function linkify(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, function(url) {
                return `<a href="${url}" target="_blank">${url}</a>`;
            });
        }
        
        function escapeHtml(text) {
            return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;") : text;
        }

        function renderMessage(msg) {
            const container = document.createElement('div');
            const isMe = msg.uid === currentUser.uid;
            
            let animClass = '';
            if (!isMe && msg.timestamp > chatOpenTimestamp) {
                animClass = ' anim-bounce-up';
            }

            const audioClass = (msg.type === 'audio') ? ' audio-msg' : '';
            container.className = `msg-container ${isMe ? 'me' : 'other'}${animClass}${audioClass}`;
            
            if (!isMe && msg.type !== 'audio') {
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'msg-row-avatar';
                avatarDiv.innerHTML = activeChatAvatarHTML; 
                
                avatarDiv.onclick = (e) => {
                    e.stopPropagation();
                    let src = "";
                    let isIcon = false;
                    if(activeChatAvatarHTML.includes('<img')) {
                        const match = activeChatAvatarHTML.match(/src="([^"]*)"/);
                        if(match) src = match[1];
                    } else {
                        const match = activeChatAvatarHTML.match(/class="fa-solid ([^"]*)"/);
                        if(match) {
                            src = match[1];
                            isIcon = true;
                        }
                    }
                    if(src) openLightbox(src, false, isIcon);
                };
                
                container.appendChild(avatarDiv);
            }

            const swipeIcon = document.createElement('i');
            swipeIcon.className = `fa-solid fa-reply swipe-reply-icon ${isMe ? 'left' : 'right'}`;
            container.appendChild(swipeIcon);

            const wrapper = document.createElement('div');
            wrapper.className = 'msg-content-wrapper';
            
            // NOTE: Do not escape HTML if type is sticker, because sticker content is SVG string
            const safeText = msg.type === 'sticker' ? msg.text : escapeHtml(msg.text);
            let messageContent = '';
            
            if(msg.type === 'audio') {
                const audioId = `audio-${msg.key}`;
                let waveformHtml = '';
                const barCount = 20; 
                for(let i=0; i<barCount; i++) {
                    const height = Math.floor(Math.random() * 80) + 20;
                    waveformHtml += `<div class="wave-bar" style="height:${height}%"></div>`;
                }
                
                let bubbleAvatar = '';
                let avSrc = "";
                let avIsIcon = false;

                if(isMe) {
                    if(myAvatarHTML.includes('<img')) {
                        const match = myAvatarHTML.match(/src="([^"]*)"/);
                        if(match) avSrc = match[1];
                    } else {
                        const match = myAvatarHTML.match(/class="fa-solid ([^"]*)"/);
                        if(match) { avSrc = match[1]; avIsIcon = true; }
                    }
                    bubbleAvatar = `<div class="voice-dp" onclick="event.stopPropagation(); openLightbox('${avSrc}', false, ${avIsIcon})">${myAvatarHTML || '<i class="fa-solid fa-user-ninja"></i>'}</div>`;
                } else {
                    if(activeChatAvatarHTML.includes('<img')) {
                        const match = activeChatAvatarHTML.match(/src="([^"]*)"/);
                        if(match) avSrc = match[1];
                    } else {
                        const match = activeChatAvatarHTML.match(/class="fa-solid ([^"]*)"/);
                        if(match) { avSrc = match[1]; avIsIcon = true; }
                    }
                    bubbleAvatar = `<div class="voice-dp" onclick="event.stopPropagation(); openLightbox('${avSrc}', false, ${avIsIcon})">${activeChatAvatarHTML || '<i class="fa-solid fa-user-secret"></i>'}</div>`;
                }

                let unplayedClass = "";
                if(!isMe && !msg.audioPlayed) {
                    unplayedClass = " unplayed";
                }

                messageContent = `
                <div class="voice-player${unplayedClass}">
                    ${bubbleAvatar}
                    <div class="voice-controls-wrap">
                        <div class="voice-play-btn" onclick="event.stopPropagation(); toggleAudio('${audioId}', this, '${msg.key}')">
                            <i class="fa-solid fa-play"></i>
                        </div>
                        <div class="wave-container" id="wave-${audioId}">
                            ${waveformHtml}
                            <div class="voice-progress-dot"></div>
                        </div>
                        <div class="voice-time" id="vtime-${audioId}">${msg.duration || '0:00'}</div>
                    </div>
                    <audio id="${audioId}" src="${msg.audio}" onloadedmetadata="setVoiceDuration(this, 'vtime-${audioId}')" ontimeupdate="updateWaveform('${audioId}')" onended="resetVoiceBtn('${audioId}', this)"></audio>
                </div>`;
            } else if (msg.type === 'image') {
                messageContent = `<img src="${msg.image}" class="msg-img" onclick="event.stopPropagation(); openLightbox(this.src)">`;
            } else if (msg.type === 'video') {
                const duration = msg.duration || '0:00';
                const size = msg.fileSize || '';
                messageContent = `
                <div class="video-wrapper" onclick="event.stopPropagation(); openLightbox('${msg.video}', true)">
                    <video preload="metadata" src="${msg.video}#t=0.1" class="msg-video-thumb"></video>
                    <div class="play-overlay"><i class="fa-solid fa-play"></i></div>
                    <div class="video-meta-info">
                        <span><i class="fa-solid fa-video"></i> ${size}</span>
                        <span>${duration}</span>
                    </div>
                </div>`;
            } else if (msg.type === 'document') {
                const fname = msg.fileName || 'Document';
                const fsize = msg.fileSize || '';
                messageContent = `
                <div class="doc-bubble" onclick="event.stopPropagation(); openDoc('${msg.docUrl}')">
                    <div class="doc-icon"><i class="fa-solid fa-file-lines"></i></div>
                    <div class="doc-info">
                        <span class="doc-name">${fname}</span>
                        <span class="doc-size">${fsize}  PDF/DOC</span>
                    </div>
                    <i class="fa-solid fa-download" style="color:#888;"></i>
                </div>`;
            } else if (msg.type === 'location') {
                const mapUrl = `https://maps.google.com/maps?q=${msg.text}&z=15&output=embed`;
                messageContent = `
                <div class="msg-map-frame">
                    <iframe src="${mapUrl}" allowfullscreen></iframe>
                </div>
                <div style="font-size:11px; margin-top:5px; font-weight:bold; color:var(--link-blue); cursor:pointer;" onclick="openMap('https://www.google.com/maps?q=${msg.text}')">
                    <i class="fa-solid fa-arrow-up-right-from-square"></i> Open in Maps
                </div>`;
            } else if (msg.type === 'contact') {
                let contactData = {name: 'Unknown', tel: ''};
                try { contactData = JSON.parse(msg.text); } catch(e) {}
                
                messageContent = `
                <div class="msg-contact-bubble" onclick="window.open('sms:${contactData.tel}')">
                    <div class="cc-icon"><i class="fa-solid fa-user"></i></div>
                    <div class="cc-info">
                        <div class="cc-name">${contactData.name}</div>
                        <div class="cc-num">${contactData.tel}</div>
                        <div class="cc-action">Message <i class="fa-regular fa-comment-dots"></i></div>
                    </div>
                </div>`;
            } else if (msg.type === 'sticker') {
                // RENDER STICKER (SVG) LARGE & TRANSPARENT
                messageContent = `
                <div style="width:140px; height:140px; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));">
                    ${msg.text} 
                </div>`;
            } else {
                messageContent = linkify(safeText);
            }
            
            let replyHtml = msg.replyTo ? `<div class="reply-quote"><b>${escapeHtml(msg.replyTo.sender)}</b>: ${escapeHtml(msg.replyTo.text)}</div>` : '';
            const timeStr = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let reactionHtml = '';
            let reactionClass = 'reaction-container';
            if (msg.reactions) {
                const counts = {};
                Object.values(msg.reactions).forEach(emoji => { counts[emoji] = (counts[emoji] || 0) + 1; });
                Object.entries(counts).forEach(([emoji, count]) => { 
                    reactionHtml += `<div class="reaction-badge">${emoji} ${count > 1 ? count : ''}</div>`; 
                });
            }

            const vipClass = isAdminChat ? ' msg-vip' : '';
            const stickerClass = msg.type === 'sticker' ? ' sticker-msg' : '';
            const ticks = isMe ? getTickHtml(msg.status || 'sent') : '';

            // Apply sticker-msg class to remove background bubble if sticker
            // Added ID for Drag Select
            wrapper.innerHTML = `<div class="msg${vipClass}${stickerClass}" id="bubble-${msg.key}">${replyHtml}${messageContent}<div class="msg-meta"><span class="msg-time">${timeStr}</span>${ticks}</div></div>`;
            
            const reactionDiv = document.createElement('div');
            reactionDiv.className = reactionClass;
            reactionDiv.id = `react-${msg.key}`;
            reactionDiv.innerHTML = reactionHtml;
            
            if(!reactionHtml) reactionDiv.style.display = 'none';

            container.appendChild(wrapper);
            wrapper.appendChild(reactionDiv);

            msgsDiv.appendChild(container);
            
            let startX = 0; let startY = 0; let currentX = 0;
            let longPressTimer;
            let isLongPress = false;

            container.addEventListener('touchstart', (e) => { 
                isLongPress = false;
                startX = e.touches[0].clientX; 
                startY = e.touches[0].clientY;
                currentX = startX; 
                wrapper.style.transition = 'none';
                
                if (isSelectionMode) {
                    // In selection mode, just tap toggle handled in touchend
                } else {
                    container.classList.add('scale-active'); 
                    longPressTimer = setTimeout(() => {
                         isLongPress = true;
                         toggleSelection(msg); 
                         // Only show reactions if it's the FIRST selection start
                         if(selectedMessages.length === 1) showReactionBar(msg, wrapper); 
                         if(navigator.vibrate) navigator.vibrate(50);
                    }, 500); 
                }
            }, {passive: false});

            container.addEventListener('touchmove', (e) => { 
                // CRITICAL FIX: If user scrolls vertical more than 10px, CANCEL selection intent
                if(Math.abs(e.touches[0].clientY - startY) > 10) {
                     clearTimeout(longPressTimer);
                     container.classList.remove('scale-active');
                     isLongPress = false;
                     return;
                }

                if (isSelectionMode || isLongPress) return;
                currentX = e.touches[0].clientX; 
                const diff = currentX - startX; 
                
                // SWIPE TO REPLY LOGIC
                if(diff > 0 && diff < 150) { 
                    wrapper.style.transform = `translateX(${diff}px)`; 
                    const icon = container.querySelector('.swipe-reply-icon');
                    if(icon) {
                        icon.style.opacity = diff > 60 ? '1' : (diff / 60);
                        icon.style.transform = `translateY(-50%) scale(${diff > 80 ? 1.2 : 1})`;
                    }
                }
            });

            container.addEventListener('touchend', (e) => {
                clearTimeout(longPressTimer);
                container.classList.remove('scale-active');
                
                if(isLongPress) {
                    e.preventDefault(); 
                    e.stopPropagation();
                    return false;
                }

                const diff = currentX - startX;
                wrapper.style.transition = 'transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)'; 
                wrapper.style.transform = 'translateX(0px)';
                
                const icon = container.querySelector('.swipe-reply-icon');
                if(icon) {
                    icon.style.opacity = '0';
                    icon.style.transform = 'translateY(-50%) scale(1)';
                }
                
                // CLICK / TAP SELECTION LOGIC
                if (isSelectionMode) {
                    // Only toggle if minimal movement (tap)
                    if (Math.abs(diff) < 10 && Math.abs(e.changedTouches[0].clientY - startY) < 10) {
                        e.preventDefault();
                        toggleSelection(msg);
                    }
                } else {
                    if (diff > 100 && !isAdminChat && !isChannelChat) {
                        if(navigator.vibrate) navigator.vibrate(20);
                        triggerReply(msg); 
                    }
                }
            });
            
            wrapper.addEventListener('dblclick', (e) => {
                e.preventDefault();
                addReaction(msg, '');
                showHeartAnimation(container);
                if(navigator.vibrate) navigator.vibrate(50);
            });
            
            wrapper.addEventListener('contextmenu', (e) => { e.preventDefault(); }); 
        }
        
        window.showReactionBar = (msg, wrapper) => {
             if(selectedMessages.length > 1) return;

             const popover = document.createElement('div');
             popover.className = 'reaction-popover';
             popover.id = `reaction-bar-${msg.key}`;
             
             // POSITION FIX: Get global coordinates of wrapper to place fixed popover correctly
             const rect = wrapper.getBoundingClientRect();
             const isMe = msg.uid === currentUser.uid;
             
             // Position 60px above the message bubble
             popover.style.top = (rect.top - 60) + 'px';
             
             // Position Right aligned for Me, Left for Others
             if (isMe) {
                 popover.style.right = '20px'; 
                 popover.style.left = 'auto';
             } else {
                 popover.style.left = '20px';
                 popover.style.right = 'auto';
             }

             const emojis = ['', '', '', '', '', ''];
             emojis.forEach(emo => {
                 const span = document.createElement('span');
                 span.innerText = emo;
                 span.className = 'rp-emoji';
                 span.onclick = (e) => {
                     e.stopPropagation();
                     addReaction(msg, emo);
                     popover.remove();
                     closeSelectionMode();
                 };
                 popover.appendChild(span);
             });
             
             document.body.appendChild(popover); // Append to Body for fixed positioning
             
             // Auto remove after 5s or click outside
             setTimeout(() => { if(popover.parentNode) popover.remove(); }, 5000);
        };

        window.showHeartAnimation = (container) => {
            const heart = document.createElement('div');
            heart.className = 'heart-animation';
            heart.innerHTML = '<i class="fa-solid fa-heart-pulse"></i>';
            container.appendChild(heart);
            setTimeout(() => heart.remove(), 1000);
        };
        
        window.setVoiceDuration = (audio, elId) => {
            const el = document.getElementById(elId);
            if(el && (el.innerText === '0:00' || !el.innerText)) {
                const dur = audio.duration;
                if(!isNaN(dur)) {
                    const m = Math.floor(dur / 60);
                    const s = Math.floor(dur % 60);
                    el.innerText = `${m}:${s<10?'0':''}${s}`;
                }
            }
        };

        window.toggleAudio = (id, btn, msgKey = null) => {
            const audio = document.getElementById(id);
            const icon = btn.querySelector('i');
            
            const player = btn.closest('.voice-player');
            if(player && player.classList.contains('unplayed')) {
                player.classList.remove('unplayed');
                if(msgKey && chatPath) {
                    update(ref(db, `${chatPath}/${msgKey}`), { audioPlayed: true });
                }
            }

            document.querySelectorAll('audio').forEach(a => { 
                if(a.id !== id) { a.pause(); a.currentTime = 0; resetVoiceBtn(a.id, a); } 
            });
            if(audio.paused) { audio.play(); icon.className = 'fa-solid fa-pause'; } 
            else { audio.pause(); icon.className = 'fa-solid fa-play'; }
        };

        window.updateWaveform = (id) => {
            const audio = document.getElementById(id);
            const container = document.getElementById(`wave-${id}`);
            const timeEl = document.getElementById(`vtime-${id}`);
            
            if(!audio || !container) return;
            const bars = container.querySelectorAll('.wave-bar'); 
            const dot = container.querySelector('.voice-progress-dot'); 
            
            const percent = audio.currentTime / audio.duration;
            const activeIndex = Math.floor(percent * bars.length);
            
            for (let i = 0; i < bars.length; i++) {
                if(i <= activeIndex) { bars[i].classList.add('played'); } 
                else { bars[i].classList.remove('played'); }
            }

            if(dot) {
                dot.style.display = 'block';
                const dotPos = percent * 100;
                dot.style.left = `${dotPos}%`;
            }
            
            if(timeEl) {
                const remaining = Math.ceil(audio.duration - audio.currentTime);
                if(!isNaN(remaining)) {
                    const m = Math.floor(remaining / 60);
                    const s = remaining % 60;
                    timeEl.innerText = `${m}:${s<10?'0':''}${s}`;
                }
            }
        };

        window.resetVoiceBtn = (id, audio) => {
            const btn = document.querySelector(`[onclick^="event.stopPropagation(); toggleAudio('${id}'"] i`);
            if(btn) btn.className = 'fa-solid fa-play';
            const container = document.getElementById(`wave-${id}`);
            if(container) { 
                Array.from(container.querySelectorAll('.wave-bar')).forEach(bar => bar.classList.remove('played')); 
                const dot = container.querySelector('.voice-progress-dot');
                if(dot) dot.style.display = 'none'; 
            }
            const timeEl = document.getElementById(`vtime-${id}`);
            if(timeEl && audio) {
                const dur = audio.duration;
                if(!isNaN(dur)) {
                    const m = Math.floor(dur / 60);
                    const s = Math.floor(dur % 60);
                    timeEl.innerText = `${m}:${s<10?'0':''}${s}`;
                }
            }
        };
        
        window.toggleSelection = (msg) => {
            const index = selectedMessages.findIndex(m => m.key === msg.key);
            if (index > -1) {
                selectedMessages.splice(index, 1);
                const bubble = document.getElementById(`bubble-${msg.key}`);
                if(bubble) {
                    bubble.classList.remove('selected-red');
                    const container = bubble.closest('.msg-container');
                    if(container) container.classList.remove('selected-bg-red');
                    const bar = document.getElementById(`reaction-bar-${msg.key}`);
                    if(bar) bar.remove();
                }
            } else {
                selectedMessages.push(msg);
                const bubble = document.getElementById(`bubble-${msg.key}`);
                if(bubble) {
                    bubble.classList.add('selected-red');
                    const container = bubble.closest('.msg-container');
                    if(container) container.classList.add('selected-bg-red');
                }
            }
            if (selectedMessages.length === 0) { closeSelectionMode(); } 
            else { enableSelectionMode(); }
        };

        function enableSelectionMode() {
            isSelectionMode = true;
            chatNavbar.style.display = 'none';
            chatSelectionBar.style.display = 'flex';
            selectionCountDisplay.innerText = selectedMessages.length;
            const delBtn = document.getElementById('selection-delete-btn');
            // Simplified check: if drag selecting, currentUser might be null in that context, check safely
            const hasMyMsg = selectedMessages.some(m => m.uid === currentUser.uid);
            delBtn.style.display = hasMyMsg ? 'flex' : 'none';
        }

        window.closeSelectionMode = () => {
            isSelectionMode = false;
            selectedMessages = [];
            chatNavbar.style.display = 'flex';
            chatSelectionBar.style.display = 'none';
            document.getElementById('sel-more-dropdown').style.display = 'none';
            document.querySelectorAll('.selected-red').forEach(el => el.classList.remove('selected-red'));
            document.querySelectorAll('.selected-bg-red').forEach(el => el.classList.remove('selected-bg-red'));
            document.querySelectorAll('.reaction-popover').forEach(el => el.remove());
        };

        window.showSelectionMoreOptions = () => {
            const dropdown = document.getElementById('sel-more-dropdown');
            if (dropdown.style.display === 'block') { dropdown.style.display = 'none'; } 
            else { dropdown.style.display = 'block'; }
        };

        window.handleDeleteMessage = () => {
            if(selectedMessages.length === 0) return;
            const myMsgs = selectedMessages.filter(m => m.uid === currentUser.uid);
            if(myMsgs.length === 0) return;

            const modalContainer = document.getElementById('delete-options-container');
            modalContainer.innerHTML = ''; 

            const btnMe = document.createElement('button');
            btnMe.className = 'delete-option-btn';
            btnMe.innerHTML = '<i class="fa-solid fa-trash"></i> Delete for Me';
            btnMe.onclick = () => performDeleteForMe();
            modalContainer.appendChild(btnMe);

            const btnEveryone = document.createElement('button');
            btnEveryone.className = 'delete-option-btn';
            btnEveryone.innerHTML = '<i class="fa-solid fa-users-slash"></i> Delete for Everyone';
            btnEveryone.onclick = () => performDeleteForEveryone();
            modalContainer.appendChild(btnEveryone);

            document.getElementById('delete-modal-overlay').style.display = 'flex';
        };

        window.performDeleteForMe = () => {
            selectedMessages.forEach(m => {
                update(ref(db, `${chatPath}/${m.key}/deletedBy`), { [currentUser.uid]: true });
            });
            document.getElementById('delete-modal-overlay').style.display = 'none';
            showToast("Deleted for you");
            closeSelectionMode();
        };

        window.performDeleteForEveryone = () => {
            const myMsgs = selectedMessages.filter(m => m.uid === currentUser.uid);
            myMsgs.forEach(m => { remove(ref(db, `${chatPath}/${m.key}`)); });
            document.getElementById('delete-modal-overlay').style.display = 'none';
            showToast("Deleted for everyone");
            closeSelectionMode();
        };

        window.copyMessage = () => { 
            if(selectedMessages.length > 0) {
                const textToCopy = selectedMessages.map(m => m.text).join('\n\n');
                navigator.clipboard.writeText(textToCopy); 
                showToast('Text Copied'); 
            } 
            closeSelectionMode(); 
        };
        
        window.handleForward = () => {
            if(selectedMessages.length === 0) return;
            forwardModal.style.display = 'flex';
            loadForwardContacts();
        };

        window.closeForwardModal = () => { 
            forwardModal.style.display = 'none'; 
            mainNav.classList.add('visible'); 
            closeSelectionMode();
        };

        function loadForwardContacts() {
            renderSkeleton('forward-list');
            onValue(ref(db, `user-contacts/${currentUser.uid}`), (snapshot) => {
                forwardList.innerHTML = '';
                const contacts = snapshot.val();
                if (!contacts) { forwardList.innerHTML = '<div style="padding:20px;text-align:center">No contacts</div>'; return; }
                Object.values(contacts).forEach(contact => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.onclick = () => forwardMessageTo(contact.uid);
                    div.innerHTML = `<div class="avatar"><i class="fa-solid fa-user-ninja"></i></div><div class="chat-info"><h3>${contact.name}</h3></div><i class="fa-solid fa-paper-plane text-red"></i>`;
                    forwardList.appendChild(div);
                });
            });
        }

        async function forwardMessageTo(targetUid) {
            const chatId = [currentUser.uid, targetUid].sort().join('_');
            const targetChatPath = `private-messages/${chatId}`;
            
            let initialStatus = 'sent';
            const statusSnap = await get(ref(db, `status/${targetUid}`));
            if(statusSnap.exists() && statusSnap.val().state === 'online') { initialStatus = 'delivered'; }

            for (const msg of selectedMessages) {
                const msgData = { 
                    text: msg.text, 
                    type: msg.type || 'text',
                    sender: currentUser.displayName, 
                    uid: currentUser.uid, 
                    timestamp: Date.now(), 
                    status: initialStatus 
                };
                if(msg.type === 'audio') {
                    msgData.audio = msg.audio;
                    msgData.duration = msg.duration;
                }
                if(msg.type === 'image') msgData.image = msg.image;
                if(msg.type === 'video') {
                    msgData.video = msg.video;
                    msgData.duration = msg.duration;
                    msgData.fileSize = msg.fileSize;
                }
                if(msg.type === 'document') {
                    msgData.docUrl = msg.docUrl;
                    msgData.fileName = msg.fileName;
                    msgData.fileSize = msg.fileSize;
                }
                await push(ref(db, targetChatPath), msgData);
            }
            forwardModal.style.display = 'none';
            showToast("Sent successfully");
            mainNav.classList.add('visible');
            closeSelectionMode();
        }

        function triggerReply(msg) { 
            replyingToMsg = msg; 
            document.getElementById('reply-to-name').innerText = msg.sender; 
            document.getElementById('reply-to-text').innerText = msg.text; 
            document.getElementById('reply-bar').classList.add('show'); 
            document.getElementById('msg-input').focus(); 
        }
        
        window.addReaction = (msg, emoji) => {
            if(msg && msg.key) { set(ref(db, `${chatPath}/${msg.key}/reactions/${currentUser.uid}`), emoji); }
        };

        window.toggleAttachmentMenu = () => {
            const menu = document.getElementById('attachment-menu');
            menu.classList.toggle('open');
            stickerPicker.classList.remove('open');
        };

        window.toggleSpeechMenu = () => {
            const menu = document.getElementById('speech-settings-menu');
            menu.classList.toggle('show');
        };

        window.toggleSpeechState = () => {
            speechEnabled = !speechEnabled;
            const statusText = document.getElementById('speech-status-text');
            const statusIcon = document.getElementById('speech-status-icon');
            
            if(speechEnabled) {
                statusText.innerText = "ON";
                statusText.classList.remove('status-off');
                statusText.classList.add('status-on');
                statusIcon.className = "fa-solid fa-toggle-on status-on";
                showToast("Speech ON");
            } else {
                statusText.innerText = "OFF";
                statusText.classList.remove('status-on');
                statusText.classList.add('status-off');
                statusIcon.className = "fa-solid fa-toggle-off";
                showToast("Speech OFF");
                window.speechSynthesis.cancel(); // Stop talking
            }
            setTimeout(() => {
                document.getElementById('speech-settings-menu').classList.remove('show');
            }, 300);
        };

        window.triggerGallery = () => {
            document.getElementById('photo-input').click();
            document.getElementById('attachment-menu').classList.remove('open');
        };

        document.addEventListener('click', (e) => {
            const menu = document.getElementById('attachment-menu');
            const stickerMenu = document.getElementById('sticker-picker');
            const paperClipBtn = document.querySelector('.photo-btn');
            const emojiBtn = document.querySelector('.emoji-btn');

            if (menu.classList.contains('open') && !menu.contains(e.target) && !paperClipBtn.contains(e.target)) {
                menu.classList.remove('open');
            }
            if (stickerMenu.classList.contains('open') && !stickerMenu.contains(e.target) && !emojiBtn.contains(e.target)) {
                stickerMenu.classList.remove('open');
            }

            const dropdown = document.getElementById('sel-more-dropdown');
            const menuBtn = document.querySelector('.fa-ellipsis-vertical');
            if (dropdown && dropdown.style.display === 'block' && e.target !== menuBtn && !menuBtn.parentElement.contains(e.target)) {
                dropdown.style.display = 'none';
            }
            const speechMenu = document.getElementById('speech-settings-menu');
            const speechBtn = document.querySelector('.admin-speech-btn');
            if(speechMenu && speechMenu.classList.contains('show') && !speechMenu.contains(e.target) && !speechBtn.contains(e.target)) {
                speechMenu.classList.remove('show');
            }
            // Close Popovers if clicked outside
            if (e.target.closest('.reaction-popover') === null) {
                document.querySelectorAll('.reaction-popover').forEach(el => el.remove());
            }
        });

    </script>
</body>
</html>